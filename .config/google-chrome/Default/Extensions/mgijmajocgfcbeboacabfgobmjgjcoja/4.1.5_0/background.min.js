/* Copyright 2011 Google Inc. All Rights Reserved. */ (function(){var k="\" ' ( ) , - . / 0 1 2 : ? a about and are as be but com for from have i in is it like may more my next not of on search that the this to was when with you your".split(" "),p=!1,q={},r={},t=0,u=-1,v=-1,w=function(a){a=a.replace(/<[^>]*>/g,"");return a=a.replace(/[<>]/g,"")},x=function(a){a=w(a);return a=a.substring(0,100).toLowerCase()},y=function(a){for(var c=0,b=k.length;c<b;c++)if(a===k[c])return!0;return!1},z=function(a,c,b){"initialize"===a.type&&b({instanceId:t++})},A=function(a){"openOptionsPage"===
a.type&&chrome.tabs.create({url:chrome.runtime.getURL("options.html")})},B=function(a,c,b){"options"===a.type&&b({options:q})},G=function(a,c,b){if("fetch_raw"!==a.type&&"fetch_html"!==a.type)return!1;_gaq&&_gaq.push(["_trackEvent","lookup",a.type]);-1!==u&&v!==a.instanceId&&chrome.tabs.sendMessage(u,{type:"hide",instanceId:v});"fetch_raw"===a.type?(u=c.tab.id,v=a.instanceId):v=u=-1;var d=x(a.query),f=function(){var e={request:a,sanitizedQuery:d,dictRes:null,enDictRes:null,tranRes:null,tabLangTranRes:null,
tabLangTranReqTimedOut:!1,tabLang:null,numResponses:0,callback:b,incognito:!1};D(d,q.language,function(m){e.dictRes=m;E(e)});"en"!==q.language?D(d,"en",function(m){e.enDictRes=m;E(e)}):E(e);F(d,"auto",function(m){e.tranRes=m;E(e)});chrome.tabs.getSelected(null,function(m){e.incognito=m.incognito;var g=window.setTimeout(function(){console.assert(null===e.tabLangTranRes);e.tabLangTranReqTimedOut=!0;E(e)},800);chrome.tabs.detectLanguage(m.id,function(h){e.tabLangTranReqTimedOut||(window.clearTimeout(g),
"und"!==h?(e.tabLang="he"===h?"iw":h,F(d,e.tabLang,function(n){e.tabLangTranRes=n;E(e)})):E(e))})})};if(p)f();else{var l=function(e){if(p)return f();if(10<e)return b({eventKey:a.eventKey,sanitizedQuery:d});window.setTimeout(function(){l(e+1)},200)};l(0)}return!0},D=function(a,c,b){var d=c;"en-uk"==c&&(d="en");var f=window["gdx.LANG_TO_CORPUS"][c];f||(f=c);a={path:"v1/dictionaryExtensionData",params:{term:a,language:d,corpus:f}};(f=window["gdx.CORPUS_TO_COUNTRY"][f])&&(a.params.country=f);gapi.client.request(a).execute(function(l){var e=
l.status;if(e&&200!=e)b(null);else{l=H(l,"dictionaryData[0]");if(!l)return b(null);var m=function(g){if(!g.senseFamilies)return 0;g=g.senseFamilies;for(var h=g.length,n=0;n<g.length;n++)g[n].senses&&(h+=.1*g[n].senses.length);return h};e=function(g,h){return m(h)-m(g)};l.entries&&(l.entries=l.entries.sort(e));l.webDefinitions&&(l.hasWebDefinitions=!0);b(l)}})},F=function(a,c,b){a="https://clients5.google.com/translate_a/t?client=dict-chrome-ex&sl="+c+"&tl="+q.language+"&q="+encodeURIComponent(a);
var d=new XMLHttpRequest;d.open("GET",a,!0);d.onload=function(){var f=null;if(200===this.status)try{f=JSON.parse(d.response)}catch(l){}return b(f)};d.send()},E=function(a){a.numResponses++;if(4===a.numResponses){var c=I(a.dictRes),b=c;"en"!==q.language&&(b=I(a.enDictRes));var d=J(a.tranRes,!0),f=J(a.tabLangTranRes,!0),l=q.language.toLowerCase(),e=!1,m=null,g=null;f&&a.tabLang!==l?(e=!0,m=a.tabLangTranRes,g=f):!c&&d&&(e=!0,m=a.tranRes,g=d);e&&b&&b.audio&&"en"===g.srcLang.toLowerCase()&&(g.audio=b.audio);
b=e?"translation":"definition";c||g||(b="none");_gaq&&_gaq.push(["_trackEvent","lookup","type_"+b]);d=encodeURIComponent(a.sanitizedQuery);b="";e&&(b="https://translate.google.com/translate_t?source=dict-chrome-ex&sl="+g.srcLang+"&tl="+q.language+"&q="+d);d=K(d);if("fetch_html"===a.request.type)c="",c=e?L(m,g.audio,b):M(a.dictRes,d),e={eventKey:a.request.eventKey,sanitizedQuery:a.sanitizedQuery,html:c};else{var h=null,n=null;e?(h=g,h.moreUrl=b):c&&(h=c,h.moreUrl=d,h.srcLang=q.language);h&&"true"===
q.storeHistory&&!a.incognito&&chrome.storage.local.get("word-history",function(C){n=h.srcLang+"<"+q.language+"<"+a.sanitizedQuery;C["word-history"][n]=h.meaningText;chrome.storage.local.set(C)});h&&!h.prettyQuery&&(h.prettyQuery=a.sanitizedQuery);e=!1;("true"===q.popupDblclick&&"none"===q.popupDblclickKey||"true"===q.popupSelect&&"none"===q.popupSelectKey)&&y(a.sanitizedQuery)&&(e=!0);e={eventKey:a.request.eventKey,sanitizedQuery:a.sanitizedQuery,meaningObj:h,showOptionsTip:e}}a.callback(e)}},K=function(a){var c=
q.language;var b=(b=window["gdx.LANG_TO_DEFINE"][c])?b.replace("${term}",a):"";var d=window["gdx.LANG_TO_CORPUS"][q.language];d||(d=q.language);a="https://www.google.com/search?dictcorpus="+d+"&hl="+c+"&forcedict="+a+"&q="+b;"en-uk"===c&&(a+="&gl=gb");return a},J=function(a,c){if(!a||a.sentences[0].orig.toLowerCase()==a.sentences[0].trans.toLowerCase())return null;var b=a.sentences[0].orig.toLowerCase();var d=a.sentences[0].trans.toLowerCase(),f=d;if(c&&a.dict&&0<a.dict.length){c=0;for(var l=a.dict.length;c<
l;c++)for(var e=a.dict[c],m=0,g=0,h=e.terms.length;g<h&&2>m;g++){var n=e.terms[g].toLowerCase();0<n.length&&n!==b&&n!==d&&(f+=", "+n,m++)}}b=w(f);(d=window["gdx.LANG_TO_NAME"][a.src.toLowerCase()])||(d=a.src);return{type:"translation",meaningText:b,attribution:"Translated from "+d,srcLang:a.src}},H=function(a,c){c=c.split(".");for(var b=0;b<c.length;b++){var d=c[b];console.assert(d);if("]"===d.charAt(d.length-1)){d=d.split("[");console.assert(2===d.length);var f=parseInt(d[1].slice(0,-1),10);a=a[d[0]];
if(!a)return null;a=a[f]}else a=a[d];if(!a)return null}return a},N=function(a){return"//"===a.substr(0,2)?"https:"+a:a},I=function(a){if(!a||a.error)return null;var c,b=null;if(c=H(a,"entries[0]"))b={prettyQuery:c.syllabifiedHeadword||c.headword,meaningText:H(c,"senseFamilies[0].senses[0].definition.text"),attribution:"",audio:H(c,"phonetics[0].oxfordAudio"),type:"licensedDef"},b.meaningText?b.audio&&(b.audio=N(b.audio)):b=null;!b&&(c=H(a,"webDefinitions[0]"))&&(b=c.sourceUrl,b={meaningText:c.definition,
attribution:'<a href="'+b+'">'+b+"</a>",type:"webDef"});if(!b)return null;c=b.meaningText;b.meaningText=c.charAt(0).toUpperCase()+c.slice(1);return b},L=function(a,c,b){var d=J(a,!1);if(!d)return"";c&&(d.audio=c);a.tranResSummary=d;a.moreUrl=b;a.hasDict=!!a.dict&&a.dict.length;return r.browser_action_tran(a)},M=function(a,c){if(!a||a.error)return"";a.moreUrl=c;a.makeAudioUrl=function(){var d=this.oxfordAudio;return d?N(d):""};var b={};a.showOnlyOnce=function(){return function(d,f){d=f(d);if(b[d])return"";
b[d]=!0;return d}};return r.browser_action_dict(a)},O=function(a){var c={};c.language=a.language||"en";var b=function(f,l){var e=a[f];c[f]=l;"true"===e||"false"===e?c[f]=e:"boolean"===typeof e&&(c[f]=String(e))},d=function(f,l){c[f]=a[f]||l};b("popupDblclick","true");b("popupSelect","false");b("enableHttps","true");d("popupDblclickKey","none");d("popupSelectKey","ctrl");b("storeHistory","false");b("allowCrossExtensionHistory","false");"pt"===a.language&&(c.language="pt-BR");return c},P=function(a,
c,b){if("false"===q.allowCrossExtensionHistory||"false"===q.storeHistory||!a||!a.getHistory)return!1;chrome.storage.local.get("word-history",function(d){b(d["word-history"])});return!0},Q=function(a,c){var b=new XMLHttpRequest;b.open("GET",a,!0);b.onload=function(){var d=null;200===this.status&&(d=b.response);return c(d)};b.send()},R=function(){var a=window.localStorage.options,c={};a&&(c=JSON.parse(a));q=O(c);window.localStorage.options=JSON.stringify(q);chrome.storage.local.get("word-history",function(b){b["word-history"]||
chrome.storage.local.set({"word-history":{}})});chrome.runtime.onMessage.addListener(z);chrome.runtime.onMessage.addListener(A);chrome.runtime.onMessage.addListener(B);chrome.runtime.onMessage.addListener(G);chrome.runtime.onMessageExternal.addListener(P)};window["gdx.updateOptions"]=function(){q=JSON.parse(window.localStorage.options)};
window.initBackgroundPageAsync=function(a){gapi.config.update("googleapis.config/root","https://dictionaryextension-pa.googleapis.com");gapi.client.setApiKey("AIzaSyA6EEtrDCfBkHV8uU2lgGY-N383ZgAOo7Y");var c=function(){2>Object.keys(r).length||(p=!0,a&&a())},b=function(d){Mustache.parse(d);return function(f){return Mustache.render(d,f)}};Q("templates/browser_action_dict.html",function(d){r.browser_action_dict=b(d);c()});Q("templates/browser_action_tran.html",function(d){r.browser_action_tran=b(d);
c()})};window.initBackgroundPage=R;var S=S||!1;S||R();})();
