/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class Highlighter{constructor(t,e,i=t,s,n){this._highlightingAreas=[],this._width=0,this._height=0,this._currentZIndex="auto",this._inputArea=t,this._inputAreaWrapper=e,this._ceElement=i,this._isMirror=s,this._tweaks=n,this._appearance=n.getHighlighterAppearance(t),this._highlightedText="",this._highlightedBlocks=[],this._domMeasurement=new DomMeasurement(t.ownerDocument),this._onInputAreaScroll=bindAndCatch(this._onInputAreaScroll,this),this._onCEElementClick=bindAndCatch(this._onCEElementClick,this),this._onContentChanged=bindAndCatch(this._onContentChanged,this),this._render=bindAndCatch(this._render,this),this._inputArea.addEventListener("scroll",this._onInputAreaScroll),this._ceElement.addEventListener(this._tweaks.getClickEvent(),this._onCEElementClick,!0),this._ceElement.addEventListener(Mirror.eventNames.click,this._onCEElementClick),this._isDraftJsIssue=Boolean(this._ceElement.firstElementChild&&this._ceElement.firstElementChild.hasAttribute("data-contents")),this._isSharepointIssue=this._ceElement.classList.contains("ms-rtestate-write"),this._isQuillJsIssue=Boolean(this._ceElement.classList.contains("ql-editor")&&this._ceElement.closest(".ql-editor")),this._isAmoCRMIssue=Boolean(this._ceElement.classList.contains("control-contenteditable__area")&&this._ceElement.closest(".js-control-contenteditable, .js-control-contenteditable-amojo")),this._isNextcloudTalkIssue=Boolean(this._ceElement.closest(".app-Talk, .app-talk")),this._contentChangedObserver=new MutationObserver(this._onContentChanged);const o={attributes:!0,attributeFilter:s?["style"]:["style","class","size","face","align"],attributeOldValue:!1,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!s};this._contentChangedObserver.observe(this._ceElement,o),window.ResizeObserver&&(this._ceElementResizeObserver=new window.ResizeObserver(this._render),this._ceElementResizeObserver.observe(this._ceElement)),this._renderInterval=setAnimationFrameInterval(this._render,config.RENDER_INTERVAL),this._render()}_toPageCoordinates(t,e){const i=this._domMeasurement.getPaddingBox(e),s=this._getCEElementScroll(!1),n=this._domMeasurement.getScaleXFactor(e),o=this._domMeasurement.getScaleYFactor(e),h=this._domMeasurement.getZoom(e),r=Math.round((t.top-s.top)*o*h+i.top),l=Math.round((t.left-s.left)*n*h+i.left),a=Math.round(t.width*n*h),c=Math.round(t.height*o*h);return{top:r,right:l+a,bottom:r+c,left:l,width:a,height:c}}_toElementCoordinates(t,e){const i=this._domMeasurement.getPaddingBox(e,!1),s=this._getCEElementScroll(),n=this._domMeasurement.getScaleXFactor(e),o=this._domMeasurement.getScaleYFactor(e),h=this._domMeasurement.getZoom(e);return{x:Math.round((t.x-i.left+s.left)/n/h),y:Math.round((t.y-i.top+s.top)/o/h)}}_getCEElementScroll(t=!0,e=t,i=!0){if(this._isMirror){let i=0,s=0;return t?(i=e?+this._ceElement.dataset.ltScrollTopScaledAndZoomed:+this._ceElement.dataset.ltScrollTopScaled,s=e?+this._ceElement.dataset.ltScrollLeftScaledAndZoomed:+this._ceElement.dataset.ltScrollLeftScaled):(i=+this._ceElement.dataset.ltScrollTop,s=+this._ceElement.dataset.ltScrollLeft),{top:i,left:s}}return i&&this._domMeasurement.clearCache(),this._domMeasurement.getScrollPosition(this._ceElement,t,e)}_getTargetElement(){return this._isMirror?this._ceElement:this._isDraftJsIssue&&this._ceElement.parentNode&&this._ceElement.parentNode.parentNode?this._ceElement.parentNode:this._isSharepointIssue?this._ceElement.closest("table[id*=WikiField]")||this._ceElement:this._isQuillJsIssue?this._ceElement.closest(".ql-container")||this._ceElement:this._isAmoCRMIssue?this._ceElement.closest(".js-control-contenteditable, .js-control-contenteditable-amojo")||this._ceElement:this._isNextcloudTalkIssue&&this._ceElement.closest(".new-message-form")?this._ceElement.parentElement:this._ceElement}_render(){if(!this._ceElement.parentElement||!this._inputArea.parentElement)return;this._domMeasurement.clearCache();const t=this._inputArea.ownerDocument,e=this._getTargetElement();if(!e.parentElement)return;if(!this._container){this._container=t.createElement(Highlighter.CONTAINER_ELEMENT_NAME),this._container.style.display="none",this._container.setAttribute("contenteditable","false"),this._wrapper=t.createElement("lt-div"),this._wrapper.setAttribute("spellcheck","false"),this._wrapper.className="lt-highlighter__wrapper",this._scrollElement=t.createElement("lt-div"),this._scrollElement.className="lt-highlighter__scrollElement",this._wrapper.appendChild(this._scrollElement),this._container.appendChild(this._wrapper);const i=this._domMeasurement.getStyle(e.parentElement,"display");"grid"!==i&&"inline-grid"!==i||this._container.classList.add("lt-highlighter--grid-item")}const i={};if(this._inputArea===t.body&&t.scrollingElement===t.documentElement&&"BackCompat"!==t.compatMode){const t=this._domMeasurement.getStyles(this._inputArea,["overflow-x","overflow-y"]);i["overflow-x"]="hidden"===t["overflow-x"]?"hidden":"visible",i["overflow-y"]="hidden"===t["overflow-y"]?"hidden":"visible"}const s=this._domMeasurement.getPaddingBox(this._ceElement,!0,!1);i.width=s.width+"px",i.height=s.height+"px";const n=this._domMeasurement.getStyles(this._ceElement,["transform","transform-origin","zoom"]);i.transform=n.transform,i["transform-origin"]=n["transform-origin"],i.zoom=n.zoom,this._domMeasurement.setStyles(this._wrapper,i,!0);const o=this._isMirror?this._inputArea:e,h=this._appearance.getZIndex(o,this._domMeasurement);h!==this._currentZIndex&&("auto"!==h&&h>0?(this._currentZIndex=h,this._domMeasurement.setStyles(this._container,{"z-index":String(h)},!0)):"auto"!==this._currentZIndex&&(this._currentZIndex="auto",this._domMeasurement.setStyles(this._container,{"z-index":"auto"},!0))),this._applyScrolling(),e.previousElementSibling!==this._container&&e.parentElement.insertBefore(this._container,e);const r=this._domMeasurement.getPaddingBox(this._wrapper,!0,!1),l=s.top-r.top;if(Math.abs(l)>.05){const t=this._domMeasurement.getScaleYFactor(this._inputArea.parentElement);let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-top"));e+=l/t,this._domMeasurement.setStyles(this._wrapper,{"margin-top":e+"px"},!0)}const a=s.left-r.left;if(Math.abs(a)>.05){const t=this._domMeasurement.getScaleXFactor(this._inputArea.parentElement);let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-left"));e+=a/t,this._domMeasurement.setStyles(this._wrapper,{"margin-left":e+"px"},!0)}const c=this._domMeasurement.getScrollDimensions(this._inputArea,!1);this._width===c.width&&this._height===c.height||(this._width=c.width,this._height=c.height,this._domMeasurement.setStyles(this._scrollElement,{width:this._width+"px",height:this._height+"px"},!0),this._updateHighlightedAreas(),this._redraw(!1))}_updateHighlightedAreas(){const t=[];for(let e=0;e<this._width;e+=Highlighter.CANVAS_MAX_WIDTH)for(let i=0;i<this._height;i+=Highlighter.CANVAS_MAX_HEIGHT){const s={top:i,right:e+Highlighter.CANVAS_MAX_WIDTH,bottom:i+Highlighter.CANVAS_MAX_HEIGHT,left:e,width:Highlighter.CANVAS_MAX_WIDTH,height:Highlighter.CANVAS_MAX_HEIGHT};let n=this._highlightingAreas.find(t=>isRectsEqual(t.cell,s));if(!n){const t=this._inputArea.ownerDocument.createElement("canvas");t.className="lt-highlighter__canvas",t.width=0,t.height=0,this._domMeasurement.setStyles(t,{display:"none"}),n={cell:s,canvas:t,context:t.getContext("2d"),drawnItems:{}}}t.push(n)}for(const e of this._highlightingAreas)!t.includes(e)&&e.canvas.parentElement&&this._scrollElement.removeChild(e.canvas);this._highlightingAreas=t}_redraw(t=!0){if(t&&this._domMeasurement.clearCache(),!this._highlightingAreas.length)return;this._highlightedText=this._inputAreaWrapper.getText();const e=this._getCEElementScroll(!0,!1,!1),i=this._domMeasurement.getScrollDimensions(this._inputArea,!1);for(const t of this._highlightedBlocks)t.textRanges=this._inputAreaWrapper.getTextRanges(t.offset,t.length),t.textBoxes=this._domMeasurement.getRelativeTextBoundingBoxes(t.textRanges,this._ceElement,e),t.textBoxes.forEach(t=>{const e=t.width<10?3:1;t.left=Math.max(0,t.left-e),t.right=Math.min(i.width,t.right+e),t.width=t.right-t.left,t.top=Math.max(0,t.top),t.bottom=Math.min(i.height,t.bottom),t.width=t.bottom-t.top});const s=[];for(const t of this._highlightedBlocks)for(const e of t.textBoxes){if(t.simulateSelection&&s.push({top:e.bottom-Highlighter.LINE_WIDTH/2,right:e.right,bottom:e.bottom+Highlighter.LINE_WIDTH/2,left:e.left,width:e.width,height:Highlighter.LINE_WIDTH,color:t.underlineColor,textBox:e}),t.isEmphasized){const i=e.bottom-Highlighter.LINE_WIDTH/2;s.push({top:e.top,right:e.right,bottom:i,left:e.left,width:e.width,height:i-e.top,color:t.backgroundColor,textBox:e})}if(t.isUnderlined){let n=e.bottom-Highlighter.LINE_WIDTH/2,o=e.bottom+Highlighter.LINE_WIDTH/2;o>i.height&&(n-=1,o-=1),s.push({top:n,right:e.right,bottom:o,left:e.left,width:e.width,height:Highlighter.LINE_WIDTH,color:t.underlineColor,textBox:e})}}for(const t of this._highlightingAreas){const e=s.filter(isRectsIntersect.bind(null,t.cell));if(!e.length){delete t.canvasBox,t.drawnItems={},t.canvas.parentElement&&this._scrollElement.removeChild(t.canvas);continue}let i={top:Number.MAX_VALUE,right:0,bottom:0,left:Number.MAX_VALUE,width:0,height:0};for(const t of e)i.top=Math.min(i.top,t.top,t.textBox.top),i.right=Math.max(i.right,t.right,t.textBox.right),i.bottom=Math.max(i.bottom,t.bottom,t.textBox.bottom),i.left=Math.min(i.left,t.left,t.textBox.left);i.width=i.right-i.left,i.height=i.bottom-i.top;const n=!t.canvasBox||t.canvasBox.width<i.width||t.canvasBox.height<i.height||t.canvasBox.width*t.canvasBox.height/(i.width*i.height)>=2,o=!n&&!isRectContainsRect(t.canvasBox,i);if(n){const e=!t.canvasBox||t.canvasBox.top!==i.top||t.canvasBox.left!==i.left;t.canvas.width=i.width,t.canvas.height=i.height,t.canvasBox=i,t.drawnItems={},e&&this._domMeasurement.setStyles(t.canvas,{top:t.canvasBox.top+"px",left:t.canvasBox.left+"px"},!0),t.canvas.parentElement||this._scrollElement.appendChild(t.canvas)}else o&&(t.canvasBox.top=i.top,t.canvasBox.right=i.left+t.canvasBox.width,t.canvasBox.bottom=i.top+t.canvasBox.height,t.canvasBox.left=i.left,this._domMeasurement.setStyles(t.canvas,{top:t.canvasBox.top+"px",left:t.canvasBox.left+"px"},!0));let h={};for(const i of e){const e=Math.max(i.left-t.canvasBox.left,0),s=Math.min(i.right-t.canvasBox.left,t.canvasBox.width),n=Math.max(i.top-t.canvasBox.top,0),o={x:e,y:n,w:s-e,h:Math.min(i.bottom-t.canvasBox.top,t.canvasBox.height)-n,c:i.color};h[JSON.stringify(o)]=o}let r={},l=!1;for(const e in h)t.drawnItems[e]?delete t.drawnItems[e]:(r[e]=h[e],l=!0);let a=t.drawnItems;const c=Object.values(a).length;if(c>0&&(l=!0),c>20&&(t.canvas.width=t.canvasBox.width,r=h,a={},l=!0),t.drawnItems=h,l){for(const e in a){const i=a[e];t.context.clearRect(i.x,i.y,i.w,i.h);const s={left:i.x,top:i.y,right:i.x+i.w,bottom:i.y+i.h};for(const t in h){isRectsIntersect(s,{left:h[t].x,top:h[t].y,right:h[t].x+h[t].w,bottom:h[t].y+h[t].h})&&(r[t]=h[t])}}for(const e in r){const i=r[e];t.context.fillStyle=i.c,t.context.fillRect(i.x,i.y,i.w,i.h)}}}}_applyScrolling(){const t=this._getCEElementScroll(!1),e=-t.top+"px",i=-t.left+"px";this._domMeasurement.setStyles(this._scrollElement,{top:e,left:i},!0)}_onInputAreaScroll(){this._container&&window.requestAnimationFrame(()=>{this._applyScrolling()})}_onCEElementClick(t){const e=0===t.button;if("click"!==t.type&&!e)return;if(t.detail===GoogleDocs.MOUSE_EVENT_DETAIL)return;if(this._isMirror&&t.stopImmediatePropagation(),!this._container)return;this._domMeasurement.clearCache();let i={x:t.clientX,y:t.clientY};i=this._toElementCoordinates(i,this._ceElement);for(const t of this._highlightedBlocks){if(!t.textBoxes)continue;const e=t.textBoxes.find(t=>isPointInsideRect(t,i));if(e){const i={highlighter:this,blockId:t.id,clickedBox:this._toPageCoordinates(e,this._ceElement)};return void dispatchCustomEvent(document,Highlighter.eventNames.blockClicked,i)}}}_onContentChanged(t){if(!this._container)return;const e=this._inputAreaWrapper.getText(),i=t.some(t=>{if("attributes"===t.type)return!0;if(this._isMirror)return!1;return!!Array.from(t.addedNodes||[]).some(t=>t.nodeType===document.ELEMENT_NODE)||!!Array.from(t.removedNodes||[]).some(t=>t.nodeType===document.ELEMENT_NODE)});(this._highlightedText!==e||i)&&this._redraw()}highlight(t=[]){this._highlightedBlocks=t,this._redraw()}getTextBoxes(t){const e=this._highlightedBlocks.find(e=>e.id===t);return e?(e.textBoxes||[]).map(t=>this._toPageCoordinates(t,this._ceElement)):[]}destroy(){this._inputArea.removeEventListener("scroll",this._onInputAreaScroll),this._ceElement.removeEventListener(this._tweaks.getClickEvent(),this._onCEElementClick,!0),this._ceElement.removeEventListener(Mirror.eventNames.click,this._onCEElementClick),this._contentChangedObserver.disconnect(),this._renderInterval&&this._renderInterval.destroy(),this._container&&this._container.remove(),this._ceElementResizeObserver&&this._ceElementResizeObserver.disconnect(),this._domMeasurement.clearCache()}}Highlighter.CONTAINER_ELEMENT_NAME="lt-highlighter",Highlighter.CANVAS_MAX_WIDTH=1024,Highlighter.CANVAS_MAX_HEIGHT=1024,Highlighter.LINE_WIDTH=2,Highlighter.eventNames={blockClicked:"lt-highlighter.blockClicked"};