/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __decorate=this&&this.__decorate||function(e,t,n,s){var r,i=arguments.length,a=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i<3?r(a):i>3?r(t,n,a):r(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a};class CEElementInspector{constructor(e,t,n=!0){if(this._ceElement=e,this._parsingDetector=t,this._nodePropertiesCache=new Map,n){this._onCEElementChange=this._onCEElementChange.bind(this),this._ceElementObserver=new MutationObserver(this._onCEElementChange);const e={attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!0};this._ceElementObserver.observe(this._ceElement,e)}}static _replaceLineBreaks(e){return e.replace(CEElementInspector.LINE_BREAKS_REGEXP," ")}static _isBlankString(e){return!e.trim()}static cached(e){return CEElementInspector._cacheInvalidationRules.push(e),function(t,n,s){const r=s.value;return s.value=function(t){const n=this._getCacheForNode(t);return null===n[e.key]&&(n[e.key]=r.call(this,t)),n[e.key]},s}}_getCacheForNode(e){let t=this._nodePropertiesCache.get(e);return t||(t={computedStyle:null,isSkippingElement:null,isBlock:null,isBr:null,isElementNode:null,parsingOptions:null,parsedText:null,blockParent:null,isLastTextInParagraph:null,isParagraphEndsWithLineBreak:null,isParagraphNonEmpty:null},this._nodePropertiesCache.set(e,t)),t}_deleteCacheForNode(e,t=!0){if(this._nodePropertiesCache.delete(e),t){const t=new DOMWalker(e);for(;t.node();)this._nodePropertiesCache.delete(t.node()),t.next()}}_normalizeMutations(e){const t={};e.forEach(e=>{"attributes"===e.type&&e.attributeName&&(t[e.attributeName]=t[e.attributeName]||[],t[e.attributeName].push(e))});for(const n in t)if(t.hasOwnProperty(n)){const s=t[n];if(s.length<2)continue;const r=s[0];r.oldValue===r.target.getAttribute(n)&&s.forEach(t=>{e.splice(e.indexOf(t),1)})}}_checkRuleConditions(e,t){if(!e)return!1;switch(t.type){case"attributes":return!!e.attributes&&(0===e.attributes.length||e.attributes.includes(t.attributeName));case"characterData":return!!e.characterData;case"childList":return!!e.childList}return!1}_onCEElementChange(e){this._normalizeMutations(e);for(const t of e){const e=t.target;if(!this._ceElement.contains(e)){this._deleteCacheForNode(e);continue}"childList"===t.type&&(t.addedNodes.forEach(e=>this._deleteCacheForNode(e)),t.removedNodes.forEach(e=>this._deleteCacheForNode(e)));const n=this.getBlockParent(e),s=e!==n;for(const r of CEElementInspector._cacheInvalidationRules){if(this._checkRuleConditions(r.self,t)){const t=this._nodePropertiesCache.get(e);t&&(t[r.key]=null)}if(this._checkRuleConditions(r.parent,t)){const t=new DOMWalker(e);for(;t.next();){const e=this._nodePropertiesCache.get(t.node());e&&(e[r.key]=null)}}if(this._checkRuleConditions(r.blockChild,t)&&s){const e=this._nodePropertiesCache.get(n);e&&(e[r.key]=null)}if(this._checkRuleConditions(r.blockSibling,t)){const e=new DOMWalker(n);for(;e.next();){const t=this._nodePropertiesCache.get(e.node());t&&(t[r.key]=null)}}if(this._checkRuleConditions(r.any,t))for(const[e,t]of this._nodePropertiesCache)t[r.key]=null}}}getComputedStyle(e){return window.getComputedStyle(e)}isSkippingElement(e){return this._ceElement!==e&&(this._parsingDetector.isIgnored(e)||this._parsingDetector.isQuote(e)||this._parsingDetector.isSignature(e))}isElementNode(e){return isElementNode(e)}isBlock(e){return!!this.isElementNode(e)&&this._parsingDetector.isBlock(e,this.getComputedStyle(e))}isBr(e){return"BR"===e.tagName}getParsingOptions(e){const t=isElementNode(e)?e:e.parentNode,n=this.getComputedStyle(t).whiteSpace;return{element:t,preserveLineBreaks:CEElementInspector.PRESERVE_LINEBREAKS_VALUES.includes(n||""),preserveWhitespaces:CEElementInspector.PRESERVE_WHITESPACES_VALUES.includes(n||"")}}getParsedText(e){const t=this.getParsingOptions(e);let n=e.nodeValue;return t.preserveLineBreaks||(n=CEElementInspector._replaceLineBreaks(n)),n=this._parsingDetector.replaceText(n,e,t.element)}getBlockParent(e){let t=isElementNode(e)?e:e.parentElement;for(;t!==this._ceElement&&!this.isBlock(t);)t=t.parentElement;return t}isLastTextInParagraph(e){const t=this.getBlockParent(e),n=new DOMWalker(t,e);for(n.next();n.node();){const e=n.node();if(this.isElementNode(e))if(this.isSkippingElement(e))n.next(!0);else{if(this.isBr(e))return!0;if(this.isBlock(e))return!0;n.next()}else if(isTextNode(e)){if(this.getParsedText(e))return!1;n.next()}else n.next()}return!0}isParagraphEndsWithLineBreak(e){const t=this.getBlockParent(e),n=new DOMWalker(this._ceElement,e);for(;n.node();){const e=n.node();if(this.isElementNode(e))if(this.isSkippingElement(e))n.next(!0);else{if(this.isBr(e))return!0;if(this.isBlock(e)&&this.isParagraphNonEmpty(e))return!0;n.next()}else if(isTextNode(e)){if(!contains(t,e)){const t=this.getParsingOptions(e),n=this.getParsedText(e);if(t.preserveWhitespaces&&n||!CEElementInspector._isBlankString(n))return!0}n.next()}else n.next()}return!1}isParagraphNonEmpty(e){const t=new DOMWalker(e);for(t.next();t.node();){const e=t.node();if(this.isElementNode(e))if(this.isSkippingElement(e))t.next(!0);else{if(this.isBr(e))return!1;if(this.isBlock(e))return!1;t.next()}else if(isTextNode(e)){const n=this.getParsingOptions(e),s=this.getParsedText(e);if(n.preserveWhitespaces&&s||!CEElementInspector._isBlankString(s))return!0;t.next()}else t.next()}return!1}destroy(){this._ceElementObserver&&this._ceElementObserver.disconnect(),this._nodePropertiesCache.clear()}}CEElementInspector.DISPLAY_BLOCK_VALUES=["block","list-item","table","table-caption","table-row","table-cell","flex","grid"],CEElementInspector.SKIPPING_TAGS=["CODE","NOSCRIPT","OBJECT","SCRIPT","STYLE","TEMPLATE","VAR","CANVAS","IMG","SVG","BLOCKQUOTE"],CEElementInspector.SUP_REGEXP=/^[\[\(]?\d+[\]\)]?/,CEElementInspector.PRESERVE_LINEBREAKS_VALUES=["pre","pre-wrap","pre-line"],CEElementInspector.PRESERVE_WHITESPACES_VALUES=["pre","pre-wrap"],CEElementInspector._cacheInvalidationRules=[],CEElementInspector.LINE_BREAKS_REGEXP=/\n/g,__decorate([CEElementInspector.cached({key:"computedStyle",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getComputedStyle",null),__decorate([CEElementInspector.cached({key:"isSkippingElement",any:{attributes:[],childList:!0}})],CEElementInspector.prototype,"isSkippingElement",null),__decorate([CEElementInspector.cached({key:"isElementNode"})],CEElementInspector.prototype,"isElementNode",null),__decorate([CEElementInspector.cached({key:"isBlock",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"isBlock",null),__decorate([CEElementInspector.cached({key:"isBr"})],CEElementInspector.prototype,"isBr",null),__decorate([CEElementInspector.cached({key:"parsingOptions",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getParsingOptions",null),__decorate([CEElementInspector.cached({key:"parsedText",self:{characterData:!0},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getParsedText",null),__decorate([CEElementInspector.cached({key:"blockParent",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getBlockParent",null),__decorate([CEElementInspector.cached({key:"isLastTextInParagraph",parent:{attributes:[]},blockSibling:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isLastTextInParagraph",null),__decorate([CEElementInspector.cached({key:"isParagraphEndsWithLineBreak",any:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isParagraphEndsWithLineBreak",null),__decorate([CEElementInspector.cached({key:"isParagraphNonEmpty",parent:{attributes:["id","class","style"]},blockChild:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isParagraphNonEmpty",null);