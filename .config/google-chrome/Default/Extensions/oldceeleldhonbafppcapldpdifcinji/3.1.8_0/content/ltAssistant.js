/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(o,n){function a(e){try{d(i.next(e))}catch(e){n(e)}}function s(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}d((i=i.apply(e,t||[])).next())})};class LTAssistant{constructor(e={},t=TweaksManager.getDefaultTweaks()){this._spellcheckingAttributesData=new Map,this._editors=[],this._checkExtensionHealthIntervalId=void 0,this._fixTinyMCEIntervalId=void 0,this._initElementTimeouts=new Map,!BrowserDetector.isUnsupportedBrowser()&&document.documentElement&&"HTML"===document.documentElement.nodeName&&(this._options=Object.assign({},e),"string"==typeof this._options.localeCode&&i18nManager.setLocale(this._options.localeCode),this._tweaks=t,this._tweaks.init(),this._isConnected=!0,this._checkExtensionHealth=bindAndCatch(this._checkExtensionHealth,this),this.destroy=bindAndCatch(this.destroy,this),this._onPageHide=bindAndCatch(this._onPageHide,this),this._onPageLoaded=bindAndCatch(this._onPageLoaded,this),this._onDocumentFocus=bindAndCatch(this._onDocumentFocus,this),this._onDocumentMousemove=bindAndCatch(this._onDocumentMousemove,this),this._onDocumentFocusout=bindAndCatch(this._onDocumentFocusout,this),this._onDocumentClick=bindAndCatch(this._onDocumentClick,this),this._onInputDblClick=bindAndCatch(this._onInputDblClick,this),this._onInputTextChanged=bindAndCatch(this._onInputTextChanged,this),this._onInputScroll=bindAndCatch(this._onInputScroll,this),this._onHiglighterBlockClicked=bindAndCatch(this._onHiglighterBlockClicked,this),this._onToolbarPermissionRequiredIconClicked=bindAndCatch(this._onToolbarPermissionRequiredIconClicked,this),this._onToolbarToggleDialog=bindAndCatch(this._onToolbarToggleDialog,this),this._onToolbarNotifyAboutPremiumIcon=bindAndCatch(this._onToolbarNotifyAboutPremiumIcon,this),this._onToolbarTurnOffClicked=bindAndCatch(this._onToolbarTurnOffClicked,this),this._onDialogEnableHere=bindAndCatch(this._onDialogEnableHere,this),this._onDialogEnableEverywhere=bindAndCatch(this._onDialogEnableEverywhere,this),this._onDialogLanguageChanged=bindAndCatch(this._onDialogLanguageChanged,this),this._onDialogErrorHighlighted=bindAndCatch(this._onDialogErrorHighlighted,this),this._onDialogErrorSelected=bindAndCatch(this._onDialogErrorSelected,this),this._onErrorCardLanguageChanged=bindAndCatch(this._onErrorCardLanguageChanged,this),this._onAddToDictionary=bindAndCatch(this._onAddToDictionary,this),this._onIgnoreRule=bindAndCatch(this._onIgnoreRule,this),this._onTemporarilyIgnoreWord=bindAndCatch(this._onTemporarilyIgnoreWord,this),this._onTemporarilyIgnoreRule=bindAndCatch(this._onTemporarilyIgnoreRule,this),this._onMoreDetailsClicked=bindAndCatch(this._onMoreDetailsClicked,this),this._onFixSelected=bindAndCatch(this._onFixSelected,this),this._onDialogOpenOptions=bindAndCatch(this._onDialogOpenOptions,this),this._onDialogShowFeedbackForm=bindAndCatch(this._onDialogShowFeedbackForm,this),this._onDialogDestroyed=bindAndCatch(this._onDialogDestroyed,this),this._onBadgeClicked=bindAndCatch(this._onBadgeClicked,this),this._onLogoClicked=bindAndCatch(this._onLogoClicked,this),this._onErrorCardDestroyed=bindAndCatch(this._onErrorCardDestroyed,this),this._onSynonymSelected=bindAndCatch(this._onSynonymSelected,this),this._onSynonymsCardDestroyed=bindAndCatch(this._onSynonymsCardDestroyed,this),this._onSettingsChanged=bindAndCatch(this._onSettingsChanged,this),this._onPrivacySettingsChanged=bindAndCatch(this._onPrivacySettingsChanged,this),this._onUiStateChanged=bindAndCatch(this._onUiStateChanged,this),this._storageController=StorageController.create(),this._storageController.onReady(bindAndCatch(this._init,this)),Dictionary.init(this._storageController,this._options.dictionary))}static _isStartWithUppercase(e){const t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()}static _toLowercaseFirstChar(e){return e.charAt(0).toLowerCase()+e.substr(1)}static _getWordContext(e,t,r){function i(e,t,r=t){const i=e.substring(t,r);let o,n,a;try{o=new RegExp("\\p{L}","iu"),n=new RegExp("^\\s*(-?\\p{L}+)*-?\\s*$","iu"),a=new RegExp("^\\s*\\p{L}+(-\\p{L}+)*\\s*$","iu")}catch(e){o=/[a-zäöüß]/i,n=/^\s*(-?[a-zäöüß]+)*-?\s*$/i,a=/^\s*[a-zäöüß]+(-[a-zäöüß]+)*\s*$/i}if(!n.test(i))return null;let s=0===i.length||o.test(i[0]),d="-"===i[0],l=t;if(s||d)for(;l>0;){const t=e[l-1],r=o.test(t),i="-"===t;if(!r&&!i)break;if(i&&d)return null;l--,s=r,d=i}s=o.test(i[i.length-1]),d=i.endsWith("-");let g=r;if(s||d)for(;g<e.length;){const t=e[g],r=o.test(t),i="-"===t;if(!r&&!i)break;if(i&&d)return null;g++,s=r,d=i}const h=e.substring(l,g);return a.test(h)?{start:l,end:g}:null}const o=i(e,t,r);if(!o)return{word:e.substring(t,r),position:{start:t,end:r},beforeText:"",afterText:""};let n="",a=o.start;for(let t=0;t<3;t++){const t=i(e,e.substring(0,a).search(/[ \t]*$/));if(!(t&&t.end<=o.start))break;n=e.substring(t.start,t.end).trim()+" "+n,a=t.start}let s="";const d=e.substring(o.end).match(/^[ \t]*/);if(d){const t=i(e,o.end+d.index+d[0].length);t&&t.start>=o.end&&(s=e.substring(t.start,t.end))}return{word:e.substring(o.start,o.end),position:o,beforeText:n.trim(),afterText:s.trim()}}static _isErrorIgnoredByDictionary(e,t){if(!e.isSpellingError)return!1;let r=e.originalPhrase;if(/^\w+\.$/.test(r)&&(r=r.substring(0,r.length-1)),t.includes(r))return!0;if(LTAssistant._isStartWithUppercase(r)){const e=LTAssistant._toLowercaseFirstChar(r);if(t.includes(e))return!0}return!1}static _isErrorRuleIgnored(e,t){const r=LanguageManager.getPrimaryLanguageCode(e.language.code);return t.some(t=>{return!(t.id!==e.rule.id||"*"!==t.language&&t.language!==r)&&(!t.phrase||t.phrase.toLowerCase()===e.originalPhrase.toLowerCase())})}static _isPendingError(e,t){if(0===e.contextForSureMatch)return!1;const r=t.substr(e.offset+e.length,100).split("\n")[0],i=LTAssistant.COMPLETED_SENTENCE_REGEXP.test(r)||LTAssistant.PUNCTIUATION_CHAR_REGEXP.test(e.originalPhrase);if(-1===e.contextForSureMatch&&!i)return!0;if(!i){if(r.split(/\s+/).length-1<=e.contextForSureMatch)return!0}return!1}static _isErrorSelected(e,t){return!(!t||t.start!==e.offset&&t.end!==e.offset+e.length)}static _getChangedParagraphs(e,t){return getParagraphsDiff(e,t).filter(e=>e.oldText!==e.newText&&null!==e.newText).map(e=>({text:e.newText,offset:e.newOffset}))}static _correctErrors(e,t){const r=[];for(const i of e){const e=i.offset,o=e+i.length,n=t.find(t=>t.offset<=e&&e<t.offset+t.length),a=t.find(e=>e.offset<=o&&o<=e.offset+e.length);if(!n||!a)continue;const s=n.originalOffset-n.offset,d=a.originalOffset-a.offset,l=clone(i);l.offset+=s,l.length+=d-s,r.push(l)}return r}static _adjustErrors(e,t,r,i=!1){const o=[],n=getParagraphsDiff(e,t);for(const e of r){let t=!1;const r=Object.assign({},e),a=r.offset,s=r.offset+r.length;for(const e of n)if(null!==e.oldText){const o=e.oldOffset,n=e.oldOffset+e.oldText.length+1;if(isIntersect(o,n,a,s)){if(null!==e.textDiff){const o=e.oldOffset+e.textDiff.from,n=o+e.textDiff.oldFragment.length;if(!i&&isIntersect(o,n,a,s,!0)){t=!0;break}if(a>=n){const t=e.textDiff.newFragment.length-e.textDiff.oldFragment.length;r.offset+=t}}r.offset+=e.newOffset-e.oldOffset}}t||o.push(r)}return o}static _getErrorsOutsideParagarphs(e,t){const r=[];for(const i of e){const e=i.offset,o=i.offset+i.length;!t.some(t=>{const r=t.offset,i=t.offset+t.text.length+1;return isIntersect(r,i,e,o)})&&r.push(Object.assign({},i))}return r}static _getErrorsInsideTextParts(e,t){const r=[];for(const i of e){t.some(e=>e.originalOffset<=i.offset&&i.offset<e.originalOffset+e.length)&&r.push(Object.assign({},i))}return r}_init(){if("string"==typeof this._options.apiServerUrl&&this._storageController.updateSettings({apiServerUrl:this._options.apiServerUrl}),"object"==typeof this._options.user&&this._storageController.updateSettings({username:this._options.user.email,token:this._options.user.token}),"boolean"==typeof this._options.enableSynonyms&&this._storageController.updateSettings({hasSynonymsEnabled:this._options.enableSynonyms}),Array.isArray(this._options.preferredVariants)){const e={};for(const t of this._options.preferredVariants){const r=LanguageManager.getPrimaryLanguageCode(t);"en"===r?e.enVariant=t:"de"===r?e.deVariant=t:"pt"===r?e.ptVariant=t:"ca"===r&&(e.caVariant=t)}this._storageController.updateSettings(e)}if(this._onPageLoaded(),this._tweaks.supported()&&this._storageController.isDomainSupported(getCurrentDomain())){if(this._isRemoteCheckAllowed=this._storageController.getPrivacySettings().allowRemoteCheck,this._checkExtensionHealthIntervalId=window.setInterval(this._checkExtensionHealth,config.EXTENSION_HEALTH_RECHECK_INTERVAL),this._options.initElements){const e=Array.isArray(this._options.initElements)?this._options.initElements:[this._options.initElements];for(const t of e)this._initElement(t)}if(!this._options.ignoreFocus){const e=document.querySelector(":focus");e&&this._initElement(e,!0),document.body&&hasFirefoxDesignMode(document.body)&&this._initElement(document.body,!0)}window.__ltLastActiveElement&&(this._initElement(window.__ltLastActiveElement),window.__ltLastActiveElement=null),this._tweaks.onElement((e,t)=>{this._initElement(e,t)}),BrowserDetector.isChromium()&&window.innerHeight>14&&(this._fixTinyMCEIntervalId=window.setInterval(()=>{this._fixIframeWithoutContentScripts()},config.IFRAME_INITILIZATION_RECHECK_INTERVAL)),window.addEventListener("pageshow",this._onPageLoaded),window.addEventListener("pagehide",this._onPageHide),document.addEventListener("focus",this._onDocumentFocus,!0),document.addEventListener("mousemove",this._onDocumentMousemove,!0),document.addEventListener("focusout",this._onDocumentFocusout,!0),document.addEventListener(this._tweaks.getClickEvent(),this._onDocumentClick,!0),window.frameElement&&window.frameElement.ownerDocument&&window.frameElement.ownerDocument.addEventListener("click",this._onDocumentClick,!0),document.addEventListener(LTAssistant.events.DESTROY,this.destroy),document.addEventListener(InputAreaWrapper.eventNames.dblclick,this._onInputDblClick),document.addEventListener(InputAreaWrapper.eventNames.textChanged,this._onInputTextChanged),document.addEventListener(InputAreaWrapper.eventNames.scroll,this._onInputScroll),document.addEventListener(Highlighter.eventNames.blockClicked,this._onHiglighterBlockClicked),document.addEventListener(Toolbar.eventNames.permissionRequiredIconClicked,this._onToolbarPermissionRequiredIconClicked),document.addEventListener(Toolbar.eventNames.toggleDialog,this._onToolbarToggleDialog),document.addEventListener(Toolbar.eventNames.notifyAboutPremiumIcon,this._onToolbarNotifyAboutPremiumIcon),document.addEventListener(Toolbar.eventNames.turnOff,this._onToolbarTurnOffClicked),document.addEventListener(Dialog.eventNames.enableHere,this._onDialogEnableHere),document.addEventListener(Dialog.eventNames.enableEverywhere,this._onDialogEnableEverywhere),document.addEventListener(Dialog.eventNames.languageChanged,this._onDialogLanguageChanged),document.addEventListener(Dialog.eventNames.errorSelected,this._onDialogErrorSelected),document.addEventListener(Dialog.eventNames.errorHighlighted,this._onDialogErrorHighlighted),document.addEventListener(Dialog.eventNames.addToDictionaryClicked,this._onAddToDictionary),document.addEventListener(Dialog.eventNames.ignoreRuleClicked,this._onIgnoreRule),document.addEventListener(Dialog.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.addEventListener(Dialog.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.addEventListener(Dialog.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.addEventListener(Dialog.eventNames.fixSelected,this._onFixSelected),document.addEventListener(Dialog.eventNames.openOptions,this._onDialogOpenOptions),document.addEventListener(Dialog.eventNames.showFeedbackForm,this._onDialogShowFeedbackForm),document.addEventListener(Dialog.eventNames.destroyed,this._onDialogDestroyed),document.addEventListener(ErrorCard.eventNames.addToDictionaryClicked,this._onAddToDictionary),document.addEventListener(ErrorCard.eventNames.ignoreRuleClicked,this._onIgnoreRule),document.addEventListener(ErrorCard.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.addEventListener(ErrorCard.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.addEventListener(ErrorCard.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.addEventListener(ErrorCard.eventNames.fixSelected,this._onFixSelected),document.addEventListener(ErrorCard.eventNames.badgeClicked,this._onBadgeClicked),document.addEventListener(ErrorCard.eventNames.logoClicked,this._onLogoClicked),document.addEventListener(ErrorCard.eventNames.languageChanged,this._onErrorCardLanguageChanged),document.addEventListener(ErrorCard.eventNames.destroyed,this._onErrorCardDestroyed),document.addEventListener(SynonymsCard.eventNames.badgeClicked,this._onBadgeClicked),document.addEventListener(SynonymsCard.eventNames.logoClicked,this._onLogoClicked),document.addEventListener(SynonymsCard.eventNames.synonymSelected,this._onSynonymSelected),document.addEventListener(SynonymsCard.eventNames.destroyed,this._onSynonymsCardDestroyed),this._storageController.addEventListener(StorageControllerClass.eventNames.settingsChanged,this._onSettingsChanged),this._storageController.addEventListener(StorageControllerClass.eventNames.privacySettingsChanged,this._onPrivacySettingsChanged),this._storageController.addEventListener(StorageControllerClass.eventNames.uiStateChanged,this._onUiStateChanged),this._options.onInit&&this._options.onInit(this)}}_getValidationSettings(){const e=getMainPageDomain();return this._storageController.getValidationSettings(e,this._tweaks.getEditorGroupId(getCurrentUrl()))}_fixIframeWithoutContentScripts(){if(!document.activeElement||"IFRAME"!==document.activeElement.nodeName)return;const e=document.activeElement.contentWindow;let t=!1;try{t=!!e.location.href}catch(e){}t&&"complete"===e.document.readyState&&e.document.documentElement&&(e.__ltJsLoaded||(isLTAvailable(e)?e.__ltJsLoaded=!0:e.document.body&&isTinyMCE(e.document.body)&&(e.__ltJsLoaded=!0,EnvironmentAdapter.loadContentScripts(e,"js"))),e.__ltCssLoaded||(isCssContentScriptsLoaded(e)?e.__ltCssLoaded=!0:e.document.body&&(e.__ltCssLoaded=!0,EnvironmentAdapter.loadContentScripts(e,"css"))))}_initElement(e,t=!1){if(!e.parentElement)return;if(this._editors.some(t=>t.inputArea===e))return;if(!this._tweaks.isElementCompatible(e))return;const r=this._getValidationSettings();r.isDomainDisabled||r.isEditorGroupDisabled||(window.clearTimeout(this._initElementTimeouts.get(e)),r.isAutoCheckEnabled&&this._disableOtherSpellCheckers(e),this._initElementTimeouts.set(e,window.setTimeout(()=>{this._initElementTimeouts.delete(e),!t||hasFocus(e)?this.initElement(e):this._enableOtherSpellCheckers(e)},150)))}initElement(e,t){if(this._editors.some(t=>t.inputArea===e))throw"LanguageTool is already initialized on this element.";if(!this._storageController.isReady)throw"LTAssistent is not ready initialized yet.";const r=Math.round(99999*Math.random())+":"+Date.now(),i=this._tweaks.getEditorGroupId(getCurrentUrl()),o=isFormElement(e)?new Mirror(e):null,n=new InputAreaWrapper(e,o?o.getCloneElement():e,this._tweaks,this._storageController.getMaxTextLength()),a=new Highlighter(e,n,o?o.getCloneElement():e,!!o,this._tweaks);let s=null;"false"!==e.getAttribute("data-lt-toolbar")&&(s=new Toolbar(e,this._tweaks.getToolbarAppearance(e),o));const d=this._tweaks.initElement(e);let l={words:t&&t.dictionary||[],rules:t&&t.ignoredRules||[]};const g=this._tweaks.storeTemporaryIgnoredItems();g&&(l=LocalStorageWrapper.get(`ignored:${i}`)||l);const h={id:r,groupId:i,checkLevel:"normal",inputArea:e,inputAreaTweaks:d,mirror:o,inputAreaWrapper:n,highlighter:a,toolbar:s,dialog:null,errorCard:null,synonymsCard:null,ignoredRules:l.rules||[],ignoredWords:l.words||[],validationDebounce:new Debounce(bindAndCatch(this._sendValidationRequest,this),config.VALIDATION_DELAY,config.VALIDATION_MAX_DELAY),validationStatus:VALIDATION_STATUS.COMPLETED,language:null,forceLanguage:!1,isLanguageSupported:!0,isAutoCheckEnabled:this._getValidationSettings().isAutoCheckEnabled,isUserTyping:!1,isValidating:!1,isTextTooShort:!1,isTextTooLong:!1,validationError:null,validatedText:"",isIncompleteResult:!1,errors:[],displayedErrors:[],pendingErrors:[],premiumErrors:[],displayedPremiumErrors:[],displayedHiddenErrorCount:0,pendingPremiumErrors:[],selectedErrorId:null,temporaryDisabledErrorId:null,shouldStoreTemporaryIgnoredItems:g,typingTimeoutId:void 0,callbacks:{onDictionaryAdd:t&&t.onDictionaryAdd,onTemporaryDictionaryAdd:t&&t.onTemporaryDictionaryAdd,onRuleIgnore:t&&t.onRuleIgnore,onTemporaryRuleIgnore:t&&t.onTemporaryRuleIgnore,onUpdate:t&&t.onUpdate},tracking:{hasTracked:!1,hasEnoughText:!1,sawPremiumIcon:!1,languageCode:null,maxTextLength:0}},c=(e.getAttribute("data-lt-lang")||"").toLowerCase();if(c){const e=LanguageManager.LANGUAGES.find(e=>e.code===c);e&&(h.language=e,h.forceLanguage=!0)}return this._editors.push(h),this._validateEditor(h),this._updateState(h),this._tweaks.onElementDestroy(e,()=>this._destroyEditor(h)),{addWord:e=>this._temporarilyIgnoreWord(h,e),ignoreRule:e=>this._temporarilyIgnoreRule(h,e),getText:()=>h.inputAreaWrapper.getText(),getLanguage:()=>h.language,setLanguage:e=>this._setLanguage(h,e.toLowerCase()),setCheckLevel:e=>this._setCheckLevel(h,e),getElement:()=>h.inputArea,getDisplayedErrors:()=>h.displayedErrors,getDisplayedPremiumErrors:()=>h.displayedPremiumErrors,getStatus:()=>h.validationStatus,destroy:()=>this._destroyEditor(h)}}setLocale(e){i18nManager.setLocale(e)}_disableOtherSpellCheckers(e){if(this._spellcheckingAttributesData.get(e))return;const t={spellcheck:e.getAttribute("spellcheck"),"data-gramm":e.getAttribute("data-gramm")};e.setAttribute("spellcheck","false"),e.setAttribute("data-gramm","false");const r=new MutationObserver(t=>{if("false"===e.getAttribute("spellcheck")&&"false"===e.getAttribute("data-gramm")||(e.setAttribute("spellcheck","false"),e.setAttribute("data-gramm","false")),t.some(e=>"data-lt-lang"===e.attributeName)){const t=this._editors.find(t=>t.inputArea===e);if(t){const r=(e.getAttribute("data-lt-lang")||"auto").toLowerCase();this._setLanguage(t,r)}}});r.observe(e,{attributes:!0,attributeFilter:["spellcheck","data-gramm","data-lt-lang"]}),this._spellcheckingAttributesData.set(e,{originalValues:t,mutationObserver:r})}_enableOtherSpellCheckers(e){const t=this._spellcheckingAttributesData.get(e);if(t){t.mutationObserver.disconnect();for(const r in t.originalValues){const i=t.originalValues[r];t.originalValues[r]?e.setAttribute(r,i):e.removeAttribute(r)}this._spellcheckingAttributesData.delete(e)}}_updateState(e){let t=VALIDATION_STATUS.COMPLETED;const r=e.language?e.language.code:"";let i="";this._isConnected?this._isRemoteCheckAllowed?e.isAutoCheckEnabled?e.isUserTyping||e.isValidating?t=VALIDATION_STATUS.IN_PROGRESS:e.validationError?(t=VALIDATION_STATUS.FAILED,i=e.validationError.message):e.isTextTooShort?t=VALIDATION_STATUS.TEXT_TOO_SHORT:e.isTextTooLong?t=VALIDATION_STATUS.TEXT_TOO_LONG:e.isLanguageSupported||(t=VALIDATION_STATUS.UNSUPPORTED_LANGUAGE):t=VALIDATION_STATUS.DISABLED:t=VALIDATION_STATUS.PERMISSION_REQUIRED:t=VALIDATION_STATUS.DISCONNECTED,e.validationStatus=t;const o={validationStatus:t,errorsCount:e.displayedErrors.length,premiumErrorsCount:e.displayedPremiumErrors.length,isIncompleteResult:e.isIncompleteResult,validationErrorMessage:i};if(e.toolbar&&e.toolbar.updateState(o),e.dialog){const r={validationStatus:t,errors:e.displayedErrors,premiumErrors:e.displayedPremiumErrors,isIncompleteResult:e.isIncompleteResult,ignoredErrorsStats:this._getIgnoredErrorsStats(e.errors),validationErrorMessage:i};e.dialog.updateState(r)}e.displayedHiddenErrorCount=Math.max(e.displayedHiddenErrorCount,e.displayedPremiumErrors.length);const n={validationStatus:t,languageCode:r,errors:e.displayedErrors,premiumErrors:e.displayedPremiumErrors,isIncompleteResult:e.isIncompleteResult,validationErrorMessage:i};dispatchCustomEvent(e.inputArea,LTAssistant.events.UPDATE,n),e.callbacks.onUpdate&&e.callbacks.onUpdate(n)}_setLanguage(e,t){const r=e.language;let i=null;if("auto"===t)e.language=null,e.forceLanguage=!1;else{if(!(i=LanguageManager.LANGUAGES.find(e=>e.code===t)||null))throw new Error(`LTAssistant: Language '${t}' is not supported.`);e.language=i,e.forceLanguage=!0}if(this._resetEditor(e),this._endTypingMode(e),this._validateEditor(e,!0,!1),this._highlight(e),this._updateState(e),r&&r.code){if(Tracker.trackEvent("Action","check_trigger:switch_language",`${r.code} -> ${t}`),i&&LanguageManager.isLanguageVariant(r)&&LanguageManager.isLanguageVariant(i)){const e=LanguageManager.getPrimaryLanguageCode(r.code),t=LanguageManager.getPrimaryLanguageCode(i.code);if(e===t&&r.code!==i.code){const e=LanguageManager.formatLanguageCode(i.code);"en"===t?this._storageController.updateSettings({enVariant:e}):"de"===t?this._storageController.updateSettings({deVariant:e}):"pt"===t?this._storageController.updateSettings({ptVariant:e}):"ca"===t&&this._storageController.updateSettings({caVariant:e})}}const{languageDetectionTest:e}=this._storageController.getTestFlags();e&&i&&LanguageManager.getPrimaryLanguageCode(i.code)!==LanguageManager.getPrimaryLanguageCode(r.code)&&Tracker.trackEvent("Stat",`${e}:language_change`,`${r.code} -> ${t}`)}else Tracker.trackEvent("Action","check_trigger:switch_language",`unknown -> ${t}`)}_setCheckLevel(e,t){e.checkLevel=t,this._validateEditor(e),this._updateState(e),Tracker.trackEvent("Action","set_check_level",t)}_resetEditor(e){e.isValidating=!1,e.isTextTooShort=!1,e.isTextTooLong=!1,e.validationError=null,e.validatedText="",e.isIncompleteResult=!1,e.errors=[],e.displayedErrors=[],e.pendingErrors=[],e.premiumErrors=[],e.displayedPremiumErrors=[],e.pendingPremiumErrors=[],e.selectedErrorId=null,e.errorCard&&e.errorCard.destroy(),e.synonymsCard&&e.synonymsCard.destroy()}_validateEditor(e,t,r){let i,o=!1;if(void 0===t&&void 0===r?(i=e.inputAreaWrapper.getText(),r=!1):"boolean"==typeof t&&void 0===r?i=e.inputAreaWrapper.getText():"string"==typeof t&&"boolean"==typeof r?i=t:(i=e.inputAreaWrapper.getText(),o=t),!this._isConnected)return!0;if(!this._isRemoteCheckAllowed||!e.isAutoCheckEnabled)return!0;const n=i.trim();return n.length<config.MIN_TEXT_LENGTH||LTAssistant.NO_LETTERS_REGEXP.test(n)?(e.forceLanguage||(e.language=null,e.isLanguageSupported=!0),this._resetEditor(e),e.isTextTooShort=!0,e.validationDebounce.cancelCall(),!0):i.length>this._storageController.getMaxTextLength()?(e.forceLanguage||(e.language=null,e.isLanguageSupported=!0),this._resetEditor(e),e.isTextTooLong=!0,e.validationDebounce.cancelCall(),!0):(!e.forceLanguage&&isTextsCompletelyDifferent(e.validatedText,i)&&(e.language=null,e.isLanguageSupported=!0),e.isLanguageSupported||(e.isLanguageSupported=!0,e.forceLanguage||(e.language=null)),e.isValidating=!0,e.isTextTooShort=!1,e.isTextTooLong=!1,e.validationDebounce.call(e,i,o),r||e.validationDebounce.callImmediately(),!1)}_sendValidationRequest(e,t,r){return __awaiter(this,void 0,void 0,function*(){const i=this._tweaks.getValuableText(e.inputArea,e.validatedText),o=this._tweaks.getValuableText(e.inputArea,t);if(i.text===o.text)return void this._onValidationAborted(e,t);const n=LTAssistant._getChangedParagraphs(i.text,o.text),a=getCurrentUrl(),s=yield this._tweaks.getRecipientInfo(e.inputArea);try{const t=yield EnvironmentAdapter.validate(e,o.text,n,r,a,s);if(!t)return;t.isSuccessful?this._onValidationCompleted(t,o):this._onValidationFailed(t)}catch(t){e.isValidating=!1,console.error(t),Tracker.trackError("message",t.message,"VALIDATE_TEXT"),t.message&&(t.message.startsWith("Invocation of form runtime.connect(null, ) doesn't match definition runtime.connect")||t.message.startsWith("Extension context invalidated"))?(this._isConnected=!1,this._editors.forEach(e=>{e.highlighter&&e.highlighter.destroy(),this._updateState(e)})):(e.validationError={message:i18nManager.getMessage("unknownError")},this._updateState(e))}})}_onValidationCompleted(e,t){const r=this._editors.find(t=>t.id===e.instanceId);if(!r)return;if(!r.isAutoCheckEnabled)return;if(r.validationError=null,r.isValidating=!1,e.isUnsupportedLanguage)return this._resetEditor(r),this._endTypingMode(r),r.language=null,r.isLanguageSupported=!1,r.validatedText=t.originalText,this._highlight(r),void this._updateState(r);if(e.language&&!r.language&&(r.language=e.language),t.originalText.length>config.MIN_TEXT_LENGTH&&(r.tracking.languageCode=e.language?e.language.code:null,r.tracking.hasEnoughText=!0),r.tracking.maxTextLength=Math.max(t.originalText.length,r.tracking.maxTextLength),e.language&&r.dialog&&r.dialog.setCurrentLanguage(e.language.code),e.language&&e.language.code.toLowerCase()!==r.language.code.toLowerCase())return this._resetEditor(r),r.language=e.language,this._validateEditor(r),this._highlight(r),void this._updateState(r);const i=LTAssistant._correctErrors(e.validationErrors,t.partsMap),o=LTAssistant._correctErrors(e.partialValidationErrors,t.partsMap),n=LTAssistant._correctErrors(e.validationHiddenErrors,t.partsMap),a=LTAssistant._correctErrors(e.partialValidationHiddenErrors,t.partsMap);let s=r.errors.slice(0),d=r.premiumErrors.slice(0);s=s.filter(e=>e.isPartialValidation),d=d.filter(e=>e.isPartialValidation),s=LTAssistant._adjustErrors(r.validatedText,t.originalText,s),d=LTAssistant._adjustErrors(r.validatedText,t.originalText,d);const l=LTAssistant._getChangedParagraphs(r.validatedText,t.originalText);s=LTAssistant._getErrorsOutsideParagarphs(s,l),d=LTAssistant._getErrorsOutsideParagarphs(d,l),s=LTAssistant._getErrorsInsideTextParts(s,t.partsMap),d=LTAssistant._getErrorsInsideTextParts(d,t.partsMap),s=s.concat(o),d=d.concat(a);for(const e of i)s.some(t=>t.offset===e.offset&&t.length===e.length)||s.push(e);for(const e of n)d.some(t=>t.offset===e.offset&&t.length===e.length)||d.push(e);s.sort((e,t)=>e.offset>t.offset?1:-1);for(let e=0;e<s.length;e++)s[e].id=e+1;d.sort((e,t)=>e.offset>t.offset?1:-1);for(let e=0;e<d.length;e++)d[e].id=e+1;s=this._tweaks.filterErrors(r,s);const g=r.inputAreaWrapper.getText(),h=LTAssistant._adjustErrors(t.originalText,g,s),c=LTAssistant._adjustErrors(t.originalText,g,d);r.validatedText=t.originalText,r.errors=s,r.premiumErrors=d,r.isIncompleteResult=e.isIncompleteResult,this._updateDisplayedErrors(r,h,c),0===r.pendingErrors.length&&0===r.pendingPremiumErrors.length&&this._endTypingMode(r),this._highlight(r),this._updateState(r)}_onValidationAborted(e,t){e.inputAreaWrapper.getText()===t&&(e.isValidating=!1,e.pendingErrors=[],e.pendingPremiumErrors=[],this._endTypingMode(e),e.errors=LTAssistant._adjustErrors(e.validatedText,t,e.errors,!0),e.premiumErrors=LTAssistant._adjustErrors(e.validatedText,t,e.premiumErrors,!0),e.validatedText=t,this._updateDisplayedErrors(e),this._highlight(e),this._updateState(e))}_onValidationFailed(e){const t=this._editors.find(t=>t.id===e.instanceId);if(t){if(this._resetEditor(t),t.validationError=e.error,e&&e.error&&void 0!==e.error.status)this._storageController.isUsedCustomServer()||Tracker.trackError("http",`${e.error.status}: ${e.error.response}`);else if(e&&e.error&&e.error.message){const r=e.error;t.validationError={message:i18nManager.getMessage("unknownError")};const i=generateStackTrace(r);Tracker.trackError("js",r.message,i||"")}else Tracker.trackError("http","unknown");this._highlight(t),this._updateState(t)}}_startTypingMode(e){e.isUserTyping=!0,window.clearTimeout(e.typingTimeoutId),e.typingTimeoutId=window.setTimeout(()=>this._endTypingModeAndUpdateState(e),config.STOPPED_TYPING_TIMEOUT)}_endTypingModeAndUpdateState(e){this._endTypingMode(e);const t=LTAssistant._adjustErrors(e.validatedText,e.inputAreaWrapper.getText(),e.errors);this._updateDisplayedErrors(e,t),this._highlight(e),this._updateState(e)}_endTypingMode(e){e.isUserTyping=!1,window.clearTimeout(e.typingTimeoutId)}_updateDisplayedErrors(e,t=e.errors,r=e.premiumErrors){const{ignoredRules:i}=this._storageController.getSettings(),o=Dictionary.get(),n=e.inputAreaWrapper.getSelection(),a=e.displayedErrors;e.displayedErrors=[],e.pendingErrors=[];for(const r of t){if(!(LTAssistant._isErrorIgnoredByDictionary(r,o)||LTAssistant._isErrorIgnoredByDictionary(r,e.ignoredWords)||LTAssistant._isErrorRuleIgnored(r,i)||LTAssistant._isErrorRuleIgnored(r,e.ignoredRules))){if(e.isUserTyping){if(!a.some(e=>e.offset===r.offset&&e.length===r.length||e.id===r.id&&e.originalPhrase===r.originalPhrase)){if(LTAssistant._isPendingError(r,e.validatedText)){e.pendingErrors.push(r);continue}if(LTAssistant._isErrorSelected(r,n)){e.pendingErrors.push(r);continue}}}e.displayedErrors.push(r)}}const s=e.displayedPremiumErrors;e.displayedPremiumErrors=[],e.pendingPremiumErrors=[];for(const t of r){if(e.isUserTyping){if(!s.some(e=>e.offset===t.offset)){if(LTAssistant._isPendingError(t,e.validatedText)){e.pendingPremiumErrors.push(t);continue}if(LTAssistant._isErrorSelected(t,n)){e.pendingPremiumErrors.push(t);continue}}}e.displayedPremiumErrors.push(t)}}_highlight(e){const t=e.displayedErrors.map(t=>{let r=config.COLORS.GRAMMAR.UNDERLINE,i=config.COLORS.GRAMMAR.BACKGROUND,o=config.COLORS.GRAMMAR.EMPHASIZE;return t.isSpellingError?(r=config.COLORS.SPELLING.UNDERLINE,i=config.COLORS.SPELLING.BACKGROUND,o=config.COLORS.SPELLING.EMPHASIZE):t.isStyleError&&(r=config.COLORS.STYLE.UNDERLINE,i=config.COLORS.STYLE.BACKGROUND,o=config.COLORS.STYLE.EMPHASIZE),{id:t.id,offset:t.offset,length:t.length,isEmphasized:t.id===e.selectedErrorId||!!this._options.emphasizeErrors,backgroundColor:t.id===e.selectedErrorId?i:o,isUnderlined:!0,underlineColor:r}});if(e.synonymsCard){const r=e.synonymsCard.selection;t.push({id:-1,offset:r.start,length:r.end-r.start,isEmphasized:!1,backgroundColor:"",isUnderlined:!1,underlineColor:config.COLORS.SYNONYMS.UNDERLINE,simulateSelection:!0})}e.highlighter.highlight(t)}_enableEditor(e){e.isAutoCheckEnabled=!0,this._disableOtherSpellCheckers(e.inputArea),e.inputAreaWrapper.resetText(),this._resetEditor(e),this._validateEditor(e),this._updateState(e)}_disableEditor(e){e.isAutoCheckEnabled=!1,this._enableOtherSpellCheckers(e.inputArea),e.inputAreaWrapper.resetText(),this._resetEditor(e),this._endTypingMode(e),this._highlight(e),this._updateState(e)}_trackEditor(e){(EnvironmentAdapter.isRuntimeConnected()||e.tracking.hasTracked)&&(e.tracking.hasTracked=!0,e.tracking.hasEnoughText&&EnvironmentAdapter.trackEvent(`saw_premium_icon:${e.tracking.sawPremiumIcon}`,e.tracking.languageCode),Math.random()<.1&&EnvironmentAdapter.trackTextLength(e.tracking.maxTextLength))}_destroyEditor(e){const t=this._editors.indexOf(e);if(-1===t)return;this._editors.splice(t,1),e.inputAreaWrapper.destroy(),e.highlighter.destroy(),e.inputAreaTweaks.destroy(),e.toolbar&&e.toolbar.destroy(),window.clearTimeout(e.typingTimeoutId),e.mirror&&e.mirror.destroy(),e.errorCard&&e.errorCard.destroy(),e.dialog&&e.dialog.destroy();const r=this._initElementTimeouts.get(e.inputArea);r&&(this._initElementTimeouts.delete(e.inputArea),clearTimeout(r)),this._enableOtherSpellCheckers(e.inputArea),this._savePremiumErrorCount(e),this._trackEditor(e)}_showErrorCard(e,t,r){const i=this._storageController.getManagedSettings(),o={disableIgnoringRule:void 0!==this._options.disableRuleIgnore?this._options.disableRuleIgnore:i.disableIgnoredRules,disableAddingWord:void 0!==this._options.disableDictionaryAdd?this._options.disableDictionaryAdd:i.disablePersonalDictionary,isPremiumAccount:this._storageController.getUIState().hasPaidSubscription,geoIpCountry:this._storageController.getSettings().geoIpCountry,showRuleId:this._storageController.getUIState().showRuleId};e.errorCard=new ErrorCard(e.inputArea,r,t,o);const n=LanguageManager.getPrimaryLanguageCode(t.language.code);Tracker.trackEvent("Action",`${n}:open_rule`,t.rule.id),1===t.fixes.length&&""===t.fixes[0].value&&t.language.code.match(/^(de|en|fr|nl)/i)&&!["SEKSE_LIJK","COMMA_PARENTHESIS_WHITESPACE","UNLIKELY_OPENING_PUNCTUATION"].includes(t.rule.id)&&Tracker.trackError("other","empty_fix",n+":"+t.rule.id+": "+t.contextPhrase)}_hideAllErrorCards(){this._editors.forEach(e=>{e.errorCard&&e.errorCard.destroy()})}_showSynonymsCard(e,t,r){this._hideAllErrorCards(),this._hideAllSynonymsCards(),EnvironmentAdapter.isRuntimeConnected()&&waitFor(()=>e.language?e.language.code:e.isTextTooShort?LanguageManager.getUserLanguageCodes()[0]||"en":e.errors[0]?e.errors[0].language.code:void 0).then(i=>{e.synonymsCard=new SynonymsCard(e.inputArea,t,r,LanguageManager.getPrimaryLanguageCode(i),this._storageController.getSettings().motherTongue,this._storageController.getUIState().hasPaidSubscription),this._highlight(e),Tracker.trackEvent("Action","synonyms:open")}).catch(e=>{Tracker.trackEvent("Other-Error","synonyms:no_language",e&&e.message)})}_hideAllSynonymsCards(){this._editors.forEach(e=>{e.synonymsCard&&(e.synonymsCard.destroy(),this._highlight(e))})}_showDialog(e){if(!e.toolbar)return;const t=e.language&&e.language.code,r={validationStatus:e.validationStatus,errors:e.displayedErrors,premiumErrors:e.displayedPremiumErrors,isIncompleteResult:e.isIncompleteResult,ignoredErrorsStats:this._getIgnoredErrorsStats(e.errors),validationErrorMessage:e.validationError&&e.validationError.message||""},i=this._storageController.getManagedSettings(),o=void 0!==this._options.disableRuleIgnore?this._options.disableRuleIgnore:i.disableIgnoredRules,n=void 0!==this._options.disableDictionaryAdd?this._options.disableDictionaryAdd:i.disablePersonalDictionary,a={disableOptionsPage:!EnvironmentAdapter.isOptionsPageSupported(),disableFeedbackForm:!EnvironmentAdapter.isFeedbackFormSupported(),disableRatingTeaser:this._storageController.getUIState().hasRated,disableIgnoringRule:o,disableAddingWord:n};e.dialog=new Dialog(e.toolbar.getContainer(),t,r,a)}_hideAllDialogs(){this._editors.forEach(e=>{e.dialog&&e.dialog.destroy()})}_savePremiumErrorCount(e){if(!e.displayedHiddenErrorCount||!EnvironmentAdapter.isRuntimeConnected())return;const t=(new Date).toDateString(),{hiddenErrors:r}=this._storageController.getStatistics();r[0]&&r[0].day===t?r[0].count+=e.displayedHiddenErrorCount:r.unshift({day:t,count:e.displayedHiddenErrorCount}),r.length=Math.min(r.length,62),this._storageController.updateStatistics({hiddenErrors:r})}_getIgnoredErrorsStats(e){const{ignoredRules:t}=this._storageController.getSettings(),r=Dictionary.get(),i=[],o=[];return e.forEach(e=>{e.isSpellingError&&LTAssistant._isErrorIgnoredByDictionary(e,r)&&!i.includes(e.originalPhrase)&&i.push(e.originalPhrase),e.isSpellingError||!LTAssistant._isErrorRuleIgnored(e,t)||o.includes(e.rule.id)||o.push(e.rule.id)}),{byDictionary:i.length,byRules:o.length}}_checkExtensionHealth(){EnvironmentAdapter.isRuntimeConnected()||(this._isConnected=!1,this._hideAllErrorCards(),this._editors.forEach(e=>{e.highlighter&&e.highlighter.destroy(),this._updateState(e)}),window.clearInterval(this._checkExtensionHealthIntervalId))}destroy(){Array.from(this._editors).forEach(e=>this._destroyEditor(e)),this._spellcheckingAttributesData.forEach((e,t)=>{this._enableOtherSpellCheckers(t)}),this._tweaks&&document.removeEventListener(this._tweaks.getClickEvent(),this._onDocumentClick,!0),document.removeEventListener("focus",this._onDocumentFocus,!0),document.removeEventListener("mousemove",this._onDocumentMousemove,!0),document.removeEventListener("focusout",this._onDocumentFocusout,!0),window.frameElement&&window.frameElement.ownerDocument&&window.frameElement.ownerDocument.removeEventListener("click",this._onDocumentClick,!0),document.removeEventListener(InputAreaWrapper.eventNames.dblclick,this._onInputDblClick),document.removeEventListener(InputAreaWrapper.eventNames.textChanged,this._onInputTextChanged),document.removeEventListener(InputAreaWrapper.eventNames.scroll,this._onInputScroll),document.removeEventListener(Highlighter.eventNames.blockClicked,this._onHiglighterBlockClicked),document.removeEventListener(Toolbar.eventNames.permissionRequiredIconClicked,this._onToolbarPermissionRequiredIconClicked),document.removeEventListener(Toolbar.eventNames.toggleDialog,this._onToolbarToggleDialog),document.removeEventListener(Toolbar.eventNames.notifyAboutPremiumIcon,this._onToolbarNotifyAboutPremiumIcon),document.removeEventListener(Toolbar.eventNames.turnOff,this._onToolbarTurnOffClicked),document.removeEventListener(Dialog.eventNames.enableHere,this._onDialogEnableHere),document.removeEventListener(Dialog.eventNames.enableEverywhere,this._onDialogEnableEverywhere),document.removeEventListener(Dialog.eventNames.languageChanged,this._onDialogLanguageChanged),document.removeEventListener(Dialog.eventNames.errorSelected,this._onDialogErrorSelected),document.removeEventListener(Dialog.eventNames.errorHighlighted,this._onDialogErrorHighlighted),document.removeEventListener(Dialog.eventNames.addToDictionaryClicked,this._onAddToDictionary),document.removeEventListener(Dialog.eventNames.ignoreRuleClicked,this._onIgnoreRule),document.removeEventListener(Dialog.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.removeEventListener(Dialog.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.removeEventListener(Dialog.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.removeEventListener(Dialog.eventNames.fixSelected,this._onFixSelected),document.removeEventListener(Dialog.eventNames.openOptions,this._onDialogOpenOptions),document.removeEventListener(Dialog.eventNames.showFeedbackForm,this._onDialogShowFeedbackForm),document.removeEventListener(Dialog.eventNames.destroyed,this._onDialogDestroyed),document.removeEventListener(ErrorCard.eventNames.addToDictionaryClicked,this._onAddToDictionary),document.removeEventListener(ErrorCard.eventNames.ignoreRuleClicked,this._onIgnoreRule),document.removeEventListener(ErrorCard.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.removeEventListener(ErrorCard.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.removeEventListener(ErrorCard.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.removeEventListener(ErrorCard.eventNames.fixSelected,this._onFixSelected),document.removeEventListener(ErrorCard.eventNames.badgeClicked,this._onBadgeClicked),document.removeEventListener(ErrorCard.eventNames.logoClicked,this._onLogoClicked),document.removeEventListener(ErrorCard.eventNames.languageChanged,this._onErrorCardLanguageChanged),document.removeEventListener(ErrorCard.eventNames.destroyed,this._onErrorCardDestroyed),document.removeEventListener(SynonymsCard.eventNames.badgeClicked,this._onBadgeClicked),document.removeEventListener(SynonymsCard.eventNames.logoClicked,this._onLogoClicked),document.removeEventListener(SynonymsCard.eventNames.synonymSelected,this._onSynonymSelected),document.removeEventListener(SynonymsCard.eventNames.destroyed,this._onSynonymsCardDestroyed),document.removeEventListener(LTAssistant.events.DESTROY,this.destroy),window.removeEventListener("pageshow",this._onPageLoaded),window.removeEventListener("pagehide",this._onPageHide),this._storageController&&this._storageController.destroy(),this._tweaks&&this._tweaks.destroy(),window.clearInterval(this._checkExtensionHealthIntervalId),window.clearInterval(this._fixTinyMCEIntervalId),this._editors.forEach(e=>{e.validationDebounce.cancelCall()}),this._options&&this._options.onDestroy&&this._options.onDestroy()}_onPageLoaded(){let e=!0;const t=this._tweaks.beta();let r=!0,i=!0,o="";if(this._tweaks.supported())if(this._storageController.isDomainSupported(getCurrentDomain())){const t=this._getValidationSettings();e=!t.isDomainDisabled&&!t.isEditorGroupDisabled,r=t.shouldCapitalizationBeChecked}else i=!1,o=browser.i18n.getMessage("siteCannotBeSupported");else i=!1,o=this._tweaks.unsupportedMessage();EnvironmentAdapter.pageLoaded(e,r,i,t,o)}_onPageHide(){this._editors.forEach(e=>{this._savePremiumErrorCount(e),this._trackEditor(e)})}_onDocumentFocus(e){this._options.ignoreFocus||(e.target instanceof HTMLElement?this._initElement(e.target,!0):e.target===document&&document.body&&hasFirefoxDesignMode(document.body)&&this._initElement(document.body,!0))}_onDocumentMousemove(e){const t=this._editors.find(e=>e.isUserTyping);t&&this._endTypingModeAndUpdateState(t)}_onDocumentFocusout(e){const t=this._editors.find(e=>e.isUserTyping);t&&this._endTypingModeAndUpdateState(t)}_onDocumentClick(e){if(this._tweaks.isClickIgnored(e))return;closestElement(e.target,ErrorCard.CONTAINER_ELEMENT_NAME)||this._hideAllErrorCards(),closestElement(e.target,SynonymsCard.CONTAINER_ELEMENT_NAME)||this._hideAllSynonymsCards(),closestElement(e.target,`${Dialog.CONTAINER_ELEMENT_NAME}, ${Toolbar.CONTAINER_ELEMENT_NAME}`)||this._hideAllDialogs()}_onInputDblClick(e){const{hasSynonymsEnabled:t}=this._storageController.getSettings();if(!t||this._storageController.isUsedCustomServer())return;const r=this._editors.find(t=>t.inputAreaWrapper===e.detail.inputAreaWrapper);if(!r)return;const i=e.detail.selection,o=LTAssistant._getWordContext(r.inputAreaWrapper.getText(),i.start,i.end||i.start),n=o.word.trim(),a=/\s/.test(n),s=/[\!\?\.\,\:\;\"\'\`\´\—\)\(\[\]\+\#\&\*\@\$\§\/\\_\}\{\<\>]/.test(n),d=/^\d+$/.test(n);!n||a||s||d||this._showSynonymsCard(r,e.detail.clickedRectangles,o)}_onInputTextChanged(e){this._hideAllErrorCards(),this._hideAllSynonymsCards();const t=this._editors.find(t=>t.inputAreaWrapper===e.detail.inputAreaWrapper);if(t){if(this._startTypingMode(t),this._validateEditor(t,e.detail.text,!0))this._endTypingMode(t),this._updateDisplayedErrors(t);else{const r=LTAssistant._adjustErrors(t.validatedText,e.detail.text,t.errors);this._updateDisplayedErrors(t,r)}this._highlight(t),this._updateState(t)}}_onInputScroll(){window.requestAnimationFrame(()=>{this._hideAllErrorCards(),this._hideAllSynonymsCards()})}_onHiglighterBlockClicked(e){if(-1===e.detail.blockId)return;this._hideAllErrorCards(),this._hideAllSynonymsCards(),this._hideAllDialogs();const t=this._editors.find(t=>t.highlighter===e.detail.highlighter);if(!t)return;const r=t.displayedErrors.find(t=>t.id===e.detail.blockId);r&&t.temporaryDisabledErrorId!==r.id&&EnvironmentAdapter.isRuntimeConnected()&&(getSelectedText().trim()||(t.selectedErrorId=r.id,this._showErrorCard(t,r,e.detail.clickedBox),this._highlight(t)))}_onToolbarPermissionRequiredIconClicked(){window.open(config.INSTALL_URL),Tracker.trackEvent("Action","toolbar:open_install_url")}_onToolbarToggleDialog(e){const t=this._editors.find(t=>t.toolbar===e.detail.toolbar);if(!t)return;const r=!t.dialog;this._hideAllErrorCards(),this._hideAllSynonymsCards(),this._hideAllDialogs(),r&&this._showDialog(t)}_onToolbarNotifyAboutPremiumIcon(e){const t=this._editors.find(t=>t.toolbar===e.detail.toolbar);t&&t.language&&(t.tracking.sawPremiumIcon=!0)}_onToolbarTurnOffClicked(e){const t=getMainPageDomain();this._storageController.disableEditorGroup(t,this._tweaks.getEditorGroupId(getCurrentUrl())),EnvironmentAdapter.ltAssistantStatusChanged({enabled:!1}),Tracker.trackEvent("Action","check_trigger:turn_off")}_onDialogEnableHere(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);t&&(this._enableEditor(t),Tracker.trackEvent("Action","check_trigger:manually_triggered"))}_onDialogEnableEverywhere(e){this._storageController.updateSettings({autoCheck:!0,ignoreCheckOnDomains:[]}),Tracker.trackEvent("Action","enable_everywhere")}_onDialogLanguageChanged(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);t&&this._setLanguage(t,e.detail.language)}_onErrorCardLanguageChanged(e){const t=this._editors.find(t=>t.errorCard===e.detail.errorCard);t&&this._setLanguage(t,e.detail.language)}_onDialogErrorHighlighted(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);if(!t)return;const r=t.displayedErrors.find(t=>t.id===e.detail.errorId);r&&(t.selectedErrorId=r.id,this._highlight(t))}_onDialogErrorSelected(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);if(!t)return;const r=t.displayedErrors.find(t=>t.id===e.detail.errorId);r&&(this._hideAllDialogs(),t.inputAreaWrapper.scrollToText(r.offset,r.length,300,()=>{const e=t.highlighter.getTextBoxes(r.id);t.selectedErrorId=r.id,this._highlight(t),e.length&&this._showErrorCard(t,r,e[0])}))}_onAddToDictionary(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._editors.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._editors.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,i=r.originalPhrase;let o=!1;this._options.onDictionaryAdd&&(o=this._options.onDictionaryAdd(i,t.inputArea)),t.callbacks.onDictionaryAdd&&(o=t.callbacks.onDictionaryAdd(i)),o||Dictionary.add(r.originalPhrase);const n=LanguageManager.getPrimaryLanguageCode(r.language.code);(n.startsWith("de")||n.startsWith("en"))&&("de"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: de: ${r.contextPhrase}`):"del"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: del: ${r.contextPhrase}`):"air"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: air: ${r.contextPhrase}`):"click"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: click: ${r.contextPhrase}`):"school"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: school: ${r.contextPhrase}`):"un"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: un: ${r.contextPhrase}`):"eco"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: eco: ${r.contextPhrase}`):"geo"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: geo: ${r.contextPhrase}`):"et"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: et: ${r.contextPhrase}`):"and"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: and: ${r.contextPhrase}`):"el"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: el: ${r.contextPhrase}`):"of"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: of: ${r.contextPhrase}`):"for"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: for: ${r.contextPhrase}`):"the"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: the: ${r.contextPhrase}`):"pre"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: pre: ${r.contextPhrase}`):"black"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: black: ${r.contextPhrase}`):"connect"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: connect: ${r.contextPhrase}`):"day"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: day: ${r.contextPhrase}`):"advanced"===r.originalPhrase.toLowerCase()?Tracker.trackEvent("Debug",`${n}: advanced: ${r.contextPhrase}`):"big"===r.originalPhrase.toLowerCase()&&Tracker.trackEvent("Debug",`${n}: big: ${r.contextPhrase}`)),Tracker.trackDictionaryEvent(n,r.originalPhrase,!1),Tracker.trackEvent("Action",`${n}:add_word_to_dict`)}_onIgnoreRule(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._editors.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._editors.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,i=LanguageManager.getPrimaryLanguageCode(r.language.code),o={id:r.rule.id,language:i,description:r.rule.description,turnOffDate:new Date};let n=!1;if(this._options.onRuleIgnore&&(n=this._options.onRuleIgnore(o,t.inputArea)),t.callbacks.onRuleIgnore&&(n=t.callbacks.onRuleIgnore(o)),!n){const e=this._storageController.getSettings().ignoredRules;e.push(o),this._storageController.updateSettings({ignoredRules:e})}Tracker.trackDisabledRule(i,r.rule.id,`[${r.rule.subId||"0"}] ${r.contextPhrase}`,r.rule.isPremium),"errorCard"in e.detail&&Tracker.trackEvent("Action",`${i}:disable_rule`,r.rule.id)}_onTemporarilyIgnoreWord(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._editors.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._editors.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error;t.callbacks.onTemporaryDictionaryAdd&&t.callbacks.onTemporaryDictionaryAdd(r.originalPhrase),this._temporarilyIgnoreWord(t,r.originalPhrase);const i=LanguageManager.getPrimaryLanguageCode(r.language.code);Tracker.trackDictionaryEvent(i,r.originalPhrase,!0),Tracker.trackEvent("Action",`${i}:temp_ignore_word`)}_temporarilyIgnoreWord(e,t){const r=e.groupId;if(this._tweaks.storeTemporaryIgnoredItems()){const e=`ignored:${r}`,i=LocalStorageWrapper.get(e)||{words:[],rules:[]};i.words.push(t),LocalStorageWrapper.set(e,i)}this._editors.filter(e=>e.groupId===r).forEach(e=>{e.ignoredWords.push(t),this._updateDisplayedErrors(e),this._highlight(e),this._updateState(e)})}_onTemporarilyIgnoreRule(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._editors.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._editors.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,i=t.groupId,o=LanguageManager.getPrimaryLanguageCode(r.language.code),n={id:r.rule.id,phrase:r.originalPhrase,language:o};if(this._tweaks.storeTemporaryIgnoredItems()){const e=`ignored:${i}`,t=LocalStorageWrapper.get(e)||{words:[],rules:[]};t.rules.push(n),LocalStorageWrapper.set(e,t)}const a=this._editors.filter(e=>e.groupId===i);t.callbacks.onTemporaryRuleIgnore&&t.callbacks.onTemporaryRuleIgnore(n),a.forEach(e=>this._temporarilyIgnoreRule(e,n)),Tracker.trackDisabledRule(o,r.rule.id,`[${r.rule.subId||"0"}] ${r.contextPhrase}`,r.rule.isPremium),"errorCard"in e.detail&&Tracker.trackEvent("Action",`${o}:temp_disable_rule`,r.rule.id)}_temporarilyIgnoreRule(e,t){e.ignoredRules.push(t),this._updateDisplayedErrors(e),this._highlight(e),this._updateState(e)}_onMoreDetailsClicked(e){window.open(e.detail.url,"_blank"),Tracker.trackEvent("Action","show_rule_details",e.detail.url)}_onFixSelected(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._editors.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._editors.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,i=r.fixes[e.detail.fixIndex],o=i.value,n={offset:{start:r.offset,length:r.length},replacementText:o,editor:t};this._tweaks.applyFix(n),wait(100).then(()=>this._validateEditor(t));const{appliedSuggestions:a}=this._storageController.getStatistics();this._storageController.updateStatistics({appliedSuggestions:a+1}),"errorCard"in e.detail&&Tracker.trackEvent("Action",`${LanguageManager.getPrimaryLanguageCode(e.detail.error.language.code)}:apply_rule`,e.detail.error.rule.id),"Translation"===i.type&&Tracker.trackEvent("Stat",`${LanguageManager.getPrimaryLanguageCode(e.detail.error.language.code)}:apply_translation`)}_onDialogOpenOptions(e){EnvironmentAdapter.openOptionsPage(e.detail.target,e.detail.ref)}_onDialogShowFeedbackForm(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);if(!t)return;const r=t.inputArea.cloneNode(!1);try{r.innerText=`${t.inputAreaWrapper.getText().length} chars, ${t.language?t.language.code:"unknown lang"}`}catch(e){}EnvironmentAdapter.openFeedbackForm(getCurrentUrl(),"",r.outerHTML||"")}_onDialogDestroyed(e){const t=this._editors.find(t=>t.dialog===e.detail.dialog);t&&(t.dialog=null,null===t.errorCard&&null!==t.selectedErrorId&&(t.selectedErrorId=null,this._highlight(t)))}_onBadgeClicked(){this._hideAllErrorCards(),this._hideAllSynonymsCards();let e=!1;this._options.onPremiumTeaserClick&&(e=this._options.onPremiumTeaserClick()),e||EnvironmentAdapter.openOptionsPage(void 0,"errorcard"),Tracker.trackEvent("Action","check_trigger:badge:clicked",String(`premium:${this._storageController.getUIState().hasPaidSubscription}`))}_onLogoClicked(){this._hideAllErrorCards(),this._hideAllSynonymsCards(),window.open("https://languagetoolplus.com/?pk_campaign=addon2-errorcard-logo","_blank"),Tracker.trackEvent("Action","check_trigger:logo:clicked",String(`premium:${this._storageController.getUIState().hasPaidSubscription}`))}_onErrorCardDestroyed(e){const t=this._editors.find(t=>t.errorCard===e.detail.errorCard);t&&(t.errorCard=null,t.selectedErrorId===e.detail.error.id&&(t.temporaryDisabledErrorId=t.selectedErrorId,window.setTimeout(()=>t.temporaryDisabledErrorId=null,500),t.selectedErrorId=null,this._highlight(t)))}_onSynonymSelected(e){const t=this._editors.find(t=>t.synonymsCard===e.detail.synonymsCard);if(this._hideAllSynonymsCards(),!t)return;const r=e.detail.word,i=r.replace(r.trim(),e.detail.synonym),o=e.detail.selection.end||e.detail.selection.start;this._tweaks.applyFix({editor:t,replacementText:i,offset:{start:e.detail.selection.start,length:o-e.detail.selection.start}}),this._temporarilyIgnoreWord(t,e.detail.synonym),wait(100).then(()=>t.validationDebounce.callImmediately());const{appliedSynonyms:n}=this._storageController.getStatistics();this._storageController.updateStatistics({appliedSynonyms:n+1}),Tracker.trackEvent("Action","synonyms:applied")}_onSynonymsCardDestroyed(e){const t=this._editors.find(t=>t.synonymsCard===e.detail.synonymsCard);t&&(t.synonymsCard=null,this._highlight(t))}_onSettingsChanged(e){if(e.dictionary||e.ignoredRules)for(const e of this._editors)this._updateDisplayedErrors(e),this._highlight(e),this._updateState(e);if(e.disabledDomainsCapitalization&&this._editors.forEach(e=>{this._resetEditor(e),this._endTypingMode(e),this._validateEditor(e),this._highlight(e),this._updateState(e)}),e.autoCheck||e.autoCheckOnDomains||e.disabledDomains||e.ignoreCheckOnDomains||e.disabledEditorGroups){const e=this._getValidationSettings();if(e.isDomainDisabled||e.isEditorGroupDisabled){Array.from(this._editors).forEach(e=>this._destroyEditor(e))}else e.isAutoCheckEnabled?this._editors.filter(e=>!e.isAutoCheckEnabled).forEach(e=>this._enableEditor(e)):e.isAutoCheckEnabled||(this._hideAllDialogs(),this._editors.forEach(e=>this._disableEditor(e)))}}_onPrivacySettingsChanged(e){e.allowRemoteCheck&&e.allowRemoteCheck.newValue&&(this._isRemoteCheckAllowed=!0,this._editors.forEach(e=>{this._validateEditor(e),this._updateState(e)}))}_onUiStateChanged(e){e.hasPaidSubscription&&this._editors.forEach(e=>{this._resetEditor(e),this._validateEditor(e),this._updateState(e)})}}LTAssistant.events={UPDATE:"_lt-state-updated",DESTROY:"_lt-destroy"},LTAssistant.PUNCTIUATION_CHAR_REGEXP=/^[.!?]$/,LTAssistant.COMPLETED_SENTENCE_REGEXP=/^[^\n]*?[.!?]($|\s)/,LTAssistant.NO_LETTERS_REGEXP=/^[0-9,\.\-\:\;\+\*\/\\\%#\=\_]+$/;