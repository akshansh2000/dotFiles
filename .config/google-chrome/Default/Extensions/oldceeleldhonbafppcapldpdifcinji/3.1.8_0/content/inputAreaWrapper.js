/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class InputAreaWrapper{constructor(e,t,n,r=Number.MAX_SAFE_INTEGER){this._inputAreaObserver=null,this._scrollToInterval=null,this._lastKey=null,this._inputArea=e,this._ceElement=t,this._tweaks=n,this._textLengthThreshold=r,this._ceElementInspector=new CEElementInspector(t,n.getParsingDetector(e),!isFormElement(this._inputArea)),this._domMeasurement=new DomMeasurement(this._inputArea.ownerDocument),this._updateTextChunks(),this._currentText=this.getText(),this._scrollToInterval=null,this._onScroll=bindAndCatch(this._onScroll,this),this._onBlur=bindAndCatch(this._onBlur,this),this._onPaste=bindAndCatch(this._onPaste,this),this._onDblClick=bindAndCatch(this._onDblClick,this),this._onInput=bindAndCatch(this._onInput,this),this._onKeyUp=bindAndCatch(this._onKeyUp,this),this._inputArea.addEventListener("scroll",this._onScroll),"BODY"===this._inputArea.nodeName&&window.addEventListener("scroll",this._onScroll),this._inputArea.addEventListener("blur",this._onBlur),this._inputArea.addEventListener("paste",this._onPaste),this._inputArea.addEventListener("dblclick",this._onDblClick),this._inputArea.addEventListener("keyup",this._onKeyUp),this._scrollTop=this._inputArea.scrollTop,this._scrollLeft=this._inputArea.scrollLeft,isFormElement(this._inputArea)||(this._inputAreaObserver=new MutationObserver(this._onInput),this._inputAreaObserver.observe(this._inputArea,InputAreaWrapper.INPUT_AREA_OBSERVER_CONFIG)),this._ceElement.addEventListener(Mirror.eventNames.input,this._onInput)}static _offsetInRawText(e,t){t=Math.min(e.length,t);let n=-1;for(const t of InputAreaWrapper.ZWC){const r=e.indexOf(t);-1!==r&&(n=-1===n?r:Math.min(n,r))}if(-1===n||t<n)return t;let r=n,s=n;do{if(InputAreaWrapper.ZWC.includes(e[r])||s++,s>t)break;r++}while(r<e.length);return r}static _offsetInParsedText(e,t){let n=0;for(let r=0;r<Math.min(e.length,t);r++)InputAreaWrapper.ZWC.includes(e[r])&&n++;return t-n}static _selectText(e,t=0,n=e.nodeValue.length){t=Math.max(t,0),n=Math.min(n,e.nodeValue.length);const r=window.getSelection();r.empty();const s=new Range;s.setStart(e,t),s.setEnd(e,n),r.addRange(s)}static _simulateSelection(e){const t=window.getSelection();t.empty();const n=new Range;n.setStart(e,0),n.collapse(),t.addRange(n);const r=new MouseEvent("mousedown",{bubbles:!0,cancelable:!1}),s=new MouseEvent("mouseup",{bubbles:!0,cancelable:!1});e.dispatchEvent(r),e.dispatchEvent(s)}_updateTextChunks(){const e=new DOMWalker(this._ceElement),t=[];let n=0;do{const r=e.node();let s=!1,i="";if(isElementNode(r)){if(this._ceElementInspector.isSkippingElement(r)){e.next(!0);continue}this._ceElementInspector.isBr(r)&&(i="\n")}else isTextNode(r)&&(s=!0,(i=this._ceElementInspector.getParsedText(r))&&this._ceElementInspector.isLastTextInParagraph(r)&&this._ceElementInspector.isParagraphEndsWithLineBreak(r)&&(i+="\n\n"));if(t.push({node:r,isTextNode:s,textOffset:n,parsedText:i,rawText:s?r.nodeValue:""}),(n+=i.length)>this._textLengthThreshold)break;e.next()}while(e.node());this._textChunks=t}_getTextPosition(e){for(const{node:t,isTextNode:n,parsedText:r,rawText:s}of this._textChunks){if(n&&e<=r.length)return{textNode:t,offset:InputAreaWrapper._offsetInRawText(s,e)};e-=r.length}return null}_getTextOffset(e,t){let n=0;for(const t of this._textChunks){if(t.node===e)break;n+=t.parsedText.length}return n+InputAreaWrapper._offsetInParsedText(e.nodeValue||"",t)}_hasSpaceBefore(e){if(e<=0)return!1;if(isFormElement(this._inputArea)){const t=this._inputArea.value,n=InputAreaWrapper._offsetInRawText(t,e-1),r=InputAreaWrapper._offsetInRawText(t,e);return InputAreaWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(t.substring(n,r))}{const t=this.getTextRanges(e-1,1)[0];return Boolean(t&&t.textNode.nodeValue&&InputAreaWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(t.textNode.nodeValue.substring(t.start,t.end)))}}_hasSpaceAfter(e){if(isFormElement(this._inputArea)){const t=this._inputArea.value,n=InputAreaWrapper._offsetInRawText(t,e),r=InputAreaWrapper._offsetInRawText(t,e+1);return InputAreaWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(t.substring(n,r))}{const t=this.getTextRanges(e,1)[0];return Boolean(t&&t.textNode.nodeValue&&InputAreaWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(t.textNode.nodeValue.substring(t.start,t.end)))}}_applyReplacement(e,t=!0){let n=Promise.resolve();return t&&(n=n.then(()=>InputAreaWrapper._simulateSelection(e.textNode.parentNode)).then(()=>wait())),n=n.then(()=>{const t=InputAreaWrapper._offsetInRawText(e.textNode.nodeValue,e.offset),n=InputAreaWrapper._offsetInRawText(e.textNode.nodeValue,e.offset+e.length);return InputAreaWrapper._selectText(e.textNode,t,n),wait(0)}).then(()=>{if(isTrixEditor(this._inputArea)&&BrowserDetector.isFirefox())return;const t=new window.InputEvent("beforeinput",{bubbles:!0,cancelable:!1,inputType:"insertText",data:e.replacementText});return this._inputArea.dispatchEvent(t),document.execCommand("insertText",!1,e.replacementText)}),BrowserDetector.isFirefox()&&(e.replacementText.includes(InputAreaWrapper.NBSP)||isTrixEditor(this._inputArea))&&(n=n.then(()=>{const t=new window.InputEvent("beforeinput",{bubbles:!0,cancelable:!1,inputType:"insertText",data:e.replacementText});this._inputArea.dispatchEvent(t),e.textNode.nodeValue=e.newText,this.simulateInput(e.replacementText)})),n}_onScroll(){let e=0,t=0;if("BODY"===this._inputArea.nodeName?(e=document.body&&document.body.scrollTop||document.documentElement&&document.documentElement.scrollTop||0,t=document.body&&document.body.scrollLeft||document.documentElement&&document.documentElement.scrollLeft||0):(e=this._inputArea.scrollTop,t=this._inputArea.scrollLeft),this._scrollTop===e&&this._scrollLeft===t)return;this._scrollTop=e,this._scrollLeft=t;const n={inputAreaWrapper:this};dispatchCustomEvent(document,InputAreaWrapper.eventNames.scroll,n)}_onPaste(){const e={inputAreaWrapper:this};dispatchCustomEvent(document,InputAreaWrapper.eventNames.paste,e)}_onBlur(){const e={inputAreaWrapper:this};dispatchCustomEvent(document,InputAreaWrapper.eventNames.blur,e)}_onKeyUp(e){if(Math.random()>.01)return;const t=BrowserDetector.getOS();if("ArrowDown"===e.key&&e.altKey&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey)return void Tracker.trackEvent("Stat",`key:${t}:alt_arrow_down`);if("ArrowDown"===e.key&&e.altKey&&e.ctrlKey&&!e.shiftKey&&!e.metaKey)return void Tracker.trackEvent("Stat",`key:${t}:alt_ctrl_arrow_down`);if("ArrowDown"===e.key&&e.shiftKey&&e.altKey&&!e.ctrlKey&&!e.metaKey)return void Tracker.trackEvent("Stat",`key:${t}:shift_alt_arrow_down`);if("Shift"===e.key&&e.ctrlKey&&!e.ctrlKey&&!e.metaKey)return void Tracker.trackEvent("Stat",`key:${t}:ctrl_shift`);if("Alt"===e.key&&e.ctrlKey&&!e.shiftKey&&!e.metaKey)return void Tracker.trackEvent("Stat",`key:${t}:alt_control`);let n=null;if("Control"!==e.key||e.altKey||e.shiftKey||e.metaKey?"Alt"!==e.key||e.ctrlKey||e.shiftKey||e.metaKey||(n="alt"):n="ctrl",!n)return void(this._lastKey=null);const r=Date.now();this._lastKey?r-this._lastKey.timestamp>400||this._lastKey.key!==n?this._lastKey={key:n,timestamp:r}:Tracker.trackEvent("Stat",`key:${t}:double_${n}`):this._lastKey={key:n,timestamp:r}}_onDblClick(e){const t=this._tweaks.getSelectedText().replace(InputAreaWrapper.ZWC_REGEXP,""),n=this.getSelection();if(!t||!n)return;const r=n.end||n.start,s=this.getTextRanges(n.start,r-n.start);if(!s.length)return;this._domMeasurement.clearCache();const i=this._domMeasurement.getTextBoundingBoxes(s,this._ceElement),a=this._domMeasurement.getTextBoundingBoxes(s,this._ceElement,!1);if(!i.length)return;if(!a.some(t=>isPointInsideRect(t,e.clientX,e.clientY)))return;const o={inputAreaWrapper:this,selectedText:t,selection:n,clickedRectangles:i};dispatchCustomEvent(document,InputAreaWrapper.eventNames.dblclick,o)}_onInput(){this._updateTextChunks();const e=this.getText();if(this._currentText===e)return;const t={inputAreaWrapper:this,previousText:this._currentText,text:e};this._currentText=e,dispatchCustomEvent(document,InputAreaWrapper.eventNames.textChanged,t)}getText(){return this._textChunks.map(e=>e.parsedText).join("")}getTextRanges(e,t){const n=[];for(let r=function(e,t){let n=0,r=e.length,s=0;for(;n<r;){s=n+Math.floor((r-n)/2);const i=e[n];if(i.textOffset<=t&&t<=i.textOffset+i.parsedText.length)return n;const a=e[s];a.textOffset+a.parsedText.length>=t?r=s:n=s+1}return n}(this._textChunks,e);r<this._textChunks.length;r++){const{node:s,isTextNode:i,textOffset:a,parsedText:o,rawText:l}=this._textChunks[r];if(!i)continue;const p=Math.max(e-a,0),u=InputAreaWrapper._offsetInRawText(l,p),h=InputAreaWrapper._offsetInRawText(l,p+t);if(n.push({textNode:s,start:u,end:h}),(t-=o.length-p)<=0)break}return n}replaceText(e,t,n){const r=e+n.length;if(""===n&&(this._hasSpaceBefore(e)||0===e)&&this._hasSpaceAfter(e+t)&&(e=Math.max(e-1,0),t+=1),!isFormElement(this._inputArea)){const s=Promise.resolve(),i=!(isTinyMCE(this._inputArea)||isGutenberg(this._inputArea)||isTrixEditor(this._inputArea)||isSlateEditor(this._inputArea)||isProseMirror(this._inputArea));return i&&s.then(()=>InputAreaWrapper._simulateSelection(this._inputArea)),s.then(()=>wait(50)).then(()=>{const s=[];for(const{node:r,isTextNode:i,parsedText:a}of this._textChunks){if(i&&e<a.length){let i=Math.min(a.length-e,n.length);e+t<=a.length&&(i=n.length);const o=a.substr(0,e)+n.substr(0,i)+a.substr(e+t);r.nodeValue!==o&&s.push({textNode:r,offset:e,length:t,replacementText:n.substr(0,i),newText:o}),t=Math.max(e+t-a.length,0),e=0,n=n.substr(i)}else e-=a.length;if(0===t&&""===n)break}s.reverse().reduce((e,t)=>e.then(()=>this._applyReplacement(t,i)),Promise.resolve()).then(()=>{this.setSelection({start:r})}).then(()=>this.simulateChange())})}{this.setSelection({start:e,end:e+t});const s=document.execCommand("insertText",!1,n),i=BrowserDetector.isFirefox()&&n.includes(InputAreaWrapper.NBSP);if(s){if(i){const t=this._inputArea.value,r=InputAreaWrapper._offsetInRawText(t,e),s=InputAreaWrapper._offsetInRawText(t,e+n.length),i=t.substring(0,r)+n+t.substring(s);this._inputArea.value=i}}else{const r=this._inputArea.value,s=InputAreaWrapper._offsetInRawText(r,e),i=InputAreaWrapper._offsetInRawText(r,e+t),a=r.substring(0,s)+n+r.substring(i);this._inputArea.value=a}this.setSelection({start:r}),s||this.simulateInput(n)}return Promise.resolve()}simulateInput(e=""){const t=new window.InputEvent("input",{bubbles:!0,cancelable:!1,inputType:"insertText",data:e});this._inputArea.dispatchEvent(t)}simulateChange(){const e=new Event("change",{bubbles:!0,cancelable:!1});this._inputArea.dispatchEvent(e)}getSelection(){if(isFormElement(this._inputArea)){if(this._inputArea!==document.activeElement)return null;return{start:InputAreaWrapper._offsetInParsedText(this._inputArea.value,this._inputArea.selectionStart),end:InputAreaWrapper._offsetInParsedText(this._inputArea.value,this._inputArea.selectionEnd)}}{const e=this._tweaks.getSelection();if(!e||!e.startNode)return null;if(!this._inputArea.contains(e.startNode))return null;const t=this._getTextOffset(e.startNode,e.startOffset);return{start:t,end:e.isCollapsed?t:this._getTextOffset(e.endNode,e.endOffset)}}}setSelection(e){if(void 0===e.end&&(e.end=e.start),this._inputArea.focus(),isFormElement(this._inputArea))this._inputArea.selectionStart=InputAreaWrapper._offsetInRawText(this._inputArea.value,e.start),this._inputArea.selectionEnd=InputAreaWrapper._offsetInRawText(this._inputArea.value,e.end);else{const t=this._getTextPosition(e.start);if(!t)return;const n=window.getSelection();n.removeAllRanges();const r=new Range;if(r.setStart(t.textNode,t.offset),e.start!==e.end){const t=this._getTextPosition(e.end);if(!t)return;r.setEnd(t.textNode,t.offset)}else r.collapse();n.addRange(r)}}resetText(){if(isFormElement(this._inputArea)){const e=this._inputArea.value;this._inputArea.value="",this._inputArea.value=e}else{this._inputAreaObserver.disconnect();const e=new DOMWalker(this._inputArea);do{const t=e.node();t.nodeType===document.TEXT_NODE&&(t.textContent=t.textContent)}while(e.next());this._inputAreaObserver.observe(this._inputArea,InputAreaWrapper.INPUT_AREA_OBSERVER_CONFIG)}}scrollToText(e,t,n=300,r){function s(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t}if(this._domMeasurement.clearCache(),isFormElement(this._inputArea)){this._scrollToInterval&&(this._scrollToInterval.destroy(),this._scrollToInterval=null);const i=this._inputArea.scrollTop,a=this._inputArea.scrollLeft,o=this.getTextRanges(e,t),l=this._domMeasurement.getRelativeTextBoundingBox(o,this._ceElement),p=this._inputArea.getBoundingClientRect();let u=this._inputArea.scrollTop+l.top;p.top<0&&(u+=p.top);let h=this._inputArea.scrollLeft+l.left;p.left<0&&(h+=p.left);const c=u-i,_=h-a;let d=0;this._scrollToInterval=setAnimationFrameInterval(()=>{const e=s(d+=InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL,i,c,n),t=s(d,a,_,n);this._inputArea.scrollTop=e,this._inputArea.scrollLeft=t,d>=n&&(this._scrollToInterval&&(this._scrollToInterval.destroy(),this._scrollToInterval=null),r&&setTimeout(()=>r(),50))},InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL)}else{const t=this._getTextPosition(e);if(t&&t.textNode.parentElement){if(r){let e;const t=()=>{window.clearTimeout(e),e=window.setTimeout(()=>{n(),r()},200)},n=()=>{clearTimeout(a),window.clearTimeout(e),s.destroy(),i.forEach(e=>{e.removeEventListener("scroll",t,!0)})},s=observeScrollableAncestors(this._inputArea,t),i=[this._inputArea,window];i.forEach(e=>{e.addEventListener("scroll",t,!0)});const a=setTimeout(n,4e3);t()}t.textNode.parentElement.scrollIntoView({behavior:"smooth",block:"nearest"})}}}destroy(){this._inputArea.removeEventListener("scroll",this._onScroll),this._inputArea.removeEventListener("blur",this._onBlur),this._inputArea.removeEventListener("paste",this._onPaste),this._inputArea.removeEventListener("dblclick",this._onDblClick),this._inputArea.removeEventListener("keyup",this._onKeyUp),window.removeEventListener("scroll",this._onScroll),this._ceElement.removeEventListener(Mirror.eventNames.input,this._onInput),this._ceElementInspector.destroy(),this._scrollToInterval&&this._scrollToInterval.destroy(),this._inputAreaObserver&&this._inputAreaObserver.disconnect()}}InputAreaWrapper.eventNames={textChanged:"lt-inputAreaWrapper.textChanged",scroll:"lt-inputAreaWrapper.scroll",paste:"lt-inputAreaWrapper.paste",blur:"lt-inputAreaWrapper.blur",dblclick:"lt-inputAreaWrapper.dblclick"},InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL=20,InputAreaWrapper.NBSP=String.fromCharCode(160),InputAreaWrapper.ZWC=["​","‌","‍"],InputAreaWrapper.ZWC_REGEXP=new RegExp("["+InputAreaWrapper.ZWC.join("")+"]","g"),InputAreaWrapper.VISIBLE_WHITE_SPACE_REGEXP=/\u00A0|\u0020|\u2009/,InputAreaWrapper.INPUT_AREA_OBSERVER_CONFIG={attributes:!0,attributeOldValue:!1,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!0,attributeFilter:["id","class","style"]};