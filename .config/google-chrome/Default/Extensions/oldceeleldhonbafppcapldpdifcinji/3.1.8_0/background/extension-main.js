/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __awaiter=this&&this.__awaiter||function(e,t,a,s){return new(a||(a=Promise))(function(n,o){function r(e){try{c(s.next(e))}catch(e){o(e)}}function i(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(r,i)}c((s=s.apply(e,t||[])).next())})};class BackgroundApp{static _constructor(){if(!this._isInitialized){if(this._onDataLoaded=this._onDataLoaded.bind(this),this._onInstalled=this._onInstalled.bind(this),this._onMessage=this._onMessage.bind(this),this._onValidateClicked=this._onValidateClicked.bind(this),this._storageController=StorageController.create(),this._storageController.onReady(this._onDataLoaded),browser.runtime.onInstalled.addListener(this._onInstalled),browser.runtime.onMessage.addListener(this._onMessage),browser.contextMenus&&browser.contextMenus.removeAll().then(()=>{browser.contextMenus.create({title:i18nManager.getMessage("contextMenuValidate"),contexts:["selection"],onclick:this._onValidateClicked})}),DictionarySync.init(),this._updateIcon(),window.setInterval(()=>this._updateIcon(),config.UI_MODE_RECHECK_INTERVAL),this._checkForPaidSubscription(),window.setInterval(()=>this._checkForPaidSubscription(),config.ACCOUNT_STATUS_RECHECK_INTERVAL),this._loadConfiguration(),window.setInterval(()=>this._loadConfiguration(),config.EXTERNAL_CONFIG_RELOAD_INTERVAL),this._ping(),window.setInterval(()=>this._ping(),config.PING_INTERVAL),BrowserDetector.isFirefox()){const e=()=>{browser.runtime.onUpdateAvailable.removeListener(e),this._installUpdate()};browser.runtime.onUpdateAvailable.addListener(e)}this._isInitialized=!0}}static _installUpdate(){browser.tabs.query({}).then(e=>{e.forEach(e=>{if(!e.id)return;browser.tabs.sendMessage(e.id,{command:"DESTROY"}).catch(console.error.bind(console))})}),Tracker.trackEvent("Action","pre_update"),window.setTimeout(()=>{browser.runtime.reload()},2e3)}static _assignToTestGroups(){if(!EnvironmentAdapter.isProductionEnvironment())return;const{languageDetectionTest:e}=this._storageController.getTestFlags();null===e&&this._storageController.updateTestFlags({languageDetectionTest:Math.random()<.05?"test":"control"})}static _isUsedDarkTheme(){var e;return __awaiter(this,void 0,void 0,function*(){if(BrowserDetector.isFirefox()){const t=yield browser.theme.getCurrent();if(null===(e=null===t||void 0===t?void 0:t.colors)||void 0===e?void 0:e.toolbar){return getColorLuminosity(t.colors.toolbar)<=35}}else if("undefined"!=typeof window&&window.matchMedia)return Boolean(window.matchMedia("(prefers-color-scheme: dark)").matches);return!1})}static _updateIcon(){return __awaiter(this,void 0,void 0,function*(){const e=yield this._isUsedDarkTheme();this._darkMode!==e&&(this._darkMode=e,this._darkMode?browser.browserAction.setIcon({path:{16:"/assets/images/icons/icon16_white.png",32:"/assets/images/icons/icon32_white.png",48:"/assets/images/icons/icon48_white.png",64:"/assets/images/icons/icon64_white.png",128:"/assets/images/icons/icon128_white.png"}}):browser.browserAction.setIcon({path:{16:"/assets/images/icons/icon16.png",32:"/assets/images/icons/icon32.png",48:"/assets/images/icons/icon48.png",64:"/assets/images/icons/icon64.png",128:"/assets/images/icons/icon128.png"}}))})}static _updateBadge(e,t){browser.browserAction.setBadgeTextColor&&browser.browserAction.setBadgeTextColor({tabId:e,color:"#FFFFFF"}),t.enabled&&t.supported?t.capitalization?browser.browserAction.setBadgeText({tabId:e,text:""}):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#45A8FC"}),browser.browserAction.setBadgeText({tabId:e,text:BrowserDetector.isOpera()?"":"abc"})):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#F53987"}),browser.browserAction.setBadgeText({tabId:e,text:BrowserDetector.isOpera()?"":"OFF"}))}static _updateUninstallURL(e="unknown"){const t=this._storageController.getSettings(),a=this._storageController.getPrivacySettings(),s=this._storageController.getStatistics(),n=this._storageController.getTestFlags(),o=browser.runtime.getManifest(),r=o&&o.version||"unknown";e=e.replace("www.","").slice(0,25);let i=`${config.UNINSTALL_URL}?autoCheck=${t.autoCheck}`;i+=`&host=${encodeURIComponent(e)}&v=${r}&privacyConfirmed=${a.allowRemoteCheck}`,i+=`&usages=${s.usageCount}&sessions=${s.sessionCount}`;const c=this._storageController.getUniqueId();c&&(i+=`&matomo=${c}`);for(const e in n)n.hasOwnProperty(e)&&(i+=`&${e}=${n[e]}`);EnvironmentAdapter.isProductionEnvironment()||(i+="&dev"),i=i.slice(0,255),browser.runtime.setUninstallURL(i)}static _setMotherTongue(){this._storageController.onReady(()=>{const{motherTongue:e,geoIpLanguages:t}=this._storageController.getSettings();if(e)return;const a=t.some(e=>!!e.match(/^de/i))&&navigator.languages[0]&&navigator.languages[0].match(/^de/i),s=Array.from(navigator.languages).some(e=>!e.match(/^(de|en)/i));a&&!s&&(Tracker.trackEvent("Action","set_mother_tongue","de"),this._storageController.updateSettings({motherTongue:"de"}));const n=t.some(e=>!!e.match(/^fr/i))&&navigator.languages[0]&&navigator.languages[0].match(/^fr/i),o=Array.from(navigator.languages).some(e=>!e.match(/^(fr|en)/i));n&&!o&&(Tracker.trackEvent("Action","set_mother_tongue","fr"),this._storageController.updateSettings({motherTongue:"fr"}))})}static _launchValidator(e){const t=Math.round(99999*Math.random())+":"+Date.now();this._validatorsData[t]={id:t,text:e,timestamp:Date.now()},browser.tabs.create({url:EnvironmentAdapter.getURL(`/validator/validator.html?id=${t}`)})}static _onDataLoaded(){Tracker.trackActivity(),this._updateUninstallURL(),this._applyManagedSettings()}static _checkForChangelogPage(){const e=this._storageController.isReleventForChangelogCoupon();if(!e.status)return void Tracker.trackEvent("Action","changelog:dont_open_page",String(e.reason));const{lastChangelogSeen:t}=this._storageController.getUIState();t?Tracker.trackEvent("Action","changelog:dont_open_page","already_seen"):this._storageController.updateUIState({lastChangelogSeen:Date.now()}).then(()=>{this._openChangelogPage()})}static _openChangelogPage(){const e=browser.runtime.getURL("/changelog/changelog.html");browser.windows.getAll({windowTypes:["normal"]}).then(t=>{Tracker.trackEvent("Action","changelog:open_page",t.length?"existing-window":"empty-window");const a=(t||[]).find(e=>e.focused&&"normal"===e.type);a?browser.tabs.create({windowId:a.id,active:!1,url:e}):browser.tabs.create({active:!1,url:e})},()=>{Tracker.trackError("other","changelog:get_window_error")})}static _applyManagedSettings(){const{disablePrivacyConfirmation:e}=this._storageController.getManagedSettings();!0===e&&this._storageController.updatePrivacySettings({allowRemoteCheck:!0})}static _loadConfiguration(){this._storageController.onReady(()=>{this._storageController.isUsedCustomServer()||fetch(config.EXTERNAL_CONFIG_URL,{credentials:"omit"}).then(e=>e.json()).then(e=>{if(e.disabledSites&&Array.isArray(e.disabledSites)){const t={unsupportedDomains:e.disabledSites};this._storageController.updateConfiguration(t)}})})}static _checkForPaidSubscription(){this._storageController.onReady(()=>{this._storageController.checkForPaidSubscription().catch(e=>{Tracker.trackError("js",`Error checking paid subscripton: ${e&&e.message}`)})})}static _ping(){this._lastPing&&this._lastPing+config.PING_INTERVAL>Date.now()||(this._lastPing=Date.now(),this._storageController.onReady(()=>{if(this._storageController.isUsedCustomServer())return;const{username:e}=this._storageController.getSettings();if(!e)return;const t=new FormData;t.append("email",e),t.append("useragent",BrowserDetector.getUserAgentIdentifier()),fetch(config.PING_URL,{method:"POST",mode:"cors",credentials:"omit",body:t}).catch(()=>null)}))}static _onInstalled(e){const{reason:t,previousVersion:a}=e;this._storageController.onReady(()=>{if(this._applyManagedSettings(),"install"===t){if(!this._storageController.getPrivacySettings().allowRemoteCheck&&!this._storageController.getUIState().hasSeenPrivacyConfirmationDialog){this._storageController.updateUIState({hasSeenPrivacyConfirmationDialog:!0});let e=`${config.INSTALL_URL}?new`;EnvironmentAdapter.isProductionEnvironment()||(e+="&dev"),browser.tabs.create({url:e}),this._assignToTestGroups(),this._updateUninstallURL(),LanguageManager.getLanguagesForGeoIPCountry().then(e=>{const t=!!navigator.languages.filter(e=>!e.startsWith("en")).length;"US"!==e.geoIpCountry||e.geoIpLanguages.includes("es")||t||e.geoIpLanguages.push("es");const a={geoIpLanguages:e.geoIpLanguages,geoIpCountry:e.geoIpCountry||""};"GB"===e.geoIpCountry?a.enVariant="en-GB":"US"===e.geoIpCountry?a.enVariant="en-US":"CA"===e.geoIpCountry?a.enVariant="en-CA":"NZ"===e.geoIpCountry?a.enVariant="en-NZ":"AU"===e.geoIpCountry?a.enVariant="en-AU":"ZA"===e.geoIpCountry?a.enVariant="en-ZA":"DE"===e.geoIpCountry?a.deVariant="de-DE":"AT"===e.geoIpCountry?a.deVariant="de-AT":"CH"===e.geoIpCountry?a.deVariant="de-CH":"BR"===e.geoIpCountry?a.ptVariant="pt-BR":"PT"===e.geoIpCountry&&(a.ptVariant="pt-PT");const s="CA"===e.geoIpCountry,n=navigator.languages.some(e=>"en-ca"===e.toLowerCase()),o=navigator.languages.some(e=>"fr-ca"===e.toLowerCase());if(s||n||o){const e={id:"FRENCH_WHITESPACE",language:"fr",description:"Insertion des espaces fines insÃ©cables",turnOffDate:new Date},t=this._storageController.getSettings().ignoredRules;t.push(e),a.ignoredRules=t}this._storageController.updateSettings(a),this._setMotherTongue()}).catch(e=>{Tracker.trackError("js",e&&e.message)}),Tracker.trackInstall()}}else if("update"===t){this._assignToTestGroups(),this._updateUninstallURL();const e=browser.runtime.getManifest(),t=e&&e.version||"unknown";a!==t&&Tracker.trackEvent("Action","update",String(t))}})}static _onMessage(e,t,a){let s;return isPageLoadedMessage(e)?s=this._onPageLoadedMessage(t,e):isLTAssistantStatusChangedMessage(e)?s=this._onLTAssistantStatusChangedMessage(t,e):isCheckForPaidSubscriptionMessage(e)?s=this._onCheckForPaidSubscriptionMessage(t,e):isTrackTextLengthMessage(e)?s=this._onTrackTextLengthMessage(t,e):isTrackEventMessage(e)?s=this._onTrackEventMessage(t,e):isOpenFeedbackFormMessage(e)?s=this._onOpenFeedbackFormMessage(t,e):isSendFeedbackMessage(e)?s=this._onSendFeedbackMessage(t,e):isOpenOptionsMessage(e)?s=this._onOpenOptionsMessage(t,e):isOpenPrivacyConfirmationMessage(e)?s=this._onOpenPrivacyConfirmationMessage(t,e):isCloseCurrentTabMessage(e)?s=this._onCloseCurrentTabMessage(t,e):isValidateTextMessage(e)?s=this._onValidateTextMessage(t,e):isLaunchValidatorMessage(e)?s=this._onLaunchValidatorMessage(t,e):isGetValidatorDataMessage(e)?s=this._onGetValidatorDataMessage(t,e):isStartDictionarySyncMessage(e)?s=this._onStartDictionarySyncMessage(t,e):isAddWordToDictionaryMessage(e)?s=this._onAddWordToDictionaryMessage(t,e):isBatchAddWordToDictionaryMessage(e)?s=this._onBatchAddWordToDictionaryMessage(t,e):isRemoveWordFromDictionaryMessage(e)?s=this._onRemoveWordFromDictionaryMessage(t,e):isClearDictionaryMessage(e)?s=this._onClearDictionaryMessage(t,e):isGetPreferredLanguagesMessage(e)?s=this._onGetPreferredLanguagesMessage(t,e):isLoadSynonymsMessage(e)&&(s=this._onLoadSynonymsMessage(t,e)),s||Promise.resolve(null)}static _onPageLoadedMessage(e,t){if(0!==e.frameId||!e.tab)return;const a=e.tab.id,s={enabled:t.enabled,capitalization:t.capitalization,supported:t.supported,unsupportedMessage:t.unsupportedMessage,language:null,beta:t.beta};this._extensionStates[a]=s,browser.tabs.detectLanguage(a).then(e=>{e&&"und"!==e&&(s.language=LanguageManager.getPrimaryLanguageCode(e))}).catch(e=>{console.error("Error detecting language",e)}),this._updateUninstallURL(getDomain(e.tab.url)),this._updateBadge(a,s)}static _onLTAssistantStatusChangedMessage(e,t){const a=t.tabId||e.tab.id;if(!this._extensionStates.hasOwnProperty(a))return;const s=this._extensionStates[a];"boolean"==typeof t.enabled&&(s.enabled=t.enabled),"boolean"==typeof t.capitalization&&(s.capitalization=t.capitalization),this._updateBadge(a,s)}static _onCheckForPaidSubscriptionMessage(e,t){return Validator.checkForPaidSubscription(t.username,t.password,t.token).then(e=>{return{initialCommand:"CHECK_FOR_PAID_SUBSCRIPTION",isSuccessful:!0,hasPaidSubscription:e}}).catch(e=>{return{initialCommand:"CHECK_FOR_PAID_SUBSCRIPTION",isSuccessful:!1,error:{reason:e.reason,status:e.status,message:e.message,response:e.response,stack:e.stack}}})}static _onTrackTextLengthMessage(e,t){Tracker.trackTextLength(t.textLength)}static _onTrackEventMessage(e,t){Tracker.trackEvent("Action",t.action,t.label)}static _onOpenFeedbackFormMessage(e,t){this._lastScreenshot=null,(browser.tabs.captureVisibleTab?browser.tabs.captureVisibleTab(e.tab?e.tab.windowId:void 0):Promise.reject()).then(e=>{this._lastScreenshot=dataURItoBlob(e)}).catch(()=>null).then(()=>{let e=`/feedbackForm/feedbackForm.html?url=${encodeURIComponent(t.url.substr(0,200))}`;return t.html&&(e+=`&html=${encodeURIComponent(t.html.substr(0,400))}`),t.title&&(e+=`&title=${encodeURIComponent(t.title)}`),this._lastScreenshot&&(e+=`&screenshot=${this._lastScreenshot?1:0}`),browser.windows.create({url:EnvironmentAdapter.getURL(e),type:"popup",width:380,height:520})}).then(e=>{e&&e.id&&browser.windows.update(e.id,{left:Math.round((BrowserDetector.isChromium()&&e.left||0)+(screen.availWidth-380)/2),top:Math.round((BrowserDetector.isChromium()&&e.top||0)+(screen.availHeight-520)/2)})})}static _onSendFeedbackMessage(e,t){const a=new FormData;a.append("sender",t.sender),a.append("text",t.text),this._lastScreenshot&&t.includeScreenshot&&(a.append("screenshot",this._lastScreenshot,`screenshot_${Date.now()}.jpg`),this._lastScreenshot=null),fetch(config.FEEDBACK_SERVER_URL,{method:"POST",mode:"cors",credentials:"omit",body:a}).catch(()=>{Tracker.trackError("http","error_send_feedback")})}static _onOpenOptionsMessage(e,t){let a="/options/options.html";t.target&&(a+=`#${t.target}`),t.ref&&(a+=`?ref=${encodeURIComponent(t.ref)}`),browser.tabs.create({url:EnvironmentAdapter.getURL(a)})}static _onOpenPrivacyConfirmationMessage(e,t){browser.tabs.create({url:config.INSTALL_URL})}static _onCloseCurrentTabMessage(e,t){browser.tabs.query({currentWindow:!0,active:!0}).then(e=>{e.length&&browser.tabs.remove(e[0].id)})}static _getPreferredLanguages(e){const{geoIpLanguages:t,motherTongue:a}=this._storageController.getSettings();let s=[];if(a&&s.push(a),e.tab){const t=this._extensionStates[e.tab.id];t&&t.language&&s.push(t.language)}return(s=s.concat(LanguageManager.getUserLanguageCodes()).concat(t)).push("en"),s=s.map(e=>"nb"===e?"no":"fil"===e?"tl":e),uniq(s)}static _onValidateTextMessage(e,t){Tracker.trackActivity();const a=this._storageController.getMaxTextLength();if(t.text.length>=a){const e={initialCommand:"VALIDATE_TEXT",isSuccessful:!1,instanceId:t.metaData.instanceId,error:{status:400,message:i18nManager.getMessage("textTooLong"),response:"Text too long"}};return Promise.resolve(e)}0===this._validationThrottlingCount&&window.setTimeout(()=>{this._validationThrottlingCount=0},5e3),this._validationThrottlingCount++;const s=e.url&&e.url.includes("docs.google.com")?60:30;if(this._validationThrottlingCount>s){const e={initialCommand:"VALIDATE_TEXT",isSuccessful:!1,instanceId:t.metaData.instanceId,error:{status:0,message:"Too many checks within five seconds. Please try again in a couple of seconds.",response:"Too many checks within five seconds. Please try again in a couple of seconds."}};return Promise.resolve(e)}const n=this._getPreferredLanguages(e);t.elementLanguage&&n.push(LanguageManager.getPrimaryLanguageCode(t.elementLanguage));const o=this._storageController.getStatistics().usageCount+1;return this._storageController.updateStatistics({usageCount:o}),this._updateUninstallURL(getDomain(t.metaData.url)),Promise.all([Validator.validate(t.text,t.forceLanguage?t.language:null,n,t.metaData,t.hasUserChangedLanguage),Validator.partialValidate(t.changedParagraphs,t.language,n,t.metaData,!t.forceLanguage)]).then(([e,a])=>{let s=e.language||t.language;const n=!(!s||s.name!==this.UNSUPPORTED_LANGUAGE_NAME);return n&&(s=null),{initialCommand:"VALIDATE_TEXT",isSuccessful:!0,instanceId:t.metaData.instanceId,text:t.text,changedParagraphs:t.changedParagraphs,language:s,isUnsupportedLanguage:n,isIncompleteResult:a.isIncompleteResult,validationErrors:e.errors,validationHiddenErrors:e.hiddenErrors,partialValidationErrors:a.errors,partialValidationHiddenErrors:a.hiddenErrors}}).catch(e=>{if(!e||"AbortError"!==e.reason)return{initialCommand:"VALIDATE_TEXT",isSuccessful:!1,instanceId:t.metaData.instanceId,error:{reason:e.reason,status:e.status,message:e.message,response:e.response,stack:e.stack}}})}static _onLaunchValidatorMessage(e,t){this._launchValidator(t.text)}static _onGetValidatorDataMessage(e,t){const a=this._validatorsData[t.id];this._validatorsData[t.id]=null;const s={initialCommand:"GET_VALIDATOR_DATA",isSuccessful:!0,text:a?a.text:""};return Promise.resolve(s)}static _onStartDictionarySyncMessage(e,t){DictionarySync.checkForInitialSync()}static _onAddWordToDictionaryMessage(e,t){DictionarySync.addWord(t.word).catch(()=>null)}static _onBatchAddWordToDictionaryMessage(e,t){DictionarySync.addBatch(t.words).catch(()=>null)}static _onRemoveWordFromDictionaryMessage(e,t){DictionarySync.removeWord(t.word).catch(()=>null)}static _onClearDictionaryMessage(e,t){DictionarySync.removeBatch(this._storageController.getSettings().dictionary).catch(()=>null)}static _onGetPreferredLanguagesMessage(e,t){const a=this._getPreferredLanguages(e),s=this._storageController.getSettings(),n=a.map(e=>s[`${e}Variant`]||e);return Promise.resolve(n)}static _onLoadSynonymsMessage(e,t){return Synonyms.load(t.wordContext,t.language,t.motherLanguage)}static _onValidateClicked(e,t){if(t){const a={command:"GET_SELECTED_TEXT"};browser.tabs.sendMessage(t.id,a).then(e=>{this._launchValidator(e.selectedText)}).catch(t=>{this._launchValidator(e.selectionText)})}else this._launchValidator(e.selectionText);this._storageController.updateUIState({hasUsedValidator:!0})}}BackgroundApp.UNSUPPORTED_LANGUAGE_NAME="NoopLanguage",BackgroundApp._darkMode=!1,BackgroundApp._lastPing=null,BackgroundApp._extensionStates=new Map,BackgroundApp._validatorsData=new Map,BackgroundApp._validationThrottlingCount=0,BackgroundApp._isInitialized=!1,BackgroundApp._lastScreenshot=null,BackgroundApp._constructor();