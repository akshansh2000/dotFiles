/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class DomMeasurement{constructor(t=document){this._window=t.defaultView,this._document=t,this.clearCache()}_getElementCache(t){let e=this._elementCache.get(t);return e||(e={},this._elementCache.set(t,e)),e}clearCache(){this._documentVisibleBox=null,this._documentGap=null,this._documentScroll=null,this._elementCache=new Map}_contains(t,e){return t&&t!==e&&t.contains(e)}_getComputedStyle(t,e,o){let n,i;return"object"==typeof e?(n=e,i=""):(n=o,i=e),n.computedStyle||(n.computedStyle=new Map),n.computedStyle.has(i)||(n.computedStyle[i]=this._window.getComputedStyle(t,i||null)),n.computedStyle[i]}getComputedStyle(t,e=""){return this._getComputedStyle(t,e,this._getElementCache(t))}_getComputedStyleMap(t,e){return t.computedStyleMap?(e.computedStyleMap||(e.computedStyleMap=t.computedStyleMap()),e.computedStyleMap):null}getComputedStyleMap(t){return this._getComputedStyleMap(t,this._getElementCache(t))}getInlineStyle(t,e){return t.style.getPropertyValue(e)}getStyle(t,e,o=""){return this.getStyles(t,[e],o)[e]}getStyles(t,e,o=""){let n=null,i={};const s=this._getElementCache(t);for(const l of e)if(n=n||this._getComputedStyle(t,o,s),"line-height"===l||"lineHeight"===l)i[l]=this.getInlineStyle(t,l)||n[l]||"";else if("font"!==l||n[l])i[l]="zoom"===l?n[l]||"1":n[l]||"";else{const e=n["font-style"],o=n["font-variant"],s=n["font-weight"],r=n["font-size"],c=this.getInlineStyle(t,"line-height")||n["line-height"]||"",h=n["font-family"];i[l]=`${e} ${o} ${s} ${r} ${c?"/ "+c:""} ${h}`}return i}getExactStyle(t,e){return this.getExactStyles(t,[e])[e]}getExactStyles(t,e){const o=this._getElementCache(t),n=this._getComputedStyleMap(t,o);if(n){const t={};for(const o of e){const e=n.get(o);e?"number"==typeof(i=e).value&&"string"==typeof i.unit?t[o]=e.value+e.unit:t[o]=e.toString():t[o]=""}return t}return this.getStyles(t,e);var i}setStyles(t,e,o=!1){for(const n in e){let i=e[n].trim();const s=o||DomMeasurement.IMPORTANT_REG_EXP.test(i);i=i.replace(DomMeasurement.IMPORTANT_REG_EXP,""),t.style.setProperty(n,i,s?"important":"")}}copyStyles(t,e,o,n=!1){const i=this.getStyles(t,o);this.setStyles(e,i,n)}resetStyles(t,e,o=!1){let n="";for(const t in e){let i=e[t].trim();o&&!DomMeasurement.IMPORTANT_REG_EXP.test(i)&&(i+=" !important"),n+=`${t}: ${i};`}t.style.cssText=n}_getBorderBox(t,e,o,n){const i="borderBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){let{top:s,left:l,width:r,height:c}=t.getBoundingClientRect();if(o){const e=this.getZoom(t);s*=e,l*=e,r*=e,c*=e}else r/=this._getScaleXFactor(t,n),c/=this._getScaleYFactor(t,n);if(e){const e=this.getDocumentScroll();if(s+=e.top,l+=e.left,this._document.body&&this._contains(this._document.body,t)){const t=this.getDocumentGap();s-=t.top,l-=t.left}}n[i]={top:s,right:l+r,bottom:s+c,left:l,width:r,height:c}}return n[i]}getBorderBox(t,e=!0,o=!0){return clone(this._getBorderBox(t,e,o,this._getElementCache(t)))}_getPaddingBox(t,e,o,n){const i="paddingBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){let{top:s,left:l,width:r,height:c}=this._getBorderBox(t,e,o,n);const h=o?this._getScaleXFactor(t,n):1,a=o?this._getScaleYFactor(t,n):1,m=o?this._getZoom(t,n):1,d=this._getComputedStyle(t,n),u=(parseFloat(d["border-top-width"])||0)*a*m,g=(parseFloat(d["border-right-width"])||0)*h*m,p=(parseFloat(d["border-bottom-width"])||0)*a*m,_=(parseFloat(d["border-left-width"])||0)*h*m;let f=0,S=0;if("BackCompat"!==this._document.compatMode||t!==this._document.body||t!==this._document.scrollingElement){const e=t.clientWidth*h*m;S=c-u-t.clientHeight*a*m-p,(f=r-_-e-g)<1&&(f=0),S<1&&(S=0)}s+=u,l+=_,r=r-_-f-g,c=c-u-S-p,this._isRTL(t,n)&&(l+=f),n[i]={top:s,right:l+r,bottom:s+c,left:l,width:r,height:c,border:{top:u,right:g,bottom:p,left:_}}}return n[i]}getPaddingBox(t,e=!0,o=!0){return clone(this._getPaddingBox(t,e,o,this._getElementCache(t)))}_getContentBox(t,e,o,n){const i="contentBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){let{top:s,left:l,width:r,height:c,border:h}=this._getPaddingBox(t,e,o,n);const a=o?this._getScaleXFactor(t,n):1,m=o?this._getScaleYFactor(t,n):1,d=o?this._getZoom(t,n):1,u=this._getComputedStyle(t,n),g=(parseFloat(u["padding-top"])||0)*m*d,p=(parseFloat(u["padding-right"])||0)*a*d,_=(parseFloat(u["padding-bottom"])||0)*m*d,f=(parseFloat(u["padding-left"])||0)*a*d;s+=g,l+=f,r=r-f-p,c=c-g-_,n[i]={top:s,right:l+r,bottom:s+c,left:l,width:r,height:c,border:h,padding:{top:g,right:p,bottom:_,left:f}}}return n[i]}getContentBox(t,e=!0,o=!0){return clone(this._getContentBox(t,e,o,this._getElementCache(t)))}_getScrollDimensions(t,e,o){const n="scrollDimensions"+(e?"WithScale":"");if(!o[n]){let i=t.scrollWidth,s=t.scrollHeight;if(e){const e=this._getScaleXFactor(t,o),n=this._getScaleYFactor(t,o),l=this._getZoom(t,o);i=i*e*l,s=s*n*l}o[n]={width:i,height:s}}return o[n]}getScrollDimensions(t,e=!0){return clone(this._getScrollDimensions(t,e,this._getElementCache(t)))}_getScrollPosition(t,e,o,n){const i="scrollPosition"+(e?"WithScale":"")+(o?"WithZoom":"");if(!n[i]){const s=e?this._getScaleXFactor(t,n):1,l=e?this._getScaleYFactor(t,n):1,r=o?this._getZoom(t,n):1,c=t===this._document.body&&"BackCompat"===this._document.compatMode,h=c?0:t.scrollTop*l*r,a=c?0:t.scrollLeft*s*r;n[i]={top:h,left:a}}return n[i]}getScrollPosition(t,e=!0,o=e){return clone(this._getScrollPosition(t,e,o,this._getElementCache(t)))}_getScaleXFactor(t,e){if("number"!=typeof e.scaleXFactor){const o=t.getBoundingClientRect().width;if(o>0){const n=t.offsetWidth;Math.abs(o-n)>1?e.scaleXFactor=o/n:e.scaleXFactor=1}else e.scaleXFactor=1}return e.scaleXFactor}getScaleXFactor(t){return this._getScaleXFactor(t,this._getElementCache(t))}_getScaleYFactor(t,e){if("number"!=typeof e.scaleYFactor){const o=t.getBoundingClientRect().height;if(o>0){const n=t.offsetHeight;Math.abs(o-n)>1?e.scaleYFactor=o/n:e.scaleYFactor=1}else e.scaleYFactor=1}return e.scaleYFactor}getScaleYFactor(t){return this._getScaleYFactor(t,this._getElementCache(t))}_getZoom(t,e){if(BrowserDetector.isFirefox())return 1;if("number"!=typeof e.zoom){let o=1,n=t;for(;n&&n!==this._document.documentElement;){o*=+this.getStyle(n,"zoom"),n=n.parentElement}e.zoom=o}return e.zoom}getZoom(t){return this._getZoom(t,this._getElementCache(t))}_getStackingContextWithZIndex(t){const e=this.getComputedStyle(t),o=parseInt(e.zIndex||"");if(isNaN(o))return null;if(e.position&&DomMeasurement.NON_STATIC_POSITIONS.indexOf(e.position)>-1)return{zIndex:o};if(t.parentElement){const e=this.getComputedStyle(t.parentElement);if("flex"===e.display||"grid"===e.display)return{zIndex:o}}return null}getZIndex(t,e=this._document.documentElement){let o="auto",n=t;if(!n.ownerDocument)return"auto";const i=n.ownerDocument.defaultView.Element;for(;n&&n!==this._document&&n!==e&&n instanceof i;){const t=this._getStackingContextWithZIndex(n);t&&(o=t.zIndex),n=n.parentElement}return o}_isRTL(t,e){return"boolean"!=typeof e.isRTL&&(e.isRTL="rtl"===this.getStyle(t,"direction")),e.isRTL}isRTL(t){return this._isRTL(t,this._getElementCache(t))}isStackingContext(t){const e=this.getComputedStyle(t);return!!(e.position&&DomMeasurement.NON_STATIC_POSITIONS.indexOf(e.position)>-1)||("none"!==e.transform||"none"!==e.filter||"none"!==e.clipPath||"none"!==e.perspective||Number(e.opacity)<1)}getTextBoundingBoxes(t,e,o=!0){Array.isArray(t)||(t=[t]);let n=[],i=0,s=0;if(o){const t=this.getDocumentScroll();if(i+=t.top,s+=t.left,this._document.body&&this._contains(this._document.body,e)){const t=this.getDocumentGap();i-=t.top,s-=t.left}}for(const e of t)try{const t=this._document.createRange();t.setStart(e.textNode,e.start),t.setEnd(e.textNode,e.end);const o=Array.from(t.getClientRects());for(const t of o){if(t.width<DomMeasurement.MIN_TEXT_BOX_WIDTH)continue;const e=n[n.length-1],o=t.top+i,l=t.right+s,r=t.bottom+i,c=t.left+s,h=t.width,a=t.height;e&&e.right===c&&e.top===o&&e.bottom===r&&e.height===a?(e.right=l,e.width=e.width+h):n.push({top:o,right:l,bottom:r,left:c,width:h,height:a})}}catch(t){}return n}getRelativeTextBoundingBoxes(t,e,o=this.getScrollPosition(e)){Array.isArray(t)||(t=[t]);let n=[];const i=this.getPaddingBox(e,!1,!1),s=i.left-o.left,l=i.top-o.top;for(const e of t)try{const t=this._document.createRange();t.setStart(e.textNode,e.start),t.setEnd(e.textNode,e.end);const o=Array.from(t.getClientRects());for(const t of o){if(t.width<DomMeasurement.MIN_TEXT_BOX_WIDTH)continue;const e=n[n.length-1],o=t.top-l,i=t.right-s,r=t.bottom-l,c=t.left-s,h=t.width,a=t.height;e&&e.right===c&&e.top===o&&e.bottom===r&&e.height===a?(e.right=i,e.width=e.width+h):n.push({top:o,right:i,bottom:r,left:c,width:h,height:a})}}catch(t){console.error("LT range error",t)}const r=this.getScaleXFactor(e),c=this.getScaleYFactor(e);for(const t of n)t.top=Math.round(t.top/c),t.right=Math.round(t.right/r),t.bottom=Math.round(t.bottom/c),t.left=Math.round(t.left/r),t.width=t.right-t.left,t.height=t.bottom-t.top;return n}getRelativeTextBoundingBox(t,e){const o=this.getRelativeTextBoundingBoxes(t,e),n=Math.min(...o.map(t=>t.top)),i=Math.max(...o.map(t=>t.right)),s=Math.max(...o.map(t=>t.bottom)),l=Math.min(...o.map(t=>t.left));return{top:n,right:i,bottom:s,left:l,width:i-l,height:s-n}}_hasRelativePosition(t,e){const o=this._getComputedStyle(t,e).position||"static";return DomMeasurement.NON_STATIC_POSITIONS.indexOf(o)>-1}getDocumentGap(){if(!this._documentGap&&(this._documentGap={top:0,left:0},this._document.body&&this._hasRelativePosition(this._document.body,this._getElementCache(this._document.body)))){const t=this.getBorderBox(this._document.documentElement),e=this.getBorderBox(this._document.body);let o=this._document.documentElement.offsetTop,n=this._document.documentElement.offsetLeft;if(BrowserDetector.isFirefox()){let t=null;0===o&&(t=this.getComputedStyle(this._document.documentElement),o=parseInt(t["margin-top"])||0),0===n&&(t=t||this.getComputedStyle(this._document.documentElement),n=parseInt(t["margin-left"])||0)}const i=e.top-t.top+o,s=e.left-t.left+n,l=this.getComputedStyle(this._document.body),r=parseFloat(l["border-top-width"])||0,c=parseFloat(l["border-left-width"])||0;this._documentGap={top:i+r,left:s+c}}return clone(this._documentGap)}getDocumentVisibleBox(){if(!this._documentVisibleBox){const t=this.getDocumentScroll(),e=this._document.documentElement.clientHeight,o=this._document.documentElement.clientWidth;this._documentVisibleBox={top:t.top,right:t.left+o,bottom:t.top+e,left:t.left,width:o,height:e}}return clone(this._documentVisibleBox)}getDocumentScroll(){if(!this._documentScroll){const t=this._document.documentElement&&this._document.documentElement.scrollTop||this._document.body&&this._document.body.scrollTop||0,e=this._document.documentElement&&this._document.documentElement.scrollLeft||this._document.body&&this._document.body.scrollLeft||0;this._documentScroll={top:t,left:e}}return clone(this._documentScroll)}}DomMeasurement.IMPORTANT_REG_EXP=/!important$/,DomMeasurement.NON_STATIC_POSITIONS=["relative","fixed","absolute","sticky"],DomMeasurement.MIN_TEXT_BOX_WIDTH=.1;