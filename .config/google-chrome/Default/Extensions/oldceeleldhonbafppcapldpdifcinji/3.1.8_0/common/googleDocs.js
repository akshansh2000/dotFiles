class GoogleDocs{static init(){this._isMainGoogleDocsFrame()&&(this._storageController=StorageController.create(),this._domMeasurement=new DomMeasurement(document),this._interval=window.setInterval(()=>{this._checkForNewPage(),this._checkMode(),this._checkOutOfViewPages()},750),this._storageController.addEventListener(StorageControllerClass.eventNames.settingsChanged,t=>{(t.disabledEditorGroups||t.disabledDomains)&&this._toggleMenubarButton(!!t.disabledEditorGroups)}),this._storageController.onReady(()=>{this._toggleMenubarButton()}))}static _checkForNewPage(){if("view"===this._getMode())return;Array.from(document.querySelectorAll(this.UNHANDLED_PAGE_SELECTOR)).forEach(t=>{this._isInView(t)&&this._onPageInViewCallbacks.forEach(e=>e(t))})}static _checkMode(){const t=this._getMode();this._currentMode?t!==this._currentMode&&(this._currentMode=t,this._onModeChangeCallbacks.forEach((e,o)=>{e(t)})):this._currentMode=t}static _checkOutOfViewPages(){this._onPageOutOfViewCallbacks.forEach((t,e)=>{this._isInView(e)||t(e)})}static _toggleMenubarButton(t=!1){if(!this._storageController)return;const e=this.getDocId(location.href);if(!e)return;const o=getMainPageDomain(),n=this._storageController.getValidationSettings(o,e);this._insertMenubarButton(),n.isEditorGroupDisabled||n.isDomainDisabled?this._unselectMenubarButton(t):this._selectMenubarButton()}static _insertMenubarButton(){if(this._menuBarButton)return;const t=document.querySelector("#clearFormattingButton");t&&t.parentNode&&(this._menuBarButton=document.createElement("div"),this._menuBarButton.className="lt-gdocs-menubar-button goog-toolbar-button goog-toolbar-toggle-button goog-inline-block",this._menuBarButton.setAttribute("role","button"),this._menuBarButton.setAttribute("aria-disabled","false"),this._menuBarButton.setAttribute("aria-hidden","false"),this._menuBarButton.id="enableLTButton",this._menuBarButton.style.userSelect="none",this._menuBarButton.addEventListener("click",()=>{const t=this.getDocId(location.href);t&&this._storageController&&(this._storageController.updateUIState({hasSeenGoogleDocsMenuBarHint:!0}),this._menuBarButton.classList.contains("goog-toolbar-button-checked")?(this._storageController.disableEditorGroup(getMainPageDomain(),t),EnvironmentAdapter.ltAssistantStatusChanged({enabled:!1}),Tracker.trackEvent("Action","toggle_gdocs","off")):(this._storageController.enableDomainAndEditorGroup(getMainPageDomain(),t),EnvironmentAdapter.ltAssistantStatusChanged({enabled:!0}),Tracker.trackEvent("Action","toggle_gdocs","on")))},!0),this._menuBarSeparator=document.createElement("div"),this._menuBarSeparator.className="docs-toolbar-small-separator goog-toolbar-separator goog-inline-block",this._menuBarSeparator.setAttribute("role","separator"),this._menuBarSeparator.setAttribute("aria-disabled","true"),this._menuBarSeparator.setAttribute("aria-hidden","false"),this._menuBarSeparator.id="enableLTSeparator",this._menuBarSeparator.style.userSelect="none",t.parentNode.insertBefore(this._menuBarButton,t.nextSibling),t.parentNode.insertBefore(this._menuBarSeparator,t.nextSibling))}static _removeMenubarButton(){this._menuBarButton&&(this._menuBarButton.remove(),this._menuBarButton=null),this._menuBarSeparator&&(this._menuBarSeparator.remove(),this._menuBarSeparator=null)}static _selectMenubarButton(){this._menuBarButton&&(this._menuBarButton.classList.add("goog-toolbar-button-checked"),this._menuBarButton.setAttribute("aria-label",i18nManager.getMessage("googleDocsDisableButton")),this._menuBarButton.setAttribute("data-tooltip",i18nManager.getMessage("googleDocsDisableButton")))}static _unselectMenubarButton(t){this._menuBarButton&&(this._menuBarButton.classList.remove("goog-toolbar-button-checked"),this._menuBarButton.setAttribute("aria-label",i18nManager.getMessage("googleDocsEnableButton")),this._menuBarButton.setAttribute("data-tooltip",i18nManager.getMessage("googleDocsEnableButton")),t&&this._showMenuBarHint())}static _showMenuBarHint(){if(this._menuBarHint||!this._menuBarButton||!this._storageController)return;const{hasSeenGoogleDocsMenuBarHint:t}=this._storageController.getUIState();if(t)return;const e=this._menuBarButton.offsetHeight?this._menuBarButton:document.querySelector("#moreButton");if(!e)return;const o=e.getBoundingClientRect();this._menuBarHint=document.createElement("div"),this._menuBarHint.classList.add("lt-gdocs-hint"),this._menuBarHint.style.top=o.bottom+"px",this._menuBarHint.style.right=window.innerWidth-o.right+"px",this._menuBarHint.textContent=i18nManager.getMessage("googleDocsEnableHint");const n=document.createElement("span");n.classList.add("lt-gdocs-hint__close"),n.addEventListener("click",t=>{t.stopImmediatePropagation(),s()},!0),this._menuBarHint.appendChild(n),document.body.appendChild(this._menuBarHint);const s=()=>{var t;this._menuBarHint&&(fadeOutAndRemove(this._menuBarHint),this._menuBarHint=null,null===(t=this._storageController)||void 0===t||t.updateUIState({hasSeenGoogleDocsMenuBarHint:!0}))};this._onInput(()=>s(),!0)}static initPage(t){document.documentElement.setAttribute("data-lt-site","gdocs"),t.setAttribute("data-lt-tweaks","gdocs"),this._pages.push(t);let e=null;return 1===this._pages.length&&(e=window.setTimeout(()=>{if(!this._storageController||!this._storageController.isReady())return;const{hasSeenNewGoogleDocsTeaser:t}=this._storageController.getUIState();t||this._showTeaser()},800)),{destroy:()=>{e&&window.clearTimeout(e),this.destroyPage(t)}}}static getDocId(t){const e=t.match(this.DOC_ID_REG_EXP);return e?e[1]:null}static onPage(t){this._onPageInViewCallbacks.push(e=>{t(e,!1)})}static isElementCompatible(t){return t.matches(this.UNHANDLED_PAGE_SELECTOR)}static getHighlighterZIndex(t){return 23}static getToolbarZIndex(t){return 27}static getToolbarPosition(t,e){const o=e.getBorderBox(t);if(o.top>window.innerHeight)return null;if(this._kixContainer=this._kixContainer||document.getElementById("kix-appview"),!this._kixContainer)return null;const n=e.getBorderBox(this._kixContainer).top+20,s=Math.round(Math.max(o.top+30,n)),r=Math.round(o.left);return s+50>o.bottom?null:{top:s+"px",left:r+"px",fixed:!0}}static isPage(t){return t.classList.contains(this.PAGE_CLASS_NAME)}static getPreviousPage(t){let e=t.previousElementSibling;for(;e;){if(this.isPage(e))return e;e=e.previousElementSibling}return null}static getNextPage(t){let e=t.nextElementSibling;for(;e;){if(this.isPage(e))return e;e=e.nextElementSibling}return null}static isIgnoredElement(t){const e=t.tagName.toUpperCase();return CEElementInspector.SKIPPING_TAGS.includes(e)||t.classList.contains("kix-selection-overlay")||t.classList.contains("kix-htmloverlay-under-text")||t.classList.contains("kix-lineview-decorations")||t.classList.contains("suggest-changes-top-colorbar")||t.classList.contains("suggest-changes-bottom-colorbar")||t.classList.contains("kix-spelling-error-overlay-container")||t.classList.contains("kix-lineview-background")||t.classList.contains("kix-commentoverlayrenderer-resolved")||t.classList.contains("kix-commentoverlayrenderer-highlighted")||t.classList.contains("kix-commentoverlayrenderer-resolved-highlighted")||t.classList.contains("kix-commentoverlayrenderer-smart-todo-highlighted")||t.classList.contains("kix-commentoverlayrenderer-normal")||t.classList.contains("kix-findandreplaceoverlayprovider-match")||t.classList.contains("kix-findselectionprovider-underlay-match")||t.classList.contains("kix-footnotenumberview")||t.classList.contains("kix-page-header")||0===t.offsetHeight}static isBlockElement(t,e){return!t.classList.contains("kix-lineview-content")&&!t.classList.contains(this.LINE_CLASS_NAME)&&CEElementInspector.DISPLAY_BLOCK_VALUES.includes(e.display||"")}static _normalizeWhiteSpace(t){return t.replace(this.WHITESPACES_REGEXP," ")}static replaceText(t,e,o){if(!(t=this._normalizeWhiteSpace(t)).trim())return removeZWC(t);const n=o.parentElement;if(n&&!e.nextSibling&&(n.classList.contains(this.TEXT_BLOCK_CLASS_NAME)&&n.lastElementChild===o?t=t.replace(this.ZWNJ_END_REGEXP," "):n.parentElement&&n.parentElement.classList.contains(this.TEXT_BLOCK_CLASS_NAME)&&n.parentElement.lastElementChild.lastElementChild===o&&(t=t.replace(this.ZWNJ_END_REGEXP," "))),!(t=removeZWC(t)).trim())return t;const s=o.closest(`.${this.LINE_CLASS_NAME}`);if(!s)return this._replaceText(t,o,n);const r=s.querySelectorAll(this.STRIKETHROUGH_SELECTOR);if(!r.length)return this._replaceText(t,o,n);const i=o.getBoundingClientRect(),a=Array.from(r).find(t=>{const e=t.getBoundingClientRect();return isRectsIntersect({top:i.top,right:i.right-1,bottom:i.bottom,left:i.left+1},e)});if(!a)return this._replaceText(t,o,n);const l=a.getBoundingClientRect();if(l.width<2)return this._replaceText(t,o,n);const c=e.nodeValue,u=new Range;let g=!1;for(let t=0;t<c.length;t++){if(isZWC(c.charAt(t)))continue;if(u.setStart(e,t),u.setEnd(e,t),u.getBoundingClientRect().left>=l.left){g=!0;break}}if(!g)return this._replaceText(t,o,n);const d=new Range;for(let t=u.startOffset;t<c.length;t++){if(t>u.startOffset&&isZWC(c.charAt(t-1)))continue;d.setStart(e,t),d.setEnd(e,t);const o=d.getBoundingClientRect();if(o.left>l.right&&o.left-l.right>.5){d.setStart(e,Math.max(t-1,0)),d.setEnd(e,Math.max(t-1,0));break}}const h=new Range;h.setStart(u.startContainer,u.startOffset),h.setEnd(d.endContainer,d.endOffset);const _=c.substring(h.startOffset,h.endOffset);return t=removeZWC(c.substring(0,h.startOffset))+"\ufeff".repeat(removeZWC(_).length)+removeZWC(c.substring(h.endOffset,c.length)),this._replaceText(t,o,n)}static _replaceText(t,e,o){let n=null;o&&"A"===o.tagName?n=o:"A"===e.tagName&&(n=e);const s=t.trim();if(n){if(this.URL_FRAGMENT_REG_EXP.test(t)||this.FILE_NAME_REGEXP.test(t))return"\ufeff".repeat(t.length);if(s.length>10&&n.href.includes(s))return"\ufeff".repeat(t.length)}else if(!this.WHITE_SPACE_REGEXP.test(s)&&this.URL_FRAGMENT_REG_EXP.test(s))return"\ufeff".repeat(t.length);return e.classList.contains("kix-wordhtmlgenerator-word-node")?t:t.replace(this.BULLET_POINT_REGEXP,t=>"\ufeff".repeat(t.length))}static _isMainGoogleDocsFrame(){return window.innerWidth>=400&&window.innerHeight>250}static _getMode(){return document.querySelector("#docs-toolbar-mode-switcher .docs-icon-acl-comment-only")?"suggest":document.querySelector("#docs-toolbar-mode-switcher .docs-icon-acl-view-only")?"view":document.querySelector("#docs-toolbar-mode-switcher .docs-icon-mode-edit")?"edit":"view"}static _updateTextBoxes(t,e){this._domMeasurement.clearCache();const o=this._domMeasurement.getTextBoundingBoxes(e,t,!1);return{textBoxes:o,firstTextBox:o[0],lastTextBox:o[o.length-1]}}static _getIframeWin(){const t=document.querySelector(".docs-texteventtarget-iframe");return t&&t.contentWindow||null}static applyFix(t){const{editor:e,offset:o,replacementText:n}=t,s=e.inputAreaWrapper.getTextRanges(o.start,o.length),r=document.querySelector(".kix-appview-editor");if(!r)return Tracker.trackError("other","google_docs:apply_fix1"),Promise.reject();const i=this._getIframeWin();if(!i)return Tracker.trackError("other","google_docs:apply_fix3"),Promise.reject();const a=i.document.querySelector("[contenteditable=true]");if(!a)return Tracker.trackError("other","google_docs:apply_fix4"),Promise.reject();const l=this._domMeasurement.getBorderBox(r,!1);let{firstTextBox:c,lastTextBox:u}=this._updateTextBoxes(e.inputArea,s);c.top<l.top?r.scrollTop-=l.top-c.top:u.bottom>l.bottom&&(r.scrollTop+=u.bottom-l.bottom);const g=this._updateTextBoxes(e.inputArea,s);c=g.firstTextBox,u=g.lastTextBox;const d=s[0].textNode.parentElement;if(!d)return Tracker.trackError("other","google_docs:apply_fix5"),Promise.reject();const h=s[s.length-1].textNode.parentElement;return h?wait(40).then(()=>{const t={clientX:c.left,clientY:c.top+c.height/2,bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL},e={clientX:u.right,clientY:u.top+u.height/2,bubbles:!0,shftKey:!0,detail:GoogleDocs.MOUSE_EVENT_DETAIL},o={shiftKey:!0,key:"Shift",code:"ShiftLeft",keyCode:16,charCode:0,which:16,location:1};d.dispatchEvent(new MouseEvent("mousedown",t)),h.dispatchEvent(new MouseEvent("mousemove",e)),a.dispatchEvent(new i.KeyboardEvent("keydown",o)),h.dispatchEvent(new MouseEvent("mouseup",e)),a.dispatchEvent(new i.KeyboardEvent("keyup",o));const s=new i.ClipboardEvent("paste",{clipboardData:new i.DataTransfer,bubbles:!0}),r=n.replace(/\s/g," ");return s.clipboardData.setData("text/plain",r),a.dispatchEvent(s),a.textContent=r,Promise.resolve()}):(Tracker.trackError("other","google_docs:apply_fix6"),Promise.reject())}static _onModeChange(t,e){this._onModeChangeCallbacks.set(t,e)}static _isInView(t){const e=t.getBoundingClientRect();return e.bottom>-1e3&&e.top<window.innerHeight+2e3}static _onOutOfView(t,e){this._onPageOutOfViewCallbacks.set(t,e)}static _showTeaser(){const t=Array.from(document.querySelectorAll(`.${this.TOOLBAR_CLASS_NAME}`));if(!t.length)return;const e=t.find(t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.top<window.innerHeight&&e.width>0});if(!e)return;const o=document.createElement("lt-div");o.className="lt-gdocs-new-teaser";const n=document.createElement("lt-div");n.className="lt-gdocs-new-teaser__headline",n.textContent=i18nManager.getMessage("googleDocsNewTeaserHeadline"),o.appendChild(n);const s=document.createElement("lt-div");s.className="lt-gdocs-new-teaser__text",s.textContent=i18nManager.getMessage("googleDocsNewTeaserText"),o.appendChild(s);const r=document.createElement("lt-span");r.className="lt-gdocs-new-teaser__close",o.appendChild(r),r.addEventListener("click",t=>{t.stopImmediatePropagation(),t.preventDefault(),i()},!0);const i=()=>{o.remove(),e&&e.classList.remove("lt-toolbar--gdocs-teaser-opened"),this._storageController&&this._storageController.updateUIState({hasSeenNewGoogleDocsTeaser:!0})};e.classList.add("lt-toolbar--gdocs-teaser-opened"),e.appendChild(o),e.addEventListener("mouseup",t=>{t.target instanceof HTMLElement&&o.contains(t.target)||i()},{capture:!0,once:!0}),this._onInput(()=>i(),!0)}static _onInput(t,e=!1){const o=this._getIframeWin();o&&o.document&&o.document.addEventListener("keydown",e=>{["Control","Shift","Meta","Alt"].includes(e.key)||t()},{capture:!0,once:e})}static getSelection(){const t=document.body.querySelectorAll(".kix-selection-overlay:not([style*='rgb(31'])");if(!t.length)return null;const e=t[0].getBoundingClientRect(),o=1===t.length?e:t[t.length-1].getBoundingClientRect();let n=getRangeAtPoint({x:e.left+1,y:Math.round(e.bottom-.3*e.height)}),s=getRangeAtPoint({x:o.right-.5,y:Math.round(o.bottom-.3*o.height)});return n&&s&&(n.startContainer!==s.startContainer||n.startOffset!==s.startOffset||(n=getRangeAtPoint({x:e.left,y:Math.round(e.top+.3*e.height)}),s=getRangeAtPoint({x:o.right,y:Math.round(o.top+.3*o.height)}),n&&s))?{startNode:n.startContainer,startOffset:n.startOffset,endNode:s.endContainer,endOffset:s.endOffset,isCollapsed:!1}:null}static getSelectedText(){const t=this.getSelection();if(!t)return"";const e=new Range;return e.setStart(t.startNode,t.startOffset),e.setEnd(t.endNode,t.endOffset),e.toString()}static filterErrors(t,e){const o=this.getPreviousPage(t);return e.filter(t=>!this.DISABLED_RULES.includes(t.rule.id)&&!t.rule.id.endsWith("UNPAIRED_BRACKETS")&&((!o||0!==t.offset||"UPPERCASE_SENTENCE_START"!==t.rule.id)&&(!t.fixes[0]||t.fixes[0].value.replace(/\u00A0/g," ")!==t.originalPhrase)))}static onPageDestroy(t,e){this._onModeChange(t,o=>{"view"===o&&e(t)}),this._onOutOfView(t,()=>{e(t)}),onElementRemoved(t,e)}static destroyPage(t){t.removeAttribute("data-lt-tweaks"),this._onModeChangeCallbacks.delete(t),this._onPageOutOfViewCallbacks.delete(t);const e=this._pages.indexOf(t);e>-1&&this._pages.splice(e,1),this._pages.length||document.documentElement.removeAttribute("data-lt-site")}static destroy(){document.documentElement.removeAttribute("data-lt-site"),this._interval&&clearInterval(this._interval),this._interval=null,this._removeMenubarButton(),this._onModeChangeCallbacks.clear(),this._onPageOutOfViewCallbacks.clear(),this._onPageInViewCallbacks=[],this._storageController&&this._storageController.destroy(),this._menuBarHint&&(this._menuBarHint.remove(),this._menuBarHint=null)}}GoogleDocs.DOCS_URL_REGEXP=/docs\.google\.com\/document/,GoogleDocs.MOUSE_EVENT_DETAIL=99,GoogleDocs.BULLET_POINT_REGEXP=/^([\u25CF\u25CB\u25C6\u27A2\u25A0\u25A1\u2605\u274F\u2794\u21B5\u2756\u25AA\u2751\-\–\—o]|[VIX]+\.|[a-z0-9]{1,3}\.|\d{1,2}\.?\)|[a-z]{1,2}\.?\))$/g,GoogleDocs.ZWNJ_END_REGEXP=/(\u200C|\s)?$/,GoogleDocs.URL_FRAGMENT_REG_EXP=/[&\?#][a-z0-9]+|%[A-Z0-9]{2}|[a-z0-9]=\!?[a-z0-9]|[a-z0-9\.]{2,}\![a-z0-9\.]{2,}|[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}|\/.+?\/.+/i,GoogleDocs.FILE_NAME_REGEXP=/^[a-z0-9_\-\/\\]+\.[a-z]{2,4}$/i,GoogleDocs.DOC_ID_REG_EXP=/document\/d\/(.+?)(\/|$)/i,GoogleDocs.WHITE_SPACE_REGEXP=/\s/,GoogleDocs.TOOLBAR_CLASS_NAME="lt-gdocs-toolbar",GoogleDocs.PAGE_CLASS_NAME="kix-page",GoogleDocs.LINE_CLASS_NAME="kix-lineview",GoogleDocs.TEXT_BLOCK_CLASS_NAME="kix-lineview-text-block",GoogleDocs.UNHANDLED_PAGE_SELECTOR=".kix-page:not([data-lt-tweaks])",GoogleDocs.STRIKETHROUGH_SELECTOR=".kix-lineview-decorations [style*='height:1px;border-top:3px'], .kix-lineview-decorations [style*='height: 1px; border-top: 3px']",GoogleDocs._interval=null,GoogleDocs._currentMode=null,GoogleDocs._onModeChangeCallbacks=new Map,GoogleDocs._onPageOutOfViewCallbacks=new Map,GoogleDocs._onPageInViewCallbacks=[],GoogleDocs._pages=[],GoogleDocs._kixContainer=null,GoogleDocs._storageController=null,GoogleDocs._menuBarButton=null,GoogleDocs._menuBarSeparator=null,GoogleDocs._menuBarHint=null,GoogleDocs.DISABLED_RULES=["PUNCTUATION_PARAGRAPH_END","FINAL_STOPS","FINAL_PUNCTUATION","PUNT_FINAL","BRAK_KROPKI","EINDE_ZIN_ONVERWACHT","FALSCHES_ANFUEHRUNGSZEICHEN"],GoogleDocs.WHITESPACES=[8,9,32,160,8194,8195,8196,8197,8198,8199,8200,8201,8202,8287,12288].map(function(t){return String.fromCharCode(t)}),GoogleDocs.WHITESPACES_REGEXP=new RegExp("["+GoogleDocs.WHITESPACES.join("")+"]","g"),"undefined"!=typeof module&&(module.exports=GoogleDocs);