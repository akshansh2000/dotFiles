/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
{let e,t,n,o;const s=document.getElementById("popup-container"),a=document.getElementById("popup-basic-link"),i=document.getElementById("popup-plus-link"),p=(document.getElementById("popup-onboarding"),document.getElementById("onboarding-button")),d=document.getElementById("popup-hint"),r=document.getElementById("popup-synonym-settings"),l=document.querySelector("#popup-option-capitalization .lt-popup__switch"),c=document.querySelector("#popup-option-check .lt-popup__switch"),u=document.querySelector("#popup-option-synonyms .lt-popup__switch"),g=document.getElementById("popup-synonyms-tutorial"),m=document.getElementById("popup-tutorial-close"),_=document.getElementById("popup-validator"),b=document.getElementById("popup-validator-button"),E=document.getElementById("popup-teaser"),h=document.getElementById("feedback-link"),L=document.getElementById("popup-more-options-link");translateSection(document.body),translateElement("#popup-onboarding-text-1",{key:"popupOnboardingStep1",isHTML:!0}),translateElement("#popup-onboarding-text-2",{key:"popupOnboardingStep2",isHTML:!0,interpolations:['<span class="lt-popup__onboarding__icon1"></span>','<span class="lt-popup__onboarding__icon2"></span>']}),translateElement("#popup-onboarding-text-3",{key:"popupOnboardingStep3",isHTML:!0}),translateElement("#popup-onboarding-text-4",{key:"popupOnboardingStep4",isHTML:!0}),L.setAttribute("title",i18nManager.getMessage("popupSettingsHover")),[L,a,i].forEach(e=>{e.addEventListener("click",()=>{EnvironmentAdapter.openOptionsPage(void 0,e===L?"popup-icon":"popup-badge"),window.close()})}),p.addEventListener("click",()=>{s.classList.remove("lt-popup--show-onboarding"),s.classList.remove("lt-popup--disabled"),y.updateUIState({hasSeenOnboarding:!0}),Tracker.trackEvent("Action","popup:onboarding_banner:close")}),h.addEventListener("click",()=>EnvironmentAdapter.openFeedbackForm(e));let y=StorageController.create();y.onReady(()=>{browser.tabs.query({currentWindow:!0,active:!0}).then(a=>{if(!a||!a.length)return void window.close();if(n=a[0].id,e=a[0].url||"",t=getDomain(e),o=TweaksManager.getTweaks(e),!y.getPrivacySettings().allowRemoteCheck&&!e.startsWith(config.INSTALL_URL)){const e={command:"OPEN_PRIVACY_CONFIRMATION"};return browser.runtime.sendMessage(e),void window.close()}reloadContentScriptsIfNecessary(n,t);const i=y.getValidationSettings(t,o.getEditorGroupId(e)),p={enabled:!i.isDomainDisabled&&!i.isEditorGroupDisabled,supported:!0,unsupportedMessage:"",capitalization:i.shouldCapitalizationBeChecked};o.supported()?y.isDomainSupported(t)||(p.supported=!1,p.unsupportedMessage=browser.i18n.getMessage("siteCannotBeSupported")):(p.supported=!1,p.unsupportedMessage=o.unsupportedMessage());const r=y.getStatistics(),m=y.getSettings(),h=y.getUIState(),L=Date.now()-1e3*r.firstVisit;if(r.appliedSuggestions<2&&!h.hasSeenOnboarding)s.classList.add("lt-popup--show-onboarding"),s.classList.add("lt-popup--disabled"),Tracker.trackEvent("Action","popup:onboarding_banner",t);else if(p.supported&&!y.isUsedCustomServer())if(!h.hasPaidSubscription&&("like"===r.ratingValue||r.appliedSuggestions>7||L>432e5)){const e=300;let t=0;const n=Date.now();let o=0;for(const s of r.hiddenErrors){const a=+new Date(s.day);if(n-a>864e6)break;if(o=a,(t+=s.count)>e){t=e;break}}let s=String(t);t>=e&&(s=`${e}+`);const a=Math.ceil((n-o)/1e3/60/60/24);t>5?new HistoricPremiumErrorsTeaser(E,"popup",s,a).render():new UpgradeTeaser(E,"popup").render(),Tracker.trackEvent("Action","popup:upgrade_teaser",`hidden_errors:${s}`)}else h.hasRated||new RatingTeaser(E,"popup",e).render();h.hasPaidSubscription&&s.classList.add("lt-popup--plus"),p.supported||(d.classList.add("lt-popup__hint-visible"),d.innerHTML=DOMPurify.sanitize(p.unsupportedMessage,{ALLOWED_TAGS:["a"],ALLOWED_ATTR:["target","href"]}),s.classList.add("lt-popup--disabled"),Tracker.trackEvent("Action","popup:disabled",getDomain(e))),p.enabled||(c.classList.add("lt-popup__switch--off"),I(),O()),y.isUsedCustomServer()&&O(),p.capitalization||l.classList.add("lt-popup__switch--off"),m.hasSynonymsEnabled||u.classList.add("lt-popup__switch--off"),!h.hasSeenSynonymsTutorial&&m.hasSynonymsEnabled&&g.classList.remove("lt-popup__tutorial--hide"),l.addEventListener("click",()=>v()),c.addEventListener("click",()=>S()),u.addEventListener("click",()=>f()),setTimeout(()=>{s.classList.add("lt-popup--animations-enabled")},500);browser.tabs.sendMessage(n,{command:"GET_SELECTED_TEXT"}).then(t=>{!t||t.selectedText.trim().length<config.MIN_TEXT_LENGTH||e.includes("//"+browser.runtime.id)||(_.classList.remove("lt-popup__validator--hide"),g.classList.add("lt-popup__tutorial--hide"),b.addEventListener("click",()=>{const e={command:"LAUNCH_VALIDATOR",text:t.selectedText};browser.runtime.sendMessage(e),Tracker.trackEvent("Action","popup:check_selected_text"),window.close()}))}).catch(e=>console.log("Failed getting selected text",e)),Tracker.trackPageView()})});const k=t=>"extensions"===t?e:t,S=()=>{c.classList.contains("lt-popup__switch--off")?w():T()},v=()=>{l.classList.contains("lt-popup__switch--off")?M():C()},f=()=>{u.classList.contains("lt-popup__switch--off")?B():D()},w=()=>{if(!y)return;c.classList.remove("lt-popup__switch--off");const s=o.getEditorGroupId(e);y.enableDomainAndEditorGroup(t,s),EnvironmentAdapter.ltAssistantStatusChanged(n,{enabled:!0}),A(),z(),Tracker.trackEvent("Action","enable_domain",k(t))},T=()=>{y&&(c.classList.add("lt-popup__switch--off"),y.disableDomain(t),EnvironmentAdapter.ltAssistantStatusChanged(n,{enabled:!1}),O(),I(),Tracker.trackEvent("Action","disable_domain",k(t)))},A=()=>{l.parentElement.classList.remove("lt-popup__option--hide")},I=()=>{l.parentElement.classList.add("lt-popup__option--hide")},M=()=>{y&&(l.classList.remove("lt-popup__switch--off"),y.enableCapitalization(t),EnvironmentAdapter.ltAssistantStatusChanged(n,{capitalization:!0}),Tracker.trackEvent("Action","enable_capitalization",k(t)))},C=()=>{y&&(l.classList.add("lt-popup__switch--off"),y.disableCapitalization(t),EnvironmentAdapter.ltAssistantStatusChanged(n,{capitalization:!1}),Tracker.trackEvent("Action","disable_capitalization",k(t)))},B=()=>{y&&(y.getUIState().hasSeenSynonymsTutorial||x(),u.classList.remove("lt-popup__switch--off"),y.updateSettings({hasSynonymsEnabled:!0}),Tracker.trackEvent("Action","enable_synonyms",LanguageManager.getUserLanguageCodes()[0]))},D=()=>{y&&(U(),u.classList.add("lt-popup__switch--off"),y.updateSettings({hasSynonymsEnabled:!1}),Tracker.trackEvent("Action","disable_synonyms",LanguageManager.getUserLanguageCodes()[0]))},O=()=>{r.classList.add("lt-popup__settings--hide")},z=()=>{r.classList.remove("lt-popup__settings--hide")},U=()=>{y&&g.classList.add("lt-popup__tutorial--hide")},x=()=>{y&&g.classList.remove("lt-popup__tutorial--hide")};m.addEventListener("click",()=>{y.updateUIState({hasSeenSynonymsTutorial:!0}),U()})}