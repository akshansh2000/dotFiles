const apiBaseUrl="https://www.octotree.io/api/v1.0",PRO_WEBSITE_MESSAGE_NAME="octotree_pro_auth_call";async function sendRequest(e,t){try{const{path:o,token:i,body:s,method:n}=t,r={"Content-Type":"application/json"};i&&(r.Authorization=`Bearer ${i}`);const a=await fetch(`${apiBaseUrl}/${o.replace(/^\//,"")}`,{headers:r,body:s,method:n}),c=a.headers.get("Content-Type");let m;if(m=/application\/json/i.test(c)?await a.json():await a.text(),!a.ok){const e=new Error(m.message||m.statusText||m);throw e.statusCode=a.status,e}e({responseBody:m,responseStatus:a.status})}catch(t){e({message:t.message,statusCode:t.statusCode})}}chrome.runtime.onMessage.addListener((e,t,o)=>{if("octotree_pro_auth_call"===e.eventName)return sendRequest(o,e),!0;o()}),chrome.runtime.setUninstallURL("https://www.octotree.io/feedback");const requestPermissionAsync=promisify(chrome.permissions.request),removePermissionAsync=promisify(chrome.permissions.remove),containsPermissionAsync=promisify(chrome.permissions.contains),createMenuAsync=promisify(chrome.contextMenus.create),removeMenuAsync=promisify(chrome.contextMenus.remove),PRO_ACTIVATE_ENTERPRISE_MESSAGE="octotree_pro_activate_enterprise_call",PRO_DEACTIVATE_ENTERPRISE_MESSAGE="octotree_pro_deactivate_enterprise_call";let isCreated=!1,injectionHookRegistered=!1;function removeMenu(){const{name:e}=chrome.runtime.getManifest();removeMenuAsync(`${e}:add-permission`),removeMenuAsync(`${e}:remove-permission`)}function createMenu(){const{name:e}=chrome.runtime.getManifest();createMenuAsync({id:`${e}:add-permission`,title:`Enable ${e} on this domain`,contexts:["page_action","browser_action"],documentUrlPatterns:["http://*/*","https://*/*"],onclick:async(e,t)=>{let{tabId:o,id:i,url:s}=t;o||(o=i);const n=`${new URL(s).origin}/*`;if(await requestPermissionAsync({permissions:["webNavigation","tabs"],origins:[n]})){registerInjectionHook(),promisify(chrome.tabs.reload)(o)}}}),createMenuAsync({id:`${e}:remove-permission`,title:`Disable ${e} on this domain`,contexts:["page_action","browser_action"],documentUrlPatterns:["http://*/*","https://*/*"],onclick:async(e,t)=>{let{tabId:o,id:i,url:s}=t;o||(o=i);const n=`${new URL(s).origin}/*`;if(!isGitHub(n)&&await containsPermissionAsync({origins:[n]})){if(await removePermissionAsync({origins:[n]})){promisify(chrome.tabs.reload)(o)}}}})}function registerInjectionHook(){!injectionHookRegistered&&chrome.webNavigation&&(injectionHookRegistered=!0,chrome.webNavigation.onCommitted.addListener(async({tabId:e,frameId:t})=>{const o=promisify(chrome.tabs.get),i=promisify(chrome.tabs.executeScript),s=promisify(chrome.tabs.insertCSS);if(0!==t)return;let{url:n}=await o(e);if(!n)try{if(!(n=(await i(e,{code:"window.location.href;",runAt:"document_start"}))[0]))return}catch(e){return}const r=`${new URL(n).origin}/*`;if(isGitHub(r)||isOctotreeWeb(r))return;if(!r.toLowerCase().startsWith("http"))return;if(!await containsPermissionAsync({origins:[r]}))return;const a=chrome.runtime.getManifest().content_scripts;for(const t of a){const{all_frame:o,run_at:n,css:r,js:a}=t;r.forEach(t=>s(e,{file:t,allFrames:o,runAt:n})),a.forEach(t=>i(e,{file:t,allFrames:o,runAt:n}))}}))}function promisify(e){return(...t)=>new Promise((o,i)=>{const s=e=>{chrome.runtime.lastError?i(chrome.runtime.lastError):o(e)},n=e(...t,s);n&&n.then&&n.then(s)})}function isGitHub(e){return"https://github.com/*"===e}function isOctotreeWeb(e){return"https://www.octotree.io/*"===e}chrome.runtime.onMessage.addListener(e=>{e.eventName!==PRO_ACTIVATE_ENTERPRISE_MESSAGE||isCreated?e.eventName===PRO_DEACTIVATE_ENTERPRISE_MESSAGE&&isCreated&&(removeMenu(),isCreated=!1):(createMenu(),isCreated=!0)}),registerInjectionHook();