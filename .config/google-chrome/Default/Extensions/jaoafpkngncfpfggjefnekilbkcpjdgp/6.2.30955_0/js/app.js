class ProxyApp{constructor(){this.storage=STORAGE,this.rateInterval=null,this.vpnOnlyMode=null,this.user_version="UVPNv1",this.registerTabId=null,this.socialAuthSystem=null,this.config={},chrome.runtime.onMessage.addListener((a,b,c)=>{if("getConfig"===a.action&&c(this.storage),"signin"===a.action&&this.login({email:a.email,password:a.password,resource:a.resource},c),"signup"===a.action&&this.register({name:a.name,email:a.email,password:a.password},c),"forgot"===a.action&&this.forgot({email:a.email},c),"logout"===a.action&&this.logout(c),"resend-confirm"===a.action&&this.resendConfirm({email:a.email},c),"change_password"===a.action&&this.change_password({password_old:a.password_old,password:a.password,password_confirmation:a.password_confirmation},c),"open-popup"===a.action&&this.ping(c),"favorite"===a.action&&this.favorites_sync({favorites:a.favorites},c),"get_info"===a.action&&this.get_user_info(c),"track_vpn_ext"===a.action){let b=a.track_vpn;b&&(this.storage.show_track_notification=!1),this.storage.track_vpn=b,this.saveStorage(),this.setBadge()}if("close_rate_us"===a.action&&(this.storage.dateCloseRateUs=Date.now(),this.saveStorage()),"rate_us"===a.action&&(this.storage.rated=!0,clearInterval(this.rateInterval),this.saveStorage()),"auth:google"===a.action&&this.googleAuth(a.register),"auth:fb"===a.action&&this.fbAuth3(a.register),"reauth"===a.action)switch(this.socialAuthSystem){case"google":this.googleAuth(!1,a.email);break;case"facebook":this.fbAuth3(!1,a.email);}return"auth:apple"===a.action&&this.appleAuth(),"getAuthError"===a.action&&c(this.storage.authError),!0}),chrome.runtime.onInstalled.addListener(a=>{"install"===a.reason?(this.vpnOnlyMode=1,this.user_version="UVPNv2",this.saveStorage(),this.setBadge(),chrome.tabs.create({url:chrome.extension.getURL("/pages/"+this.application_language+`/register.html?utm_source=chrome-store&utm_medium=${chrome.runtime.id}&utm_campaign=register`)},a=>{this.registerTabId=a.id})):"update"===a.reason&&(this.get_user_info(),this.setBadge(),this.storage.afterUpdateUrl&&chrome.tabs.create({pinned:!0,url:this.storage.afterUpdateUrl}))}),chrome.runtime.onInstalled.addListener(()=>{this.unsetProxy(!1)}),this.readEnv(),this.initStorage(),this.initSentry(),this.onStorageUpdate(),this.currentProxy="",this.failedProxyList=[],this.validatedProxyList=[],this.currentLocation={ip:"",country_code:"",country_name:"",city:""}}get params(){return this.storage.params}initSentry(){Sentry.init({dsn:"https://8686075a839941d682002ea9114be55a@sentry.uvpn.me/2",environment:"coahpcpgfnnaddeelpphpifmgfobflog"===chrome.runtime.id?chrome.runtime.id:"development"})}readEnv(){try{const a=chrome.extension.getURL("/config.json"),b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=()=>(200===b.status&&b.responseText&&(this.config=JSON.parse(b.responseText)),this.config),b.addEventListener("error",()=>{throw"Config is not loaded"}),b.send()}catch(a){Sentry.captureException(a)}}onStorageUpdate(){chrome.storage.onChanged.addListener(a=>{for(let b in a)("vpnOn"==b||"country"==b)&&(this.storage[b]=a[b].newValue,this.storage.vpnOn?this.pac():this.unsetProxy(),"country"==b&&ga("send","event","Location VPN",`version_${chrome.runtime.getManifest().version}`,this.storage[b]))})}initStorage(){chrome.storage.local.get(this.storage,a=>{this.storage=a,Sentry.configureScope(a=>{a.setUser({email:this.authOptions.email})}),this.setProxy(),a.user_version&&(this.user_version=a.user_version),a.dateCloseRateUs||(this.storage.dateCloseRateUs=Date.now()+864e5),this.storage.appLoads++,this.updateDeviceToken(),this.saveStorage()})}saveStorage(){this.vpnOnlyMode&&!this.storage.vpnOnlyMode&&(this.storage.vpnOnlyMode=this.vpnOnlyMode),"UVPNv1"!==this.user_version&&(this.storage.user_version=this.user_version),chrome.storage.local.set(this.storage)}pac(){null!==this.authOptions.token&&""!==this.authOptions.token&&$.ajax({url:this.config.api_host+"/user/pac",method:"post",dataType:"json",data:{country:this.storage.country,device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:a=>{for(let b in a)this.storage[b]=a[b];chrome.runtime.sendMessage({action:"updateConnectionInfo",storage:this.storage}),this.setProxy(),this.saveStorage()},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}ping(a=!1){const b=this.config.api_host+"/user/ping-lock";null!==this.authOptions.token&&""!==this.authOptions.token&&$.ajax({url:b,method:"post",dataType:"json",data:{id:chrome.runtime.id,v:this.storage.user_version,vpn:this.storage.vpnOnlyMode||this.vpnOnlyMode?1:0,device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:b=>{for(let a in b)this.storage[a]=b[a];!this.storage.country&&0<this.storage.locations.length&&(this.storage.country=this.storage.locations[0].region),this.saveStorage(),this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})}),this.get_user_info(),b.notification.has&&chrome.runtime.sendMessage({action:"notifications",message:b.notification.text,notification:b.notification,link:b.notification.link,action_title:b.notification.action_title}),chrome.runtime.sendMessage({action:"end-loader"}),!1!==a&&a({success:!0})},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c),chrome.runtime.sendMessage({action:"end-loader"})}})}setProxy(){let a;if(this.currentLocation={ip:"",country_code:"",country_name:"",city:"",original:{ip:"",country_code:"",country_name:"",city:""}},this.activeLocation&&this.activeLocation.nodes&&0<this.activeLocation.nodes.length){let b=this.activeLocation.nodes;this.currentProxy=`${b[0].schema} ${b[0].path}:${b[0].port}`,a=`function FindProxyForURL(url, host) {                             let blackList = ${JSON.stringify(this.storage.bypass)};                              for (let i = 0; i < blackList.length; i++){                                if (shExpMatch(host, blackList[i])) return "DIRECT;";                            }                                                        return "`+this.currentProxy+`; "; }`}else this.storage.vpnOn=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"disconnected"});this.setBadge(),chrome.proxy.settings.clear({scope:"regular"},()=>{if(!this.storage.vpnOn)return void this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})});let b=[],c={username:this.storage.device_token+"&"+this.authOptions.email,password:this.storage.proxy_token};chrome.webRequest.onAuthRequired.addListener(function(a){return-1===b.indexOf(a.requestId)?(b.push(a.requestId),{authCredentials:c}):{cancel:!0}},{urls:["http://*/*","https://*/*"]},["blocking"]),chrome.webRequest.onCompleted.addListener(function(a){let c=b.indexOf(a.requestId);-1<c&&b.splice(c,1)},{urls:["http://*/*","https://*/*"]}),chrome.webRequest.onErrorOccurred.addListener(function(a){let c=b.indexOf(a.requestId);-1<c&&b.splice(c,1)},{urls:["http://*/*","https://*/*"]});const d={mode:"pac_script",pacScript:{data:a}};chrome.proxy.settings.set({value:d,scope:"regular"},()=>{this.storage.dateConnectVpn=Date.now(),this.saveStorage(),this.setRateInterval(),this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})})})})}unsetProxy(a=!0){chrome.proxy.settings.clear({scope:"regular"},()=>{this.storage.dateConnectVpn=null,clearInterval(this.rateInterval),this.saveStorage(),a&&this.getOriginalRemoteIP(()=>{this.setBadge(),chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})})})}getOriginalRemoteIP(a,b){const c=this.config.geo_host+"/geo/ip",d=new XMLHttpRequest;d.open("POST",c,!0),d.timeout=1e4,d.onload=()=>{if(200===d.status&&d.responseText){let b=JSON.parse(d.responseText);if(b.ip)return this.currentLocation=b,"function"==typeof a&&a(b),this.currentLocation}},d.ontimeout=()=>{"function"==typeof b&&b(d)},d.send()}setRateInterval(){this.rateInterval&&clearInterval(this.rateInterval);this.storage.rated||(this.rateInterval=setInterval(()=>{!this.storage.rated&&this.storage.vpnOn&&864e5<=Date.now()-this.storage.dateCloseRateUs&&chrome.tabs.query({active:!0,currentWindow:!0},a=>{this.storage.dateCloseRateUs=Date.now(),this.saveStorage(),chrome.tabs.sendMessage(a[0].id,{action:"show_rateus_uvpn"})})},3e5))}setBadge(){let a="",b=[0,0,0,0];if(this.storage.vpnOn&&this.storage.country&&this.activeLocation){let c=this.storage.country.split("-",1)[0];a=this.activeLocation.streaming?"ST":c,b=[16,201,33,100]}else;chrome.browserAction.setBadgeBackgroundColor({color:b}),chrome.browserAction.setBadgeText({text:a})}get activeLocation(){return this.storage.currentProxyServer}get authOptions(){return{email:"UVPNv2"===this.storage.user_version?this.storage.user_auth_email:this.config.user_auth_email,token:"UVPNv2"===this.storage.user_version?this.storage.user_auth_token:this.config.user_auth_token}}get application_language(){return"ru"===chrome.i18n.getUILanguage()?"ru":"en"}static get osDevice(){let a="Unknown OS";return-1!==navigator.appVersion.indexOf("Win")&&(a="Windows"),-1!==navigator.appVersion.indexOf("Mac")&&(a="MacOS"),-1!==navigator.appVersion.indexOf("X11")&&(a="UNIX"),-1!==navigator.appVersion.indexOf("Linux")&&(a="Linux"),a}setProxyToken(a){null!==a&&$.ajax({url:this.config.api_host+"/user/get-token",method:"post",dataType:"json",headers:{Authorization:a},success:a=>{this.storage.proxy_token=a.data.token},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}updateDeviceToken(){if(null!==this.authOptions.token){let a=/UVPNv1-/.test(this.storage.device_token),b=/UVPNv2-/.test(this.storage.device_token),c=null===this.storage.device_token||""===this.storage.device_token;a||b||c||$.ajax({url:this.config.api_host+"/user/update-device-token",method:"post",dataType:"json",data:{device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:a=>{this.storage.device_token=a.data.device_token},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}}login(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/login",method:"post",dataType:"json",data:{email:a.email,password:a.password,mode:this.storage.mode,version:chrome.runtime.getManifest().version,platform:this.constructor.osDevice,browser_lang:chrome.i18n.getUILanguage(),browser:"chrome",type:"browser-extension",user_version:this.storage.user_version,device_token:this.storage.device_token},headers:{Accept:"application/json"},success:c=>{this.storage.user_auth_email=a.email,this.storage.user_auth_token=c.data.auth_token,this.storage.device_token=c.data.device_token,this.storage.proxy_token=c.data.proxy_token,"popup"===a.resource&&(this.get_user_info(),this.ping(b)),chrome.runtime.sendMessage({action:"end-loader"})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d),this.storage.user_auth_email=null,this.storage.user_auth_token=null;let e="",f=null;a.responseJSON&&a.responseJSON.msg&&(e=a.responseJSON.msg),a.responseJSON&&a.responseJSON.link&&(f=a.responseJSON.link),b({success:!1,msg:e,response:a,link:f})}})}register(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/register",method:"post",data:a,dataType:"json",headers:{Accept:"application/json"},success:a=>{chrome.runtime.sendMessage({action:"end-loader"}),chrome.tabs.update({url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),chrome.tabs.create({url:this.config.web_host+"/login?token="+a.data.url_token}),b({success:!0})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d);let e="";a.responseJSON&&a.responseJSON.msg&&(e=a.responseJSON.msg),b({success:!1,msg:e,response:a})}})}forgot(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/forgot",method:"post",data:a,dataType:"json",headers:{Accept:"application/json"},success:()=>{chrome.runtime.sendMessage({action:"end-loader"}),b({success:!0})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d);let e="";a.responseJSON&&a.responseJSON.msg&&(e=a.responseJSON.msg),b({success:!1,msg:e,response:a})}})}change_password(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/change-password",method:"post",data:a,dataType:"json",headers:{Accept:"application/json",Authorization:this.authOptions.token},success:()=>{chrome.runtime.sendMessage({action:"end-loader"}),b({success:!0})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d);let e="";a.responseJSON&&a.responseJSON.msg&&(e=a.responseJSON.msg),b({success:!1,msg:e,response:a})}})}favorites_sync(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/user/favorites/sync",method:"post",data:{favorites:a.favorites},dataType:"json",headers:{Accept:"application/json",Authorization:this.authOptions.token},success:()=>{this.ping(b)},error:(a,b,c)=>{422!==a.status&&401!==a.status&&Sentry.captureException(c),chrome.runtime.sendMessage({action:"end-loader"})}})}logout(a){this.storage.user_auth_email=null,this.storage.user_auth_token=null,this.storage.vpnOnlyMode=1,this.storage.vpnOn=!1,this.saveStorage(),this.setProxy(),a({success:!0})}resendConfirm(a,b){$.ajax({url:this.config.api_host+"/resend-confirm",method:"post",dataType:"json",data:a,headers:{Accept:"application/json"},success:()=>{b({success:!0})},error:(a,c,d)=>{422!==a.status&&401!==a.status&&Sentry.captureException(d);let e="";a.responseJSON&&a.responseJSON.msg&&(e=a.responseJSON.msg),b({success:!1,msg:e,response:a})}})}googleAuth(a=!1,b=null){this.socialAuthSystem="google";let c,d=chrome.runtime.getManifest(),e=encodeURIComponent(d.oauth2.client_id),f=encodeURIComponent(d.oauth2.scopes.join(" ")),g=encodeURIComponent("urn:ietf:wg:oauth:2.0:oob:auto"),h=["Success","Denied","Error"];chrome.tabs.create({url:"about:blank"},d=>{let i=d=>{c=d.split("&");let e={};for(let a=0;a<c.length;a++)c[a]=c[a].split("="),e[c[a][0]]=c[a][1];let f={provider:"google",access_token:e.id_token,version:chrome.runtime.getManifest().version,platform:this.constructor.osDevice,browser_lang:chrome.i18n.getUILanguage(),browser:"chrome",type:"browser-extension",user_version:this.storage.user_version};b&&(f.email=b),this.storage.device_token&&(f.device_token=this.storage.device_token),$.ajax({url:this.config.api_host+"/social/store",method:"post",dataType:"json",data:f,headers:{Accept:"application/json"},success:b=>{this.storage.user_auth_token=b.data.auth_token,this.storage.user_auth_email=b.data.email,this.storage.device_token=b.data.device_token,this.storage.proxy_token=b.data.proxy_token,this.saveStorage(),this.get_user_info(),this.registerTabId?(a&&(chrome.tabs.update(this.registerTabId,{url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),this.registerTabId=null),chrome.tabs.create({url:this.config.web_host+"/login?token="+b.data.url_token})):(a&&chrome.tabs.create({url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),chrome.tabs.create({url:this.config.web_host+"/login?token="+b.data.url_token})),chrome.runtime.sendMessage({action:"end-loader"})},error:(a,b,c)=>{this.catchAuthError(a,b,c)}})},j=(a,b,c)=>{if(a===d.id){let b=c.title.split(" ",2),d=b[0];if(2==b.length&&0<=h.indexOf(d)){chrome.tabs.onUpdated.removeListener(j),chrome.tabs.remove(a);let c=b[1];switch(d){case"Success":i(c);break;case"Denied":break;case"Error":i(c);}}}};chrome.tabs.onUpdated.addListener(j),chrome.tabs.update(d.id,{url:"https://accounts.google.com/o/oauth2/auth?client_id="+e+"&response_type=id_token&access_type=offline&redirect_uri="+g+"&scope="+f})})}fbAuth3(a=!1,b=null){this.socialAuthSystem="facebook";let c,d=(e,f)=>{if(e===c.id&&f.url&&0===f.url.indexOf("https://www.facebook.com/connect/login_success.html")){let c=f.url.split("#");if(1<c.length){let e=c[1].split("&");for(let c,f=0;f<e.length;f++)if(c=e[f].split("="),1<c.length&&"access_token"==c[0]){chrome.tabs.onUpdated.removeListener(d);let e=c[1],f={provider:"facebook",access_token:e,version:chrome.runtime.getManifest().version,platform:this.constructor.osDevice,browser_lang:chrome.i18n.getUILanguage(),browser:"chrome",type:"browser-extension",user_version:this.storage.user_version};b&&(f.email=b),this.storage.device_token&&(f.device_token=this.storage.device_token),$.ajax({url:this.config.api_host+"/social/store",method:"post",dataType:"json",data:f,headers:{Accept:"application/json"},success:b=>{this.storage.user_auth_token=b.data.auth_token,this.storage.user_auth_email=b.data.email,this.storage.device_token=b.data.device_token,this.storage.proxy_token=b.data.proxy_token,this.saveStorage(),this.get_user_info(),this.registerTabId?(a&&(chrome.tabs.update(this.registerTabId,{url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),this.registerTabId=null),chrome.tabs.create({url:this.config.web_host+"/login?token="+b.data.url_token})):(a&&chrome.tabs.create({url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),chrome.tabs.create({url:this.config.web_host+"/login?token="+b.data.url_token})),chrome.runtime.sendMessage({action:"end-loader"}),chrome.runtime.sendMessage({action:"onAuth"})},error:(a,b,c)=>{this.catchAuthError(a,b,c)}})}}chrome.tabs.remove(e)}};chrome.tabs.onUpdated.addListener(d);let e=["client_id="+"1040871542925272","redirect_uri=https://www.facebook.com/connect/login_success.html","response_type=token","display=popup"].join("&");chrome.windows.create({url:"https://www.facebook.com/dialog/oauth?"+e,type:"popup"},a=>{c=a.tabs[0]})}catchAuthError(a){this.storage.authError=a,chrome.tabs.create({url:chrome.runtime.getURL("pages/en/authpopup.html")},()=>{})}get_user_info(a=!1){"UVPNv2"===this.storage.user_version&&this.authOptions.token!==void 0&&$.ajax({url:this.config.api_host+"/user/info",method:"post",dataType:"json",headers:{Accept:"application/json",Authorization:this.authOptions.token},success:b=>{this.storage.user=b.data,this.saveStorage(),!1!==a&&a({success:!0,data:b.data})},error:(b,c,d)=>{422!==b.status&&401!==b.status&&Sentry.captureException(d),!1!==a&&a({success:!1})}})}}const App=new ProxyApp;