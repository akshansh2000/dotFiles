class Popup{constructor(){this.storage=STORAGE,this.config={},this.notification_block=$("#free-user-notification"),this.error_block=$(".error-modal"),this.success_modal=$(".success-modal"),this.current_location_block=$(".current_location"),this.destination_location_block=$(".destination_location"),this.readEnv(),this.initHandlers(),this.initStorage(),this.initListeners()}get application_language(){return"ru"===chrome.i18n.getUILanguage()?"ru":"en"}disable_proxy_extensions(){chrome.permissions.contains({permissions:["management"]},function(a){a&&chrome.management.getAll(function(a){a.forEach(function(a){a.enabled&&a.id!==chrome.runtime.id&&a.permissions.includes("proxy")&&chrome.management.setEnabled(a.id,!1,function(){})})})})}initListeners(){chrome.runtime.onMessage.addListener(a=>{"gotIP"===a.action?(this.setIp(a.data),this.setDestinationIp(),this.setState("connected")):"gotIPError"===a.action?this.setState():"disconnected"===a.action?this.setState():"start-loader"===a.action?($("#loader").show(),$("#wrapper").addClass("loading")):"end-loader"===a.action?($("#loader").hide(),$("#wrapper").removeClass("loading")):"notifications"===a.action?this.showNotification(a.notification):"updateConnectionInfo"===a.action?(this.storage.currentProxyServer=a.storage.currentProxyServer,this.setDestinationIp()):"onAuth"===a.action&&window.location.reload()})}readEnv(){try{const a=chrome.extension.getURL("/config.json"),b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=()=>(200===b.status&&b.responseText&&(this.config=JSON.parse(b.responseText)),this.config),b.addEventListener("error",()=>{throw"Config is not loaded"}),b.send()}catch(a){Sentry.captureException(a)}}showLogin(){$(".screen").hide(),$(".auth_screen").show()}hideLogin(){$(".main_screen").show(),$(".auth_screen").hide()}initHandlers(){let a=this;const b=$(document.body);b.on("submit","form#signin-submit",a=>{a.preventDefault();let b=$("#signin-email").val(),c=$("#signin-password").val();chrome.runtime.sendMessage({action:"signin",email:b,password:c,resource:"popup"},a=>{if(a)if(a.success)this.initStorage(),this.resolveSubscriptionStatus();else if(422==a.response.status){let b="";for(let c in a.response.responseJSON.data)b+=`<div>${a.response.responseJSON.data[c]}</div>`;$("#signin-submit .error-holder").html(b)}else if(a&&a.link.has){let b=a.link,c=a.msg;this.showAlert(c,`<button id="error-button" class="primary_btn" link="${b.uri}">${b.title}</button>`,a)}else{let b=a.msg;this.showAlert(b,null,a)}})}),b.on("submit","form#signup-submit",a=>{a.preventDefault();let b=$("#signup-name").val(),c=$("#signup-email").val(),d=$("#signup-password").val();chrome.runtime.sendMessage({action:"signup",email:c,password:d,name:b,resource:"popup"},a=>{if(a&&a.success)chrome.runtime.sendMessage({action:"signin",email:c,password:d,resource:"popup"},a=>{if(a)if(a.success)chrome.tabs.create({url:chrome.extension.getURL("/pages/"+this.application_language+`/thankyou.html?utm_source=chrome-thankyou&utm_medium=${chrome.runtime.id}&utm_campaign=upgrade`)}),this.initStorage();else if(a.link.has){let b=a.link,c=a.msg;this.showAlert(c,`<button id="error-button" class="primary_btn" link="${b.uri}">${b.title}</button>`,a)}else{let b=a.msg;this.showAlert(b,null,a)}});else if(422==a.response.status){let b="";for(let c in a.response.responseJSON.data)b+=`<div>${a.response.responseJSON.data[c]}</div>`;$("#signup-submit .error-holder").html(b)}else this.showAlert(a.msg,null,a)})}),b.on("submit","form#change-password-submit",a=>{a.preventDefault();let b=$("#change-password-old").val(),c=$("#change-password").val(),d=$("#change-password-confirmation").val();chrome.runtime.sendMessage({action:"change_password",password_old:b,password:c,password_confirmation:d},a=>{if(a)if(a.success)$("#change-password-old").val(""),$("#change-password").val(""),$("#change-password-confirmation").val(""),$(".sub_setting_password").removeClass("js-opened");else if(422==a.response.status){let b="";for(let c in a.response.responseJSON.data)b+=`<div>${a.response.responseJSON.data[c]}</div>`;$("#change-password-submit .error-holder").html(b)}else this.showAlert(a.msg,null,a)})}),b.on("submit","form#forgot-submit",a=>{a.preventDefault();let b=$("#forgot-email").val();chrome.runtime.sendMessage({action:"forgot",email:b},a=>{if(a.success)this.showLogin(),this.showAlert("We sent a link to reset your password, check your email!",null,a);else if(422==a.response.status){let b="";for(let c in a.response.responseJSON.data)b+=`<div>${a.response.responseJSON.data[c]}</div>`;$("#forgot-submit .error-holder").html(b)}else this.showAlert(a.msg,null,a)})}),b.on("click",".connection_btn",()=>{this.storage.vpnOn=!this.storage.vpnOn,this.setDestinationIp(),this.setState("connecting");let a=this;this.storage.vpnOn?setTimeout(function(){a.saveStorage()},1e3):this.saveStorage(),a.setIpResolving()}),b.on("click","button#resend-confirm",()=>{let a=$("#signin-email").val();chrome.runtime.sendMessage({action:"resend-confirm",email:a},a=>{a&&a.success?(this.showLogin(),this.showAlert("Confirmation link has been successfully send",null,a)):this.showAlert(a.msg,null,a)})}),b.on("click",".forgot_screen #close_btn",()=>{$(".screen").hide(),$(".auth_screen").show().addClass("js-opened")}),b.on("click","a#forgot-link",()=>{$(".screen").hide(),$(".forgot_screen").show().addClass("js-opened")}),b.on("click","button#change-password-link",()=>{$(".screen").hide(),$("#change-password-submit .error-holder").html(""),$(".change_password_screen").show().addClass("js-opened")}),b.on("click",".logout-btn",()=>{$(".logout-confirm-modal").addClass("js-opened")}),b.on("click",".success-modal .modal-close",a=>{a.target.classList.contains("modal-close")&&$(".success-modal").removeClass("js-opened")}),b.on("click",".error-modal .modal-close",a=>{a.preventDefault(),a.target.classList.contains("modal-close")&&(a.target.dataset.href?chrome.tabs.create({url:a.target.dataset.href}):$(".error-modal").removeClass("js-opened"))}),b.on("click",".logout-modal-close",a=>{a.target.classList.contains("logout-modal-close")&&$(".logout-confirm-modal").removeClass("js-opened")}),b.on("click",".logout-confirm-btn",()=>{chrome.runtime.sendMessage({action:"logout"},()=>{$(".logout-confirm-modal").removeClass("js-opened"),$(".screen").hide(),this.showLogin()})}),b.on("click",".back-login",()=>{this.showLogin()}),b.on("click",".geo_chooser_btn",()=>{$(".geo_screen").show().addClass("js-opened")}),b.on("click","#error-button",()=>{chrome.tabs.create({url:$("#error-button").attr("link")})}),b.on("click","#notification-link",()=>{chrome.tabs.create({url:$("#notification-link").attr("link")})}),b.on("click","#notification-action",()=>{this.notification_block.removeClass("shown"),this.notification_block.find("p").html(""),this.notification_block.find(".action").html(""),this.notification_block.css("position","absolute")}),b.on("click","#signin-tab",()=>{$("#signin-tab").addClass("active"),$("#signup-tab").removeClass("active"),$("#signin-tab-content").show(),$("#signup-tab-content").hide()}),b.on("click","#signup-tab",()=>{$("#signup-tab").addClass("active"),$("#signin-tab").removeClass("active"),$("#signin-tab-content").hide(),$("#signup-tab-content").show()}),b.on("click",".settings_screen .close_btn",()=>{$(".settings_screen").removeClass("js-opened")}),b.on("click",".menu_btn",()=>{$(".main_settings").addClass("js-opened")}),b.on("click",".subscription-settings-link",()=>{$(".sub_setting_subscription").addClass("js-opened")}),b.on("click",".password-settings-link",()=>{$("#change-password-submit .error-holder").html(""),$(".sub_setting_password").addClass("js-opened")}),b.on("click",".support-link",()=>{chrome.tabs.create({url:"https://uvpn.me/support/"})}),b.on("click",".faq-link",()=>{chrome.tabs.create({url:"https://uvpn.me/faq/"})}),b.on("click",".privacy-link",()=>{chrome.tabs.create({url:"https://uvpn.me/privacy-policy/"})}),b.on("click",".terms-link",()=>{chrome.tabs.create({url:"https://uvpn.me/terms-conditions/"})}),b.on("click",".rate-link",()=>{chrome.tabs.create({url:`https://chrome.google.com/webstore/detail/${chrome.runtime.id}/reviews`})}),b.on("click",".subscription-upgrade",()=>{chrome.tabs.create({url:this.config.web_host+"/order?utm_source=ChromeExt&utm_medium=settings&utm_campaign=trial&utm_content=upgrade"})}),b.on("click",".sub_setting_screen .back_btn",()=>{$(".sub_setting_screen").removeClass("js-opened")}),b.on("click",".notification .close_btn, .notification .closebtn",()=>{this.notification_block.removeClass("shown"),setTimeout(()=>{this.notification_block.find("p").html(""),this.notification_block.find(".action").html("")},200),this.notification_block.css("position","absolute")}),b.on("click",".js-search",()=>{$(".search_holder").addClass("is-active")}),b.on("click",".js-search-close",()=>{$(".search_holder").removeClass("is-active")}),b.on("click",".lock-proxy-server-link",a=>{let b=$(a.target).closest("li").attr("value");chrome.tabs.create({url:this.config.web_host+"/order?utm_source=ChromeExt&utm_medium=select_location&utm_campaign=server&utm_content="+b})}),b.on("click","#free-user-notification a",a=>{a.preventDefault(),this.notification_block.find("a").attr("href")&&chrome.tabs.create({url:this.notification_block.find("a").attr("href")})}),b.on("click",".add_to_fav_btn",b=>{let c=$(b.target),d=$.grep(this.storage.locations,function(a){return!0===a.favorite}),e=[];for(let a=0;a<d.length;a++)e.push(d[a].region);let f=c.closest("li").attr("value"),g=e.indexOf(f);-1===g?e.push(f):e.splice(g,1),chrome.runtime.sendMessage({action:"favorite",favorites:e},b=>{b&&b.success&&a.initStorage()})}),b.on("click","#rate_btn_rateus",()=>{chrome.runtime.sendMessage({action:"rate_us"}),$("#rate_us").removeClass("open")}),b.on("click","#close_btn_rateus",()=>{chrome.runtime.sendMessage({action:"close_rate_us"}),$("#rate_us").removeClass("open")}),b.on("click","#subscription_screen_back_btn",()=>{$(".subscription_screen").removeClass("js-opened")}),b.on("click",".account_btn",()=>{$(".account_screen").addClass("js-opened")}),b.on("input",".change-password-form input",()=>{document.body.querySelector(".change-password-form").checkValidity()?$(".change-password-form .primary_btn").addClass("active"):$(".change-password-form .primary_btn").removeClass("active")}),b.on("click","#track-vpn-checkbox",()=>{chrome.permissions.contains({permissions:["management"]},function(b){if(!b)chrome.permissions.request({permissions:["management"]},function(b){if(b){$(".check_proxy_extensions").find(".switcher").toggleClass("active");let b=$(".check_proxy_extensions .switcher").hasClass("active");b&&a.disable_proxy_extensions(),$(".menu_btn").removeClass("badge-warning"),chrome.runtime.sendMessage({action:"track_vpn_ext",track_vpn:b})}});else{$(".check_proxy_extensions").find(".switcher").toggleClass("active");let b=$(".check_proxy_extensions .switcher").hasClass("active");b&&a.disable_proxy_extensions(),$(".menu_btn").removeClass("badge-warning"),chrome.runtime.sendMessage({action:"track_vpn_ext",track_vpn:b})}})}),this.mapMoveListener(),b.on("click","#auth_google",()=>{chrome.runtime.sendMessage({action:"auth:google"})}),b.on("click","#auth_fb",()=>{chrome.runtime.sendMessage({action:"auth:fb"})}),window.onload=function(){a.resolveSubscriptionStatus(),a.setUserInfo(),chrome.runtime.sendMessage({action:"open-popup"},b=>{b&&b.success&&a.initStorage()})}}mapMoveListener(){function a(){h<d.endX&&(h=d.endX,c.style.transition="all .2s",c.style.backgroundPositionX=h+"px",setTimeout(()=>{c.style.transition=null},300)),h>d.startX&&(h=d.startX,c.style.transition="all .2s",c.style.backgroundPositionX=h+"px",setTimeout(()=>{c.style.transition=null},300)),i<d.endY&&(i=d.endY,c.style.transition="all .2s",c.style.backgroundPositionY=i+"px",setTimeout(()=>{c.style.transition=null},300)),i>d.startY&&(i=d.startY,c.style.transition="all .2s",c.style.backgroundPositionY=i+"px",setTimeout(()=>{c.style.transition=null},300))}let b=document.querySelector("#wrapper"),c=document.querySelector(".map"),d={startX:158,endX:-648,startY:-11,endY:-141},f=40,g=!1,h=-256,i=-76,j=0,k=0;c.addEventListener("mousedown",a=>{j=a.pageX-h,k=a.pageY-i,b.classList.add("no-selection"),g=!0}),b.addEventListener("mouseleave",()=>{a(),b.classList.add("no-selection"),g=!1}),b.addEventListener("mouseup",()=>{a(),b.classList.add("no-selection"),g=!1}),b.addEventListener("mousemove",a=>{if(!g)return;const b=a.pageX-h,e=a.pageY-i,l=b-j,m=e-k;h+=l,i+=m,h>d.startX+f&&(h=d.startX+f),h<d.endX-f&&(h=d.endX-f),i>d.startY+f&&(i=d.startY+f),i<d.endY-f&&(i=d.endY-f),c.style.backgroundPositionX=h+"px",c.style.backgroundPositionY=i+"px"})}showAlert(a,b=null,c){return c&&c.response&&500==c.response.status?(this.error_block.addClass("js-opened"),this.error_block.find(".subtitle").html(a),void(c.link.has?(this.error_block.find(".link").html(c.link.title),this.error_block.find(".link").attr("data-href",c.link.uri)):(this.error_block.find(".action").html("Ok"),this.error_block.find(".link").attr("data-href","")))):c&&c.success?(this.success_modal.addClass("js-opened"),void this.success_modal.find(".subtitle").html(a)):void(this.notification_block.find(".title").text(a),this.notification_block.removeClass("n-red"),this.notification_block.css("position","relative"),this.notification_block.css("display","flex"),this.notification_block.find(".icon").attr("src","./img/handshake.svg"),null===b?this.notification_block.find(".action").html(""):this.notification_block.find(".action").html(b))}showNotification(a){if(a&&a.has){switch(this.notification_block.find(".title").text(a.text),this.notification_block.removeClass("n-red"),this.notification_block.addClass("js-opened"),this.notification_block.find(".icon").attr("src","./img/handshake.svg"),a.type){case"verify-account":this.notification_block.addClass("n-red"),this.notification_block.find(".icon").attr("src","./img/verify_email.svg");break;case"subscription-ended":this.notification_block.addClass("n-red"),this.notification_block.find(".icon").attr("src","./img/expired-icon.svg");break;case"trial-expiration":case"trial-ended":break;default:}a.link?(this.notification_block.find(".wrap").attr("href",a.link),this.notification_block.find(".arrow").css("display","block")):(this.notification_block.find(".wrap").attr("href",""),this.notification_block.find(".arrow").css("display","none"))}}initStorage(){chrome.storage.local.get(this.storage,a=>{this.storage=a,this.resolveSubscriptionStatus(),this.setUserInfo(),this.run()})}initSentry(){Sentry.init({dsn:"https://8686075a839941d682002ea9114be55a@sentry.uvpn.me/2",environment:"coahpcpgfnnaddeelpphpifmgfobflog"===chrome.runtime.id?chrome.runtime.id:"development"})}saveStorage(){chrome.storage.local.set(this.storage)}run(){this.initSentry(),this.setDestinationIp();let a="UVPNv2"===this.storage.user_version,b=null===this.storage.user_auth_token||null===this.storage.user_auth_email;b||Sentry.configureScope(a=>{a.setUser({email:this.storage.user_auth_email})}),a&&b?this.showLogin():(this.hideLogin(),this.initPopup())}initPopup(){this.setIpResolving(),/UVPNv2/.test(this.storage.device_token)&&$(".logout-btn").show().removeClass("disabled-block"),this.storage.show_track_notification&&$(".menu_btn").addClass("badge-warning"),$("#vpn-on").prop("checked",this.storage.vpnOn),!0===this.storage.track_vpn?($(".check_proxy_extensions").find(".switcher").addClass("active"),this.disable_proxy_extensions()):$(".check_proxy_extensions").find(".switcher").removeClass("active");const a=this.storage.locations.map(a=>({country_name:a.country_name,value:a.country_code,region:a.region,original_region:a.original_region,mode:a.mode,lock:a.lock,ip:a.ip,favorite:a.favorite?" fav_loc":null}));new XSelect(".main_screen",a,this.storage,a=>{$(".geo_screen").hide().removeClass("js-opened"),$(".main_screen").show(),this.storage.country!==a.region&&(this.storage.country=a.region,this.storage.vpnOn=!0,this.setDestinationIp(),a.nodes=[],a.country_code=a.region,a.nodes[0]={country_code:a.region,region:a.region,country_name:a.country_name,ip:a.ip,streaming:a.streaming,original_region:a.original_region,mode:a.mode,lock:a.lock,icon:a.icon},this.storage.currentProxyServer=a,this.saveStorage(),this.setState("connecting"),this.setIpResolving())}),this.setState()}setState(a){const b=document.body.classList;this.storage.vpnOn?"connecting"===a?(b.remove("connected"),b.remove("disconnected"),b.add("connecting")):"connected"===a?(b.remove("connecting"),b.remove("disconnected"),b.add("connected")):!a&&(b.remove("connecting"),b.remove("disconnected"),b.add("connected")):(b.remove("connected"),b.remove("connecting"),b.add("disconnected"))}setIp(a){this.current_location_block.find(".connection_info").html(a.country_name+", "+a.city+" ["+a.ip+"]"),this.current_location_block.find("img").attr("src","/img/flags/"+a.country_code+".svg"),$(".location-loader").hide(),$(".current_location").show()}setDestinationIp(){let a=this.storage.currentProxyServer;a.country_name?this.storage.currentProxyServer&&(a.streaming||null===a.original_region?this.destination_location_block.find(".connection_info").html(a.country_name+" ["+a.nodes[0].ip+"]"):this.destination_location_block.find(".connection_info").html(a.country_name+", "+a.original_region+" ["+a.nodes[0].ip+"]"),this.destination_location_block.find("img").attr("src","/img/flags/"+a.country_code+".svg")):(a=this.storage.locations.filter(a=>a.region===this.storage.country),a[0]&&!1===a[0].lock&&(a[0].streaming||null===a[0].original_region?this.destination_location_block.find(".connection_info").html(a[0].country_name+" ["+a[0].ip+"]"):this.destination_location_block.find(".connection_info").html(a[0].country_name+", "+a[0].original_region+" ["+a[0].ip+"]"),this.destination_location_block.find("img").attr("src","/img/flags/"+a[0].country_code+".svg")))}setIpResolving(){$(".location-loader").show(),$(".current_location").hide()}resolveSubscriptionStatus(){}setUserInfo(){let a=this.storage.user;$("#setting-email").html(a.email),$("#setting-email").attr("title",a.email);let b=$("#subscription-info"),c=$("#subscription-badge-name"),d=$("#subscription-badge-type"),e=moment(a.subscription.next_bill_date).format("MMM DD, Y"),f=moment(a.subscription.trial_end_date).format("MMM DD, Y"),g=moment(a.subscription.cancellation_effective_date).format("MMM DD, Y");switch(a.subscription_status){case"paid":b.html(`Your subscription will be automatically renewed on <b>${e}</b>`),c.html(a.subscription.plan_name),d.addClass("premium");break;case"trial":b.html(`Your premium trial is active till the <b>${f}</b>`),c.html(a.subscription.plan_name),d.addClass("trial");break;case"overdue":b.html(`Your subscription is overdue`),c.html(a.subscription.plan_name),d.addClass("overdue");break;case"trial-overdue":b.html(`Your trial has been expired. Please select a plan to enjoy all premium features or use uVPN for free`),c.html(a.subscription.plan_name),d.addClass("trial");break;case"free":b.html(`You are on the Free plan. Upgrade to premium to use all features of the uVPN`),c.html(a.subscription.plan_name),d.addClass("trial");break;case"defer-canceled":b.html(`Your subscription ends on ${g}`),c.html(a.subscription.plan_name),d.addClass("canceled");}}}const p=new Popup;